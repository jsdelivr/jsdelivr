/*!
* js-data-firebase
* @version 3.0.0-beta.2 - Homepage <https://github.com/js-data/js-data-firebase>
* @author Jason Dobry <jason.dobry@gmail.com>
* @copyright (c) 2014-2016 Jason Dobry
* @license MIT <https://github.com/js-data/js-data-firebase/blob/master/LICENSE>
*
* @overview firebase adapter for js-data.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("js-data"),require("firebase")):"function"==typeof define&&define.amd?define("js-data-firebase",["exports","js-data","firebase"],t):t(e.JSDataFirebase=e.JSDataFirebase||{},e.JSData,e.firebase)}(this,function(e,t,n){"use strict";function r(e){var n=this;e||(e={}),t.utils.fillIn(e,y),t.utils.fillIn(n,e)}function i(e,n,r){var i=this;n||(n={}),i.data=e,t.utils.fillIn(i,n),i.op=r}function o(e){v.push(e)}function u(){v.length&&!g&&(g=!0,v[0]())}function a(e){v.length?o(e):(o(e),u())}function s(e){return new t.utils.Promise(e).then(function(e){return g=!1,v.shift(),setTimeout(u,0),e},function(e){return g=!1,v.shift(),setTimeout(u,0),t.utils.reject(e)})}function l(e){t.utils.classCallCheck(this,l),e||(e={}),r.call(this,e),e.db&&(this.db=e.db||n.database())}n="default"in n?n.default:n;var f={};f.typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},f.defineProperty=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},f.slicedToArray=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var u,a=e[Symbol.iterator]();!(r=(u=a.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();var c=function(){for(var e=this,n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];var o=r[r.length-1];return e.dbg.apply(e,[o.op].concat(r)),t.utils.resolve()},d=function(){for(var e=this,n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];var o=r[r.length-2];return e.dbg.apply(e,[o.op].concat(r)),t.utils.resolve()},h=function(e){var t={},n=[];return e.forEach(function(e){e in t||(n.push(e),t[e]=0)}),n},p=function(e,n){return t.utils.omit(n,e.relationFields||[])},y={debug:!1,raw:!1};r.extend=t.utils.extend,t.utils.addHiddenPropsToTarget(r.prototype,{afterCount:d,afterCreate:d,afterCreateMany:d,afterDestroy:d,afterDestroyAll:d,afterFind:d,afterFindAll:d,afterSum:d,afterUpdate:d,afterUpdateAll:d,afterUpdateMany:d,beforeCount:c,beforeCreate:c,beforeCreateMany:c,beforeDestroy:c,beforeDestroyAll:c,beforeFind:c,beforeFindAll:c,beforeSum:c,beforeUpdate:c,beforeUpdateAll:c,beforeUpdateMany:c,dbg:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];this.log.apply(this,["debug"].concat(t))},count:function(e,n,r){var o=this,u=void 0;return n||(n={}),r||(r={}),u=r.op="beforeCount",t.utils.resolve(o[u](e,n,r)).then(function(){return u=r.op="count",o.dbg(u,e,n,r),t.utils.resolve(o._count(e,n,r))}).then(function(a){var s=f.slicedToArray(a,2),l=s[0],c=s[1];c||(c={});var d=new i(l,c,u);return d=o.respond(d,r),u=r.op="afterCount",t.utils.resolve(o[u](e,n,r,d)).then(function(e){return t.utils.isUndefined(e)?d:e})})},create:function(e,n,r){var o=this,u=void 0;return n||(n={}),r||(r={}),u=r.op="beforeCreate",t.utils.resolve(o[u](e,n,r)).then(function(i){return n=t.utils.isUndefined(i)?n:i,n=p(e,n),u=r.op="create",o.dbg(u,e,n,r),t.utils.resolve(o._create(e,n,r))}).then(function(a){var s=f.slicedToArray(a,2),l=s[0],c=s[1];c||(c={});var d=new i(l,c,"create");return d.created=l?1:0,d=o.respond(d,r),u=r.op="afterCreate",t.utils.resolve(o[u](e,n,r,d)).then(function(e){return t.utils.isUndefined(e)?d:e})})},createMany:function(e,n,r){var o=this,u=void 0;return n||(n={}),r||(r={}),u=r.op="beforeCreateMany",t.utils.resolve(o[u](e,n,r)).then(function(i){return n=t.utils.isUndefined(i)?n:i,n=n.map(function(t){return p(e,t)}),u=r.op="createMany",o.dbg(u,e,n,r),t.utils.resolve(o._createMany(e,n,r))}).then(function(a){var s=f.slicedToArray(a,2),l=s[0],c=s[1];l||(l=[]),c||(c={});var d=new i(l,c,"createMany");return d.created=l.length,d=o.respond(d,r),u=r.op="afterCreateMany",t.utils.resolve(o[u](e,n,r,d)).then(function(e){return t.utils.isUndefined(e)?d:e})})},destroy:function(e,n,r){var o=this,u=void 0;return r||(r={}),u=r.op="beforeDestroy",t.utils.resolve(o[u](e,n,r)).then(function(){return u=r.op="destroy",o.dbg(u,e,n,r),t.utils.resolve(o._destroy(e,n,r))}).then(function(a){var s=f.slicedToArray(a,2),l=s[0],c=s[1];c||(c={});var d=new i(l,c,"destroy");return d=o.respond(d,r),u=r.op="afterDestroy",t.utils.resolve(o[u](e,n,r,d)).then(function(e){return t.utils.isUndefined(e)?d:e})})},destroyAll:function(e,n,r){var o=this,u=void 0;return n||(n={}),r||(r={}),u=r.op="beforeDestroyAll",t.utils.resolve(o[u](e,n,r)).then(function(){return u=r.op="destroyAll",o.dbg(u,e,n,r),t.utils.resolve(o._destroyAll(e,n,r))}).then(function(a){var s=f.slicedToArray(a,2),l=s[0],c=s[1];c||(c={});var d=new i(l,c,"destroyAll");return d=o.respond(d,r),u=r.op="afterDestroyAll",t.utils.resolve(o[u](e,n,r,d)).then(function(e){return t.utils.isUndefined(e)?d:e})})},loadBelongsTo:function(e,n,r,i){var o=this,u=n.getRelation();if(!t.utils.isObject(r)||t.utils.isArray(r)){var a=r.map(function(t){return o.makeBelongsToForeignKey(e,n,t)}).filter(function(e){return e});return o.findAll(u,{where:f.defineProperty({},u.idAttribute,{in:a})},i).then(function(e){r.forEach(function(t){e.forEach(function(e){e[u.idAttribute]===t[n.foreignKey]&&n.setLocalField(t,e)})})})}var s=function(){var t=r;return{v:o.find(u,o.makeBelongsToForeignKey(e,n,t),i).then(function(e){n.setLocalField(t,e)})}}();return"object"===("undefined"==typeof s?"undefined":f.typeof(s))?s.v:void 0},find:function(e,n,r){var o=this,u=void 0,a=void 0;return r||(r={}),r.with||(r.with=[]),a=r.op="beforeFind",t.utils.resolve(o[a](e,n,r)).then(function(){return a=r.op="find",o.dbg(a,e,n,r),t.utils.resolve(o._find(e,n,r))}).then(function(n){var i=f.slicedToArray(n,1),a=i[0];if(a){u=a;var s=[];return t.utils.forEachRelation(e,r,function(t,n){var r=void 0;!t.foreignKey||"hasOne"!==t.type&&"hasMany"!==t.type?"hasMany"===t.type&&t.localKeys?r=o.loadHasManyLocalKeys(e,t,u,n):"hasMany"===t.type&&t.foreignKeys?r=o.loadHasManyForeignKeys(e,t,u,n):"belongsTo"===t.type&&(r=o.loadBelongsTo(e,t,u,n)):r="hasOne"===t.type?o.loadHasOne(e,t,u,n):o.loadHasMany(e,t,u,n),r&&s.push(r)}),Promise.all(s)}}).then(function(){var s=new i(u,{},"find");return s.found=u?1:0,s=o.respond(s,r),a=r.op="afterFind",t.utils.resolve(o[a](e,n,r,s)).then(function(e){return t.utils.isUndefined(e)?s:e})})},findAll:function(e,n,r){var o=this;r||(r={}),r.with||(r.with=[]);var u=[],a=void 0,s=r._activeWith;if(t.utils.isObject(s)){var l=s.query||{};s.replace?n=l:t.utils.deepFillIn(n,l)}return a=r.op="beforeFindAll",t.utils.resolve(o[a](e,n,r)).then(function(){return a=r.op="findAll",o.dbg(a,e,n,r),t.utils.resolve(o._findAll(e,n,r))}).then(function(n){var i=f.slicedToArray(n,1),a=i[0];a||(a=[]),u=a;var s=[];return t.utils.forEachRelation(e,r,function(t,n){var r=void 0;!t.foreignKey||"hasOne"!==t.type&&"hasMany"!==t.type?"hasMany"===t.type&&t.localKeys?r=o.loadHasManyLocalKeys(e,t,u,n):"hasMany"===t.type&&t.foreignKeys?r=o.loadHasManyForeignKeys(e,t,u,n):"belongsTo"===t.type&&(r=o.loadBelongsTo(e,t,u,n)):r="hasMany"===t.type?o.loadHasMany(e,t,u,n):o.loadHasOne(e,t,u,n),r&&s.push(r)}),Promise.all(s)}).then(function(){var s=new i(u,{},"findAll");return s.found=u.length,s=o.respond(s,r),a=r.op="afterFindAll",t.utils.resolve(o[a](e,n,r,s)).then(function(e){return t.utils.isUndefined(e)?s:e})})},getOpt:function(e,n){return n||(n={}),t.utils.isUndefined(n[e])?t.utils.plainCopy(this[e]):t.utils.plainCopy(n[e])},loadHasMany:function(e,n,r,i){var o=this,u=!1;t.utils.isObject(r)&&!t.utils.isArray(r)&&(u=!0,r=[r]);var a=r.map(function(t){return o.makeHasManyForeignKey(e,n,t)}),s={where:{}},l=s.where[n.foreignKey]={};return u?l["=="]=a[0]:l.in=a.filter(function(e){return e}),o.findAll(n.getRelation(),s,i).then(function(i){r.forEach(function(r){var o=[];u?o=i:i.forEach(function(i){t.utils.get(i,n.foreignKey)===r[e.idAttribute]&&o.push(i)}),n.setLocalField(r,o)})})},loadHasManyLocalKeys:function(e,n,r,i){var o=this,u=void 0,a=n.getRelation();if(t.utils.isObject(r)&&!t.utils.isArray(r)&&(u=r),u)return o.findAll(a,{where:f.defineProperty({},a.idAttribute,{in:o.makeHasManyLocalKeys(e,n,u)})},i).then(function(e){n.setLocalField(u,e)});var s=function(){var u=[];return r.forEach(function(t){u=u.concat(o.self.makeHasManyLocalKeys(e,n,t))}),{v:o.findAll(a,{where:f.defineProperty({},a.idAttribute,{in:h(u).filter(function(e){return e})})},i).then(function(e){return r.forEach(function(r){var i=[],o=t.utils.get(r,n.localKeys)||[];o=t.utils.isArray(o)?o:Object.keys(o),e.forEach(function(e){o&&-1!==o.indexOf(e[a.idAttribute])&&i.push(e)}),n.setLocalField(r,i)}),e})}}();return"object"===("undefined"==typeof s?"undefined":f.typeof(s))?s.v:void 0},loadHasManyForeignKeys:function(e,n,r,i){var o=this,u=n.getRelation(),a=e.idAttribute,s=void 0;return t.utils.isObject(r)&&!t.utils.isArray(r)&&(s=r),s?o.findAll(n.getRelation(),{where:f.defineProperty({},n.foreignKeys,{contains:o.makeHasManyForeignKeys(e,n,s)})},i).then(function(e){n.setLocalField(s,e)}):o.findAll(u,{where:f.defineProperty({},n.foreignKeys,{isectNotEmpty:r.map(function(t){return o.makeHasManyForeignKeys(e,n,t)})})},i).then(function(e){var i=n.foreignKeys;r.forEach(function(r){var o=[],u=t.utils.get(r,a);e.forEach(function(n){var r=t.utils.get(e,i)||[];-1!==r.indexOf(u)&&o.push(n)}),n.setLocalField(r,o)})})},loadHasOne:function(e,n,r,i){return t.utils.isObject(r)&&!t.utils.isArray(r)&&(r=[r]),this.loadHasMany(e,n,r,i).then(function(){r.forEach(function(e){var r=n.getLocalField(e);t.utils.isArray(r)&&r.length&&n.setLocalField(e,r[0])})})},log:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];if(e&&!n.length&&(n.push(e),e="debug"),"debug"!==e||this.debug){var i=e.toUpperCase()+": (Adapter)";if(console[e]){var o;(o=console)[e].apply(o,[i].concat(n))}else{var u;(u=console).log.apply(u,[i].concat(n))}}},makeHasManyForeignKey:function(e,t,n){return t.getForeignKey(n)},makeHasManyLocalKeys:function(e,n,r){var i=[],o=t.utils.get(r,n.localKeys)||[];return o=t.utils.isArray(o)?o:Object.keys(o),i=i.concat(o),h(i).filter(function(e){return e})},makeHasManyForeignKeys:function(e,n,r){return t.utils.get(r,e.idAttribute)},makeBelongsToForeignKey:function(e,t,n){return t.getForeignKey(n)},sum:function(e,n,r,o){var u=this,a=void 0;if(!t.utils.isString(n))throw new Error("field must be a string!");return r||(r={}),o||(o={}),a=o.op="beforeSum",t.utils.resolve(u[a](e,n,r,o)).then(function(){return a=o.op="sum",u.dbg(a,e,n,r,o),t.utils.resolve(u._sum(e,n,r,o))}).then(function(s){var l=f.slicedToArray(s,2),c=l[0],d=l[1];d||(d={});var h=new i(c,d,a);return h=u.respond(h,o),a=o.op="afterSum",t.utils.resolve(u[a](e,n,r,o,h)).then(function(e){return t.utils.isUndefined(e)?h:e})})},respond:function(e,t){return this.getOpt("raw",t)?e:e.data},update:function(e,n,r,o){var u=this;r||(r={}),o||(o={});var a=void 0;return a=o.op="beforeUpdate",t.utils.resolve(u[a](e,n,r,o)).then(function(i){return r=t.utils.isUndefined(i)?r:i,r=p(e,r),a=o.op="update",u.dbg(a,e,n,r,o),t.utils.resolve(u._update(e,n,r,o))}).then(function(s){var l=f.slicedToArray(s,2),c=l[0],d=l[1];d||(d={});var h=new i(c,d,"update");return h.updated=c?1:0,h=u.respond(h,o),a=o.op="afterUpdate",t.utils.resolve(u[a](e,n,r,o,h)).then(function(e){return t.utils.isUndefined(e)?h:e})})},updateAll:function(e,n,r,o){var u=this;n||(n={}),r||(r={}),o||(o={});var a=void 0;return a=o.op="beforeUpdateAll",t.utils.resolve(u[a](e,n,r,o)).then(function(i){return n=t.utils.isUndefined(i)?n:i,n=p(e,n),a=o.op="updateAll",u.dbg(a,e,n,r,o),t.utils.resolve(u._updateAll(e,n,r,o))}).then(function(s){var l=f.slicedToArray(s,2),c=l[0],d=l[1];c||(c=[]),d||(d={});var h=new i(c,d,"updateAll");return h.updated=c.length,h=u.respond(h,o),a=o.op="afterUpdateAll",t.utils.resolve(u[a](e,n,r,o,h)).then(function(e){return t.utils.isUndefined(e)?h:e})})},updateMany:function(e,n,r){var o=this;n||(n=[]),r||(r={});var u=void 0,a=e.idAttribute;return n=n.filter(function(e){return t.utils.get(e,a)}),u=r.op="beforeUpdateMany",t.utils.resolve(o[u](e,n,r)).then(function(i){return n=t.utils.isUndefined(i)?n:i,n=n.map(function(t){return p(e,t)}),u=r.op="updateMany",o.dbg(u,e,n,r),t.utils.resolve(o._updateMany(e,n,r))}).then(function(a){var s=f.slicedToArray(a,2),l=s[0],c=s[1];l||(l=[]),c||(c={});var d=new i(l,c,"updateMany");return d.updated=l.length,d=o.respond(d,r),u=r.op="afterUpdateMany",t.utils.resolve(o[u](e,n,r,d)).then(function(e){return t.utils.isUndefined(e)?d:e})})}});var v=[],g=!1,b=r.prototype;l.prototype=Object.create(r.prototype,{constructor:{value:l,enumerable:!1,writable:!0,configurable:!0}}),Object.defineProperty(l,"__super__",{configurable:!0,value:r}),l.extend=t.utils.extend,t.utils.addHiddenPropsToTarget(l.prototype,{_count:function(e,t,n){return t||(t={}),n||(n={}),this._findAll(e,t,n).then(function(e){return e[0]=e[0].length,e})},_create:function(e,t,n){return t||(t={}),n||(n={}),this._upsert(e,t,n)},_upsert:function(e,n,r){var i=this,o=t.utils.plainCopy(n);r||(r={});var u=t.utils.get(o,e.idAttribute),a=this.getRef(e,r),s=void 0;return t.utils.isSorN(u)?s=a.child(u):(s=a.push(),t.utils.set(o,e.idAttribute,s.key)),s.set(o).then(function(){return i._once(s)}).then(function(e){if(!e)throw new Error("Not Found");return[e,{ref:s}]})},_upsertBatch:function(e,n,r){var i=this;r||(r={});var o=e.idAttribute,u=[],a=this.getRef(e,r);return n.forEach(function(e){var n=t.utils.get(e,o),r=t.utils.plainCopy(e),i=void 0;t.utils.isSorN(n)?i=a.child(n):(i=a.push(),t.utils.set(r,o,i.key)),u.push({ref:i,props:r})}),this._atomicUpdate(e,u,r).then(function(){return t.utils.Promise.all(u.map(function(e){return i._once(e.ref)}))}).then(function(e){return[e,{ref:u.map(function(e){return e.ref})}]})},_once:function(e){return e.once("value").then(function(e){return e.exists()?e.val():null})},_atomicUpdate:function(e,t,n){var r=this,i={};return t.forEach(function(t){i[t.ref.toString().replace(r.getRef(e,n).toString(),"")]=t.props}),this.getRef(e,n).update(i)},_createMany:function(e,t,n){return n||(n={}),this._upsertBatch(e,t,n)},_destroy:function(e,t,n){n||(n={});var r=this.getRef(e,n).child(t);return r.remove().then(function(){return[void 0,{ref:r}]})},_destroyAll:function(e,n,r){var i=this;return n||(n={}),r||(r={}),this._findAll(e,n).then(function(n){var o=f.slicedToArray(n,1),u=o[0],a=e.idAttribute;return t.utils.Promise.all(u.map(function(n){return i._destroy(e,t.utils.get(n,a),r)}))}).then(function(){return[void 0,{}]})},_find:function(e,t,n){n||(n={});var r=this.getRef(e,n).child(t);return this._once(r).then(function(e){return[e,{ref:r}]})},_findAll:function(e,n,r){n||(n={}),r||(r={});var i=this.getRef(e,r);return i.once("value").then(function(e){var r=e.val();if(!r)return[[],{ref:i}];var o=[];t.utils.forOwn(r,function(e,t){o.push(e)});var u=new t.Query({index:{getAll:function(){return o}}});return[u.filter(n).run(),{ref:i}]})},_sum:function(e,n,r,i){return this._findAll(e,r,i).then(function(e){return e[0]=e[0].reduce(function(e,r){return e+(t.utils.get(r,n)||0)},0),e})},_update:function(e,n,r,i){var o=this;r||(r={}),i||(i={});var u=this.getRef(e,i).child(n);return this._once(u).then(function(e){if(!e)throw new Error("Not Found");return t.utils.deepMixIn(e,r),u.set(e)}).then(function(){return o._once(u)}).then(function(e){if(!e)throw new Error("Not Found");return[e,{ref:u}]})},_updateAll:function(e,n,r,i){var o=this;return i||(i={}),n||(n={}),r||(r={}),this._findAll(e,r,i).then(function(r){var u=f.slicedToArray(r,1),a=u[0];return a.forEach(function(e){return t.utils.deepMixIn(e,n)}),o._upsertBatch(e,a,i)})},_updateMany:function(e,t,n){return n||(n={}),this._upsertBatch(e,t,n)},getRef:function(e,t){return t=t||{},this.db.ref().child(t.endpoint||e.endpoint||e.name)},create:function(e,t,n){var r=this;return s(function(i,o){a(function(){b.create.call(r,e,t,n).then(i,o)})})},createMany:function(e,t,n){var r=this;return s(function(i,o){a(function(){b.createMany.call(r,e,t,n).then(i,o)})})},destroy:function(e,t,n){var r=this;return s(function(i,o){a(function(){b.destroy.call(r,e,t,n).then(i,o)})})},destroyAll:function(e,t,n){var r=this;return s(function(i,o){a(function(){b.destroyAll.call(r,e,t,n).then(i,o)})})},update:function(e,t,n,r){var i=this;return s(function(o,u){a(function(){b.update.call(i,e,t,n,r).then(o,u)})})},updateAll:function(e,t,n,r){var i=this;return s(function(o,u){a(function(){b.updateAll.call(i,e,t,n,r).then(o,u)})})},updateMany:function(e,t,n){var r=this;return s(function(i,o){a(function(){b.updateMany.call(r,e,t,n).then(i,o)})})}});var A={beta:2,full:"3.0.0-beta.2",major:3,minor:0,patch:0};e.FirebaseAdapter=l,e.version=A});
//# sourceMappingURL=js-data-firebase.min.map