/*!
* js-data-firebase
* @version 3.0.0-rc.1 - Homepage <https://github.com/js-data/js-data-firebase>
* @author Jason Dobry <jason.dobry@gmail.com>
* @copyright (c) 2014-2016 Jason Dobry
* @license MIT <https://github.com/js-data/js-data-firebase/blob/master/LICENSE>
*
* @overview firebase adapter for js-data.
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("js-data"),require("firebase")):"function"==typeof define&&define.amd?define("js-data-firebase",["exports","js-data","firebase"],e):e(t.JSDataFirebase=t.JSDataFirebase||{},t.JSData,t.firebase)}(this,function(t,e,n){"use strict";function r(t,n,r){n||(n={}),this.data=t,e.utils.fillIn(this,n),this.op=r}function i(t){e.utils.classCallCheck(this,i),e.Component.call(this,t),t||(t={}),e.utils.fillIn(t,b),e.utils.fillIn(this,t)}function o(t){g.push(t)}function u(){g.length&&!A&&(A=!0,g[0]())}function a(t){g.length?o(t):(o(t),u())}function s(t){return new e.utils.Promise(t).then(function(t){return A=!1,g.shift(),setTimeout(u,0),t},function(t){return A=!1,g.shift(),setTimeout(u,0),e.utils.reject(t)})}function l(t){e.utils.classCallCheck(this,l),t||(t={}),i.call(this,t),t.db&&(this.db=t.db||n.database())}n="default"in n?n.default:n;var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t},d=function(){function t(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var u,a=t[Symbol.iterator]();!(r=(u=a.next()).done)&&(n.push(u.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),h=function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var i=n[n.length-1];return this.dbg.apply(this,[i.op].concat(n)),e.utils.resolve()},v=function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var i=n[n.length-2];return this.dbg.apply(this,[i.op].concat(n)),e.utils.resolve()},p=function(t){var e={},n=[];return t.forEach(function(t){t in e||(n.push(t),e[t]=0)}),n},y=function(t,n,r){r||(r={}),r.with||(r.with=[]);var i=t.relationFields||[],o=i.filter(function(t){return r.with.indexOf(t)===-1});return e.utils.omit(n,o)},b={debug:!1,raw:!1};e.Component.extend({constructor:i,afterCount:v,afterCreate:v,afterCreateMany:v,afterDestroy:v,afterDestroyAll:v,afterFind:v,afterFindAll:v,afterSum:v,afterUpdate:v,afterUpdateAll:v,afterUpdateMany:v,beforeCount:h,beforeCreate:h,beforeCreateMany:h,beforeDestroy:h,beforeDestroyAll:h,beforeFind:h,beforeFindAll:h,beforeSum:h,beforeUpdate:h,beforeUpdateAll:h,beforeUpdateMany:h,count:function(t,n,i){var o=this,u=void 0;return n||(n={}),i||(i={}),u=i.op="beforeCount",e.utils.resolve(this[u](t,n,i)).then(function(){return u=i.op="count",o.dbg(u,t,n,i),e.utils.resolve(o._count(t,n,i))}).then(function(a){var s=d(a,2),l=s[0],f=s[1];f||(f={});var c=new r(l,f,u);return c=o.respond(c,i),u=i.op="afterCount",e.utils.resolve(o[u](t,n,i,c)).then(function(t){return void 0===t?c:t})})},create:function(t,n,i){var o=this,u=void 0;return n||(n={}),i||(i={}),u=i.op="beforeCreate",e.utils.resolve(this[u](t,n,i)).then(function(r){return n=void 0===r?n:r,n=y(t,n,i),u=i.op="create",o.dbg(u,t,n,i),e.utils.resolve(o._create(t,n,i))}).then(function(a){var s=d(a,2),l=s[0],f=s[1];f||(f={});var c=new r(l,f,"create");return c.created=l?1:0,c=o.respond(c,i),u=i.op="afterCreate",e.utils.resolve(o[u](t,n,i,c)).then(function(t){return void 0===t?c:t})})},createMany:function(t,n,i){var o=this,u=void 0;return n||(n={}),i||(i={}),u=i.op="beforeCreateMany",e.utils.resolve(this[u](t,n,i)).then(function(r){return n=void 0===r?n:r,n=n.map(function(e){return y(t,e,i)}),u=i.op="createMany",o.dbg(u,t,n,i),e.utils.resolve(o._createMany(t,n,i))}).then(function(a){var s=d(a,2),l=s[0],f=s[1];l||(l=[]),f||(f={});var c=new r(l,f,"createMany");return c.created=l.length,c=o.respond(c,i),u=i.op="afterCreateMany",e.utils.resolve(o[u](t,n,i,c)).then(function(t){return void 0===t?c:t})})},destroy:function(t,n,i){var o=this,u=void 0;return i||(i={}),u=i.op="beforeDestroy",e.utils.resolve(this[u](t,n,i)).then(function(){return u=i.op="destroy",o.dbg(u,t,n,i),e.utils.resolve(o._destroy(t,n,i))}).then(function(a){var s=d(a,2),l=s[0],f=s[1];f||(f={});var c=new r(l,f,"destroy");return c=o.respond(c,i),u=i.op="afterDestroy",e.utils.resolve(o[u](t,n,i,c)).then(function(t){return void 0===t?c:t})})},destroyAll:function(t,n,i){var o=this,u=void 0;return n||(n={}),i||(i={}),u=i.op="beforeDestroyAll",e.utils.resolve(this[u](t,n,i)).then(function(){return u=i.op="destroyAll",o.dbg(u,t,n,i),e.utils.resolve(o._destroyAll(t,n,i))}).then(function(a){var s=d(a,2),l=s[0],f=s[1];f||(f={});var c=new r(l,f,"destroyAll");return c=o.respond(c,i),u=i.op="afterDestroyAll",e.utils.resolve(o[u](t,n,i,c)).then(function(t){return void 0===t?c:t})})},loadBelongsTo:function(t,n,r,i){var o=this,u=n.getRelation();if(!e.utils.isObject(r)||e.utils.isArray(r)){var a=r.map(function(e){return o.makeBelongsToForeignKey(t,n,e)}).filter(function(t){return t});return this.findAll(u,{where:c({},u.idAttribute,{in:a})},i).then(function(t){r.forEach(function(e){t.forEach(function(t){t[u.idAttribute]===e[n.foreignKey]&&n.setLocalField(e,t)})})})}var s=function(){var e=r;return{v:o.find(u,o.makeBelongsToForeignKey(t,n,e),i).then(function(t){n.setLocalField(e,t)})}}();if("object"===("undefined"==typeof s?"undefined":f(s)))return s.v},find:function(t,n,i){var o=this,u=void 0,a=void 0,s={};return i||(i={}),i.with||(i.with=[]),a=i.op="beforeFind",e.utils.resolve(this[a](t,n,i)).then(function(){return a=i.op="find",o.dbg(a,t,n,i),e.utils.resolve(o._find(t,n,i))}).then(function(n){var r=d(n,2),a=r[0],l=r[1];if(a){u=a,s=l;var f=[];return e.utils.forEachRelation(t,i,function(e,n){var r=void 0;!e.foreignKey||"hasOne"!==e.type&&"hasMany"!==e.type?"hasMany"===e.type&&e.localKeys?r=o.loadHasManyLocalKeys(t,e,u,n):"hasMany"===e.type&&e.foreignKeys?r=o.loadHasManyForeignKeys(t,e,u,n):"belongsTo"===e.type&&(r=o.loadBelongsTo(t,e,u,n)):r="hasOne"===e.type?o.loadHasOne(t,e,u,n):o.loadHasMany(t,e,u,n),r&&f.push(r)}),e.utils.Promise.all(f)}}).then(function(){var l=new r(u,s,"find");return l.found=u?1:0,l=o.respond(l,i),a=i.op="afterFind",e.utils.resolve(o[a](t,n,i,l)).then(function(t){return void 0===t?l:t})})},findAll:function(t,n,i){var o=this;i||(i={}),i.with||(i.with=[]);var u=[],a={},s=void 0,l=i._activeWith;if(e.utils.isObject(l)){var f=l.query||{};l.replace?n=f:e.utils.deepFillIn(n,f)}return s=i.op="beforeFindAll",e.utils.resolve(this[s](t,n,i)).then(function(){return s=i.op="findAll",o.dbg(s,t,n,i),e.utils.resolve(o._findAll(t,n,i))}).then(function(n){var r=d(n,2),s=r[0],l=r[1];s||(s=[]),u=s,a=l;var f=[];return e.utils.forEachRelation(t,i,function(e,n){var r=void 0;!e.foreignKey||"hasOne"!==e.type&&"hasMany"!==e.type?"hasMany"===e.type&&e.localKeys?r=o.loadHasManyLocalKeys(t,e,u,n):"hasMany"===e.type&&e.foreignKeys?r=o.loadHasManyForeignKeys(t,e,u,n):"belongsTo"===e.type&&(r=o.loadBelongsTo(t,e,u,n)):r="hasMany"===e.type?o.loadHasMany(t,e,u,n):o.loadHasOne(t,e,u,n),r&&f.push(r)}),e.utils.Promise.all(f)}).then(function(){var l=new r(u,a,"findAll");return l.found=u.length,l=o.respond(l,i),s=i.op="afterFindAll",e.utils.resolve(o[s](t,n,i,l)).then(function(t){return void 0===t?l:t})})},getOpt:function(t,n){return n||(n={}),void 0===n[t]?e.utils.plainCopy(this[t]):e.utils.plainCopy(n[t])},loadHasMany:function(t,n,r,i){var o=this,u=!1;e.utils.isObject(r)&&!e.utils.isArray(r)&&(u=!0,r=[r]);var a=r.map(function(e){return o.makeHasManyForeignKey(t,n,e)}),s={where:{}},l=s.where[n.foreignKey]={};return u?l["=="]=a[0]:l.in=a.filter(function(t){return t}),this.findAll(n.getRelation(),s,i).then(function(i){r.forEach(function(r){var o=[];u?o=i:i.forEach(function(i){e.utils.get(i,n.foreignKey)===r[t.idAttribute]&&o.push(i)}),n.setLocalField(r,o)})})},loadHasManyLocalKeys:function(t,n,r,i){var o=this,u=void 0,a=n.getRelation();if(e.utils.isObject(r)&&!e.utils.isArray(r)&&(u=r),u)return this.findAll(a,{where:c({},a.idAttribute,{in:this.makeHasManyLocalKeys(t,n,u)})},i).then(function(t){n.setLocalField(u,t)});var s=function(){var u=[];return r.forEach(function(e){u=u.concat(o.makeHasManyLocalKeys(t,n,e))}),{v:o.findAll(a,{where:c({},a.idAttribute,{in:p(u).filter(function(t){return t})})},i).then(function(t){return r.forEach(function(r){var i=[],o=e.utils.get(r,n.localKeys)||[];o=e.utils.isArray(o)?o:Object.keys(o),t.forEach(function(t){o&&o.indexOf(t[a.idAttribute])!==-1&&i.push(t)}),n.setLocalField(r,i)}),t})}}();return"object"===("undefined"==typeof s?"undefined":f(s))?s.v:void 0},loadHasManyForeignKeys:function(t,n,r,i){var o=this,u=n.getRelation(),a=t.idAttribute,s=void 0;return e.utils.isObject(r)&&!e.utils.isArray(r)&&(s=r),s?this.findAll(n.getRelation(),{where:c({},n.foreignKeys,{contains:this.makeHasManyForeignKeys(t,n,s)})},i).then(function(t){n.setLocalField(s,t)}):this.findAll(u,{where:c({},n.foreignKeys,{isectNotEmpty:r.map(function(e){return o.makeHasManyForeignKeys(t,n,e)})})},i).then(function(t){var i=n.foreignKeys;r.forEach(function(r){var o=[],u=e.utils.get(r,a);t.forEach(function(n){var r=e.utils.get(t,i)||[];r.indexOf(u)!==-1&&o.push(n)}),n.setLocalField(r,o)})})},loadHasOne:function(t,n,r,i){return e.utils.isObject(r)&&!e.utils.isArray(r)&&(r=[r]),this.loadHasMany(t,n,r,i).then(function(){r.forEach(function(t){var r=n.getLocalField(t);e.utils.isArray(r)&&r.length&&n.setLocalField(t,r[0])})})},makeHasManyForeignKey:function(t,e,n){return e.getForeignKey(n)},makeHasManyLocalKeys:function(t,n,r){var i=[],o=e.utils.get(r,n.localKeys)||[];return o=e.utils.isArray(o)?o:Object.keys(o),i=i.concat(o),p(i).filter(function(t){return t})},makeHasManyForeignKeys:function(t,n,r){return e.utils.get(r,t.idAttribute)},makeBelongsToForeignKey:function(t,e,n){return e.getForeignKey(n)},sum:function(t,n,i,o){var u=this,a=void 0;if(!e.utils.isString(n))throw new Error("field must be a string!");return i||(i={}),o||(o={}),a=o.op="beforeSum",e.utils.resolve(this[a](t,n,i,o)).then(function(){return a=o.op="sum",u.dbg(a,t,n,i,o),e.utils.resolve(u._sum(t,n,i,o))}).then(function(s){var l=d(s,2),f=l[0],c=l[1];c||(c={});var h=new r(f,c,a);return h=u.respond(h,o),a=o.op="afterSum",e.utils.resolve(u[a](t,n,i,o,h)).then(function(t){return void 0===t?h:t})})},respond:function(t,e){return this.getOpt("raw",e)?t:t.data},update:function(t,n,i,o){var u=this;i||(i={}),o||(o={});var a=void 0;return a=o.op="beforeUpdate",e.utils.resolve(this[a](t,n,i,o)).then(function(r){return i=void 0===r?i:r,i=y(t,i,o),a=o.op="update",u.dbg(a,t,n,i,o),e.utils.resolve(u._update(t,n,i,o))}).then(function(s){var l=d(s,2),f=l[0],c=l[1];c||(c={});var h=new r(f,c,"update");return h.updated=f?1:0,h=u.respond(h,o),a=o.op="afterUpdate",e.utils.resolve(u[a](t,n,i,o,h)).then(function(t){return void 0===t?h:t})})},updateAll:function(t,n,i,o){var u=this;n||(n={}),i||(i={}),o||(o={});var a=void 0;return a=o.op="beforeUpdateAll",e.utils.resolve(this[a](t,n,i,o)).then(function(r){return n=void 0===r?n:r,n=y(t,n,o),a=o.op="updateAll",u.dbg(a,t,n,i,o),e.utils.resolve(u._updateAll(t,n,i,o))}).then(function(s){var l=d(s,2),f=l[0],c=l[1];f||(f=[]),c||(c={});var h=new r(f,c,"updateAll");return h.updated=f.length,h=u.respond(h,o),a=o.op="afterUpdateAll",e.utils.resolve(u[a](t,n,i,o,h)).then(function(t){return void 0===t?h:t})})},updateMany:function(t,n,i){var o=this;n||(n=[]),i||(i={});var u=void 0,a=t.idAttribute;return n=n.filter(function(t){return e.utils.get(t,a)}),u=i.op="beforeUpdateMany",e.utils.resolve(this[u](t,n,i)).then(function(r){return n=void 0===r?n:r,n=n.map(function(e){return y(t,e,i)}),u=i.op="updateMany",o.dbg(u,t,n,i),e.utils.resolve(o._updateMany(t,n,i))}).then(function(a){var s=d(a,2),l=s[0],f=s[1];l||(l=[]),f||(f={});var c=new r(l,f,"updateMany");return c.updated=l.length,c=o.respond(c,i),u=i.op="afterUpdateMany",e.utils.resolve(o[u](t,n,i,c)).then(function(t){return void 0===t?c:t})})}});var g=[],A=!1,m=i.prototype;l.prototype=Object.create(i.prototype,{constructor:{value:l,enumerable:!1,writable:!0,configurable:!0}}),Object.defineProperty(l,"__super__",{configurable:!0,value:i}),l.extend=e.utils.extend,e.utils.addHiddenPropsToTarget(l.prototype,{_count:function(t,e,n){return e||(e={}),n||(n={}),this._findAll(t,e,n).then(function(t){return t[0]=t[0].length,t})},_create:function(t,e,n){return e||(e={}),n||(n={}),this._upsert(t,e,n)},_upsert:function(t,n,r){var i=this,o=e.utils.plainCopy(n);r||(r={});var u=e.utils.get(o,t.idAttribute),a=this.getRef(t,r),s=void 0;return e.utils.isSorN(u)?s=a.child(u):(s=a.push(),e.utils.set(o,t.idAttribute,s.key)),s.set(o).then(function(){return i._once(s)}).then(function(t){if(!t)throw new Error("Not Found");return[t,{ref:s}]})},_upsertBatch:function(t,n,r){var i=this;r||(r={});var o=t.idAttribute,u=[],a=this.getRef(t,r);return n.forEach(function(t){var n=e.utils.get(t,o),r=e.utils.plainCopy(t),i=void 0;e.utils.isSorN(n)?i=a.child(n):(i=a.push(),e.utils.set(r,o,i.key)),u.push({ref:i,props:r})}),this._atomicUpdate(t,u,r).then(function(){return e.utils.Promise.all(u.map(function(t){return i._once(t.ref)}))}).then(function(t){return[t,{ref:u.map(function(t){return t.ref})}]})},_once:function(t){return t.once("value").then(function(t){return t.exists()?t.val():null})},_atomicUpdate:function(t,e,n){var r=this,i={};return e.forEach(function(e){i[e.ref.toString().replace(r.getRef(t,n).toString(),"")]=e.props}),this.getRef(t,n).update(i)},_createMany:function(t,e,n){return n||(n={}),this._upsertBatch(t,e,n)},_destroy:function(t,e,n){n||(n={});var r=this.getRef(t,n).child(e);return r.remove().then(function(){return[void 0,{ref:r}]})},_destroyAll:function(t,n,r){var i=this;return n||(n={}),r||(r={}),this._findAll(t,n).then(function(n){var o=d(n,1),u=o[0],a=t.idAttribute;return e.utils.Promise.all(u.map(function(n){return i._destroy(t,e.utils.get(n,a),r)}))}).then(function(){return[void 0,{}]})},_find:function(t,e,n){n||(n={});var r=this.getRef(t,n).child(e);return this._once(r).then(function(t){return[t,{ref:r}]})},_findAll:function(t,n,r){n||(n={}),r||(r={});var i=this.getRef(t,r);return i.once("value").then(function(t){var r=t.val();if(!r)return[[],{ref:i}];var o=[];e.utils.forOwn(r,function(t,e){o.push(t)});var u=new e.Query({index:{getAll:function(){return o}}});return[u.filter(n).run(),{ref:i}]})},_sum:function(t,n,r,i){return this._findAll(t,r,i).then(function(t){return t[0]=t[0].reduce(function(t,r){return t+(e.utils.get(r,n)||0)},0),t})},_update:function(t,n,r,i){var o=this;r||(r={}),i||(i={});var u=this.getRef(t,i).child(n);return this._once(u).then(function(t){if(!t)throw new Error("Not Found");return e.utils.deepMixIn(t,r),u.set(t)}).then(function(){return o._once(u)}).then(function(t){if(!t)throw new Error("Not Found");return[t,{ref:u}]})},_updateAll:function(t,n,r,i){var o=this;return i||(i={}),n||(n={}),r||(r={}),this._findAll(t,r,i).then(function(r){var u=d(r,1),a=u[0];return a.forEach(function(t){return e.utils.deepMixIn(t,n)}),o._upsertBatch(t,a,i)})},_updateMany:function(t,e,n){return n||(n={}),this._upsertBatch(t,e,n)},getRef:function(t,e){return e=e||{},this.db.ref().child(e.endpoint||t.endpoint||t.name)},create:function(t,e,n){var r=this;return s(function(i,o){a(function(){m.create.call(r,t,e,n).then(i,o)})})},createMany:function(t,e,n){var r=this;return s(function(i,o){a(function(){m.createMany.call(r,t,e,n).then(i,o)})})},destroy:function(t,e,n){var r=this;return s(function(i,o){a(function(){m.destroy.call(r,t,e,n).then(i,o)})})},destroyAll:function(t,e,n){var r=this;return s(function(i,o){a(function(){m.destroyAll.call(r,t,e,n).then(i,o)})})},update:function(t,e,n,r){var i=this;return s(function(o,u){a(function(){m.update.call(i,t,e,n,r).then(o,u)})})},updateAll:function(t,e,n,r){var i=this;return s(function(o,u){a(function(){m.updateAll.call(i,t,e,n,r).then(o,u)})})},updateMany:function(t,e,n){var r=this;return s(function(i,o){a(function(){m.updateMany.call(r,t,e,n).then(i,o)})})}});var M={full:"3.0.0-rc.1",major:3,minor:0,patch:0};t.FirebaseAdapter=l,t.version=M,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=js-data-firebase.min.map