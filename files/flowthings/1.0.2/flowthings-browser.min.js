void function(n,e){var t=function(){var n;try{n=new XMLHttpRequest}catch(e){n={}}if(n.withCredentials!=null){return XMLHttpRequest}if(typeof XDomainRequest!="undefined"){return XDomainRequest}throw new Error("Cross-domain requests are required")}();var r=function(){if(typeof WebSocket!="undefined"){return WebSocket}return null}();function i(n){return e(n,r,t)}if(typeof define==="function"&&define.amd){define(["exports"],i)}else if(typeof exports==="object"){i(exports)}else{i(n.flowthings={})}}(this,function(n,e,t){$(n,{API:r,APIClient:i,WebSocketClient:o,promisify:P,options:{secure:true,host:"api.flowthings.io",wsHost:"ws.flowthings.io",version:"0.1",transform:O,serializer:JSON}});function r(t){var r=$({},n.options,t);return i(r,p(r.serializer),e)}function i(n,e,t){function r(t,r){var i={url:d({secure:n.secure,host:n.host,version:n.version,account:n.account,path:t.path}),method:t.method,params:m(t.params),data:t.data,headers:{"X-Auth-Token":n.token}};return n.transform(function(n){return e(i,n)},r||A)}return{request:r,ws:o(n,e,t),flow:l(r,"/flow",[u]),drop:$(c(r,"/drop",[u,s,f]),l(r,"/drop",[a]))}}function o(n,e,t){var r=null;var i={};var o={};var u=[];var a=false;var s=1;var f;var l={connect:c,subscribe:y,unsubscribe:w,send:P,__receive:S,__flush:b};function c(i){return n.transform(function(i){if(a){return i(null,l)}return e({url:h("http",n),method:"POST",headers:{"X-Auth-Account":n.account,"X-Auth-Token":n.token}},function(e,o){if(e){return i(e,null)}var u=h("ws",n)+"/"+o.body.id+"/ws";r=$(new t(u),{onopen:p,onmessage:d,onerror:g,onclose:m});l.__socket=r;return i(null,l)})},i||A)}function p(){a=true;f=setTimeout(k,3e4);b();if(l.onopen){l.onopen()}}function d(n){S(n.data);if(l.onmessage){l.onmessage(n.data)}}function g(){j();if(l.onerror){l.onerror()}}function m(n){j();if(l.onclose){l.onclose(n)}}function y(e,t,r){function o(n,t){if(i.hasOwnProperty(e)){var r=i[e];var o=r.pending.slice();if(n!=null){delete i[e];q(o,function(e){e.callback(n,null)})}else{delete r.pending;r.result=t;q(o,function(n){r.handlers.push(n.handler)});q(o,function(n){n.callback(null,t)})}}}return n.transform(function(n){if(i.hasOwnProperty(e)){var r=i[e];if(r.pending){r.pending=r.pending.concat({handler:t,callback:n})}else{r.handlers.push(t);n(null,r.result)}}else{var r=i[e]={result:null,handlers:[],pending:[{handler:t,callback:n}]};O(v("drop","subscribe",e),o)}},r||A)}function w(e,t,r){return n.transform(function(n){if(i.hasOwnProperty(e)){var r=i[e];if(r.pending){r.pending=r.pending.filter(function(n){return n.handler!==t})}else{r.handlers=r.handlers.filter(function(n){return n!==t})}if(r.pending&&!r.pending.length||!r.handlers.length){O(v("drop","subscribe",e),function(t,r){if(r!=null){delete i[e]}n(t,r)})}else{n(null,{})}}},r||A)}function b(){while(u.length){u.shift()()}}function O(e,t){if(t){e=$({},e,{msgId:s++})}function i(){r.send(n.serializer.stringify(e))}if(e.msgId){o[e.msgId]=t}if(a){i()}else{u.push(i)}}function P(e,t){return n.transform(function(n){O(e,n)},t||A)}function S(e){var t=n.serializer.parse(e);if(t.type==="message"){function r(n){n(t.value)}if(i.hasOwnProperty(t.value.flowId)){q(i[t.value.flowId].handlers,r)}if(i.hasOwnProperty(t.value.path)){q(i[t.value.path].handlers,r)}}else{var u=t.head.msgId;if(o.hasOwnProperty(u)){if(t.head.ok){o[u](null,t.body)}else{o[u](t,null)}delete o[u]}}}function j(){var n=o;clearTimeout(f);a=false;r=null;i={};o={};u=[];s=1;q(n,function(n){n(new Error("Connection interrupted"),null)})}function k(){if(r){O({type:"heartbeat"});f=setTimeout(k,3e4)}}return l}function u(n,e){function t(t,r,i){if(S(r)){i=r;r=null}return n({method:"GET",path:e+"/"+t,params:r},i)}function r(t,r,i){if(S(r)){i=r;r=null}return n({method:"MGET",path:e,data:t,params:r},i)}function i(t,r){if(S(t)){r=t;t=null}return n({method:"GET",path:e,params:t},r)}function o(n,e,o){if(k(n)){return t(n,e)}if(j(n)){return r(n,e,o)}return i(n,e)}return{read:t,readMany:r,findMany:i,find:o}}function a(n,e){function t(t,r,i){if(S(r)){i=r;r=null}return n({method:"POST",path:e,data:t,params:r},i)}return{create:t}}function s(n,e){var t=a(n,e);function r(t,r,i){if(S(r)){i=r;r=null}return n({method:"PUT",path:e+"/"+t.id,data:t,params:r},i)}function i(n,e,i){if(S(e)){i=e;e=null}if(n.id){return r(n,e,i)}return t.create(n,e,i)}return $(t,{update:r,save:i})}function f(n,e){function t(t,r,i){if(S(r)){i=r;r=null}return n({method:"POST",path:e+"/aggregate",data:t,params:r},i)}return{aggregate:t}}function l(n,e,t){var r={};q(t,function(t){$(r,t(n,e))});return r}function c(n,e,t){return function(r){return l(n,e+"/"+r,t)}}function p(n){return function(e,r){var i=new t;i.open(e.method,e.url+g(e.params),true);i.onreadystatechange=function(){if(i.readyState===4&&r){var e;try{e=n.parse(i.responseText)}catch(t){return r(t)}if(i.status>=200&&i.status<300){return r(null,e)}else{return r(e,null)}}};q(e.headers,function(n,e){i.setRequestHeader(e,n)});i.setRequestHeader("Accept","application/json");if(e.data){var o=n.stringify(e.data);i.setRequestHeader("Content-Type","application/json");i.send(o)}else{i.send()}}}function d(n){return(n.secure?"https":"http")+"://"+n.host+"/v"+n.version+"/"+n.account+n.path}function h(n,e){return n+(e.secure?"s":"")+"://"+e.wsHost+"/session"}function g(n){var e=[];if(n){q(n,function(n,t){e.push(t+"="+encodeURIComponent(n.toString()))})}return e.length?"?"+e.join("&"):""}function v(n,e,t){var r={object:n,type:e};if(t.charAt(0)==="/"){r.path=t}else{r.flowId=t}return r}function m(n){var e={};q(n,function(n,t){switch(t){case"only":if(j(n)){n=n.join(",")}break;case"refs":n=n?1:0;break;case"filter":if(!k(n)){n=y(n)}break}e[t]=n});return e}function y(n){var e=[];q(n,function(n,t){if(t==="$and"){e.push([n.map(y).join("&&")])}else if(t==="$or"){e.push([n.map(y).join("||")])}else if(T(n)){e.push([t,"=~",w(n)])}else if(n.hasOwnProperty("$regex")){e.push([t,"=~",b(n.$regex)])}else if(n.hasOwnProperty("$lt")){e.push([t,"<",JSON.stringify(n.$lt)])}else if(n.hasOwnProperty("$lte")){e.push([t,"<=",JSON.stringify(n.$lte)])}else if(n.hasOwnProperty("$gt")){e.push([t,">",JSON.stringify(n.$gt)])}else if(n.hasOwnProperty("$gte")){e.push([t,">=",JSON.stringify(n.$gte)])}else{e.push([t,"==",JSON.stringify(n)])}});return e.map(function(n){return"("+n.join(" ")+")"}).join("&&")}function w(n){var e=n.source;var t="";if(n.global){t+="g"}if(n.ignoreCase){t+="i"}if(n.multiline){t+="m"}return"/"+e+"/"+t}function b(n){var e,t;if(j(n)){e=reg[0];t=reg[1]||""}else{e=n;t=""}return"/"+e.replace(/\//g,"\\/")+"/"+t}function O(n,e){return n(e)}function P(n){return function e(t){return new n(function(n,e){t(function(t,r){if(t!=null){e(t)}else{n(r)}})})}}function S(n){return typeof n==="function"}function j(n){return Array.isArray(n)}function k(n){return typeof n==="string"||Object.prototype.toString.call(n)==="[object String]"}function T(n){return typeof n==="object"&&Object.prototype.toString.call(n)==="[object RegExp]"}function $(){var n=arguments[0]||{};for(var e=1;e<arguments.length;e++){var t=arguments[e];if(typeof t!=="object"){continue}for(var r in t){if(t.hasOwnProperty(r)){n[r]=t[r]}}}return n}function q(n,e){if(j(n)){for(var t=0;t<n.length;t++){e(n[t],t,n)}}else if(n!=null){for(var r in n){if(n.hasOwnProperty(r)){e(n[r],r,n)}}}}function A(){}});