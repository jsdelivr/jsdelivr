/*! formstone v0.6.1 [upload.js] 2015-05-22 | MIT License | formstone.it */

!function(a,b,c){"use strict";function d(a){if(b.support.file){var c="";c+='<div class="'+q.target+'">',c+=a.label,c+="</div>",c+='<input class="'+q.input+'" type="file"',a.maxQueue>1&&(c+=" "+q.multiple),c+=">",this.addClass(q.base).append(c),a.$input=this.find(p.input),a.queue=[],a.total=0,a.uploading=!1,this.on(r.click,p.target,a,f).on(r.dragEnter,a,h).on(r.dragOver,a,i).on(r.dragLeave,a,j).on(r.drop,p.target,a,k),a.$input.on(r.change,a,g)}}function e(a){b.support.file&&(a.$input.off(r.namespace),this.off([r.click,r.dragEnter,r.dragOver,r.dragLeave,r.drop].join(" ")).removeClass(q.base).html(""))}function f(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$input.trigger(r.click)}function g(a){a.stopPropagation(),a.preventDefault();var b=a.data,c=b.$input[0].files;c.length&&l(b,c)}function h(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$el.addClass(q.dropping)}function i(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$el.addClass(q.dropping)}function j(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$el.removeClass(q.dropping)}function k(a){a.preventDefault();var b=a.data,c=a.originalEvent.dataTransfer.files;b.$el.removeClass(q.dropping),l(b,c)}function l(a,b){for(var c=[],d=0;d<b.length;d++){var e={index:a.total++,file:b[d],name:b[d].name,size:b[d].size,started:!1,complete:!1,error:!1,transfer:null};c.push(e),a.queue.push(e)}a.uploading||(s.on(r.beforeUnload,function(){return a.leave}),a.uploading=!0),a.$el.trigger(r.start,[c]),m(a)}function m(a){var b=0,c=[];for(var d in a.queue)!a.queue.hasOwnProperty(d)||a.queue[d].complete||a.queue[d].error||c.push(a.queue[d]);a.queue=c;for(var e in a.queue)if(a.queue.hasOwnProperty(e)){if(!a.queue[e].started){var f=new FormData;f.append(a.postKey,a.queue[e].file);for(var g in a.postData)a.postData.hasOwnProperty(g)&&f.append(g,a.postData[g]);n(a,a.queue[e],f)}if(b++,b>=a.maxQueue)return;d++}0===b&&(s.off(r.beforeUnload),a.uploading=!1,a.$el.trigger(r.complete))}function n(b,c,d){c.size>=b.maxSize?(c.error=!0,b.$el.trigger(r.fileError,[c,"Too large"]),m(b)):(c.started=!0,c.transfer=a.ajax({url:b.action,data:d,type:"POST",contentType:!1,processData:!1,cache:!1,xhr:function(){var d=a.ajaxSettings.xhr();return d.upload&&d.upload.addEventListener("progress",function(a){var d=0,e=a.loaded||a.position,f=a.total;a.lengthComputable&&(d=Math.ceil(e/f*100)),b.$el.trigger(r.fileProgress,[c,d])},!1),d},beforeSend:function(a){b.$el.trigger(r.fileStart,[c])},success:function(a,d,e){c.complete=!0,b.$el.trigger(r.fileComplete,[c,a]),m(b)},error:function(a,d,e){c.error=!0,b.$el.trigger(r.fileError,[c,e]),m(b)}}))}var o=b.Plugin("upload",{widget:!0,defaults:{customClass:"",action:"",label:"Drag and drop files or click to select",leave:"You have uploads pending, are you sure you want to leave this page?",maxQueue:2,maxSize:5242880,postData:{},postKey:"file"},classes:["input","target","multiple","dropping"],methods:{_construct:d,_destruct:e}}),p=o.classes,q=p.raw,r=o.events,s=(o.functions,b.$window);r.complete="complete",r.fileStart="filestart",r.fileProgress="fileprogress",r.fileComplete="filecomplete",r.fileError="fileerror",r.start="start"}(jQuery,Formstone);