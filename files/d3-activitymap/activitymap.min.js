(function(){ActivityMap=function(b,a){this.data=b;this.id="example-activity-map";this.parent="body";this.colours=["#ffffff","#ecffeb","#daffd6","#c7ffc2","#b4ffad","#a2ff99","#8fff85","#7cff70","#69ff5c","#57ff47","#44ff33","#31ff1f","#1fff0a","#14f500","#13e000","#11cc00","#0ead00","#0ea300","#0c8f00","#0a7a00","#096600","#075200","#053d00","#032900","#021400"];this.title="Activity map: ";this.timeColumn="t";this.valueColumn="v";this.fit=false;if(a){if(a.id!==undefined){this.id=a.id}if(a.parent!==undefined){this.parent=a.parent}if(a.colours!==undefined){this.colours=a.colours}if(a.title!==undefined){this.title=a.title}if(a.timeColumn!==undefined){this.timeColumn=a.timeColumn}if(a.valueColumn!==undefined){this.valueColumn=a.valueColumn}if(a.fit!==undefined){this.fit=a.fit}}this.init()};ActivityMap.prototype={init:function(){var b=this,a;b.process();if(typeof b.parent==="string"){a=d3.select(b.parent)}b.node=a.append("div").attr("id",b.id).attr("class","activity-map");b.parent=a;b.months={"0":{n:31,l:"January"},"1":{n:28,l:"February"},"2":{n:31,l:"March"},"3":{n:30,l:"April"},"4":{n:31,l:"May"},"5":{n:30,l:"June"},"6":{n:31,l:"July"},"7":{n:31,l:"August"},"8":{n:30,l:"September"},"9":{n:31,l:"October"},"10":{n:30,l:"November"},"11":{n:31,l:"December"}};b.weeks="SMTWTFS"},reorderColours:function(){var e=this,f=e.colours,d,b=0,a=f.length-1;while(b<a){d=f[b];f[b++]=f[a];f[a--]=d}},process:function(){var w=this,x=w.data,b,e={},g,k,q,n,s,j,h,l=[],p={},r=99999,o=0,u=0,f=w.timeColumn,a=w.valueColumn;for(n=0,s=x.length;n<s;++n){b=x[n];if(b){j=b[f];if(!(j instanceof Date)){j=new Date(parseInt(j))}g=j.getFullYear();k=j.getMonth();q=j.getDate()-1;h=parseFloat(b[a]);if(e[g]===undefined){e[g]={}}if(e[g][k]===undefined){e[g][k]={}}if(e[g][k][q]===undefined){e[g][k][q]=h}if(r>g){r=g}if(o<g){o=g}if(u<h){u=h}if(p[g]===undefined){p[g]=g;l.push(g)}}}w.processed={m:r,M:o,V:u,y:l,l:e}},renderMonth:function(f,r,g,p){var q=this,k,h,c,t,u,o=q.months[g],a=q.processed.l,b=q.colours,s=b.length/q.processed.V;c=f.append("div").attr("class","amap-month");c.append("div").attr("class","amap-month-name").text(o.l);for(k=0;k<p;++k){c.append("div").attr("class","amap-empty-day")}for(h=0,p=o.n;h<p;++k,++h){t=c.append("div").attr("class","amap-week-day");if(k%7===0){t.classed("amap-week-start",true)}try{u=a[r][g][h];if(u){t.style("background-color",b[Math.ceil(u*s)]);t.attr("title",r+"-"+(g+1)+"-"+(h+1)+": "+u)}}catch(l){}}p=k%7;while(k++%7){c.append("div").attr("class","amap-empty-day")}c=c.append("div").attr("class","amap-week-names");for(k=0;k<7;++k){c.append("div").attr("class","amap-week-name").text(q.weeks[k])}return p},renderYear:function(f){var b=this,c,a,e;b.months[1].n=f%4?28:29;e=b.blocks.append("div").attr("class","amap-year-block").attr("year",f);e.append("div").attr("class","amap-year-name").text(f);e=e.append("div").attr("class","amap-months");c=new Date(f,0,1);c=c.getDay();for(a=0;a<12;++a){c=b.renderMonth(e,f,a,c)}},isVisible:function(d,b){var a=d.getBoundingClientRect(),c=b.getBoundingClientRect();return !(a.top>c.bottom||a.bottom<c.top)},onScroll:function(c){var d=99999,a=0,b;c.blocks.selectAll(".amap-year-block").each(function(){if(c.isVisible(this,c.blocks.node())){b=parseInt(d3.select(this).attr("year"));if(d>b){d=b}if(a<b){a=b}}});if(d===a){c.year.text(c.title+a)}else{c.year.text(c.title+d+"-"+a)}},render:function(){var d=this,b,e,a=d.processed.y;d.year=d.node.append("div").attr("class","amap-title");d.blocks=d.node.append("div").attr("class","amap-year-blocks");d.blocks.on("scroll",function(){d.onScroll(d)});for(b=0,e=a.length;b<e;++b){d.renderYear(a[b])}d.onScroll(d);d.refit()},refit:function(){var a=this;if(!a.fit){a.blocks.style("height",(parseInt(a.node.style("height"))-parseInt(a.year.style("height")))+"px")}}}})();
