// keymage.js - Javascript keyboard event handling
// http://github.com/piranha/keymage
//
// (c) 2012 Alexander Solovyov
// under terms of ISC License
(function(a,b){a(function(){function m(a){var b=a.split("-"),d=b[b.length-1],e={code:f[d]};if(!e.code)throw'Unknown key "'+d+'" in keystring "'+a+'"';var g;for(var h=0;h<b.length-1;h++){d=b[h],g=c[d];if(!g)throw'Unknown modifier "'+d+'" in keystring "'+a+'"';e[g]=!0}return e}function n(a){var b="";for(var c=0;c<d.length;c++)a[d[c]]&&(b+=d[c]+"-");return b+=h[a.code],b}function o(a){var b=[],c=a.split(" ");for(var d=0;d<c.length;d++){var e=m(c[d]);e=n(e),b.push(e)}return b.original=a,b}function p(b){var c={code:b.keyCode};for(var d=0;d<a.length;d++){var e=a[d];b[e]&&(c[e.slice(0,e.length-3)]=!0)}return n(c)}function q(a,b){for(var c=0;c<b.length;c++){var d=b[c];d&&(a=a[d]);if(!a)break}return a}function s(a){if(~e.indexOf(a.keyCode))return;var b=r.slice();b.push(p(a));var c=k.split("."),d,f,g;for(var h=c.length;h>=0;h--){f=q(l,c.slice(0,h));if(!f)continue;d=!0;for(var i=0;i<b.length;i++){g=b[i];if(!f[g]){d=!1;break}f=f[g]}if(d)break}var j=c.slice(0,h).join("."),m=f.preventDefault;if(d&&!f.handlers){r=b,m&&a.preventDefault();return}if(d)for(h=0;h<f.handlers.length;h++){var n=f.handlers[h],o=n._keymage,s=n.call(o.context,a,{shortcut:o.original,scope:k,definitionScope:j});(s===!1||m)&&a.preventDefault()}r=[]}function t(a,b,c){var d=a.split("."),e=l;d=d.concat(b);for(var f=0,g=d.length;f<g;f++){var h=d[f];if(!h)continue;e=e[h]||(e[h]={}),c._keymage.preventDefault&&(e.preventDefault=!0);if(f===g-1){var i=e.handlers||(e.handlers=[]);i.push(c)}}}function u(a,c,d,e){if(c===b&&d===b)return function(b,c){return u(a,b,c)};typeof c=="function"&&(e=d,d=c,c=a,a="");var f=o(c);d._keymage=e||{},d._keymage.original=c,t(a,f,d)}var a=["shiftKey","ctrlKey","altKey","metaKey"],c={shift:"shift",ctrl:"ctrl",control:"ctrl",alt:"alt",option:"alt",win:"meta",cmd:"meta","super":"meta",meta:"meta",defmod:~navigator.userAgent.indexOf("Mac OS X")?"meta":"ctrl"},d=["shift","ctrl","alt","meta"],e=[16,17,18,91],f={backspace:8,tab:9,enter:13,"return":13,pause:19,caps:20,capslock:20,escape:27,esc:27,space:32,pgup:33,pageup:33,pgdown:34,pagedown:34,end:35,home:36,ins:45,insert:45,del:46,"delete":46,left:37,up:38,right:39,down:40,"*":106,"+":107,plus:107,"-":109,minus:109,";":186,"=":187,",":188,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},g;for(g=0;g<10;g++)f["num-"+g]=g+95;for(g=0;g<10;g++)f[g.toString()]=g+48;for(g=1;g<25;g++)f["f"+g]=g+111;for(g=65;g<91;g++)f[String.fromCharCode(g).toLowerCase()]=g;var h={};for(var i in f){var j=f[i];if(!h[j]||h[j].length<i.length)h[j]=i}var k="",l={},r=[];return u.parse=m,u.stringify=n,u.bindings=l,u.setScope=function(a){k=a?a:""},u.getScope=function(){return k},u.pushScope=function(a){return k=(k?k+".":"")+a,k},u.popScope=function(a){var b;return a?(k=k.replace(new RegExp("(^|\\.)"+a+"(\\.|$).*"),""),a):(b=k.lastIndexOf("."),a=k.slice(b+1),k=k.slice(0,b),a)},window.addEventListener("keydown",s,!1),u})})(typeof define!="undefined"?define:function(a){window.keymage=a()});