/*!
 * The MIT License (MIT)
 * 
 * Copyright (c) 2015 Webcom
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Reach=t():e.Reach=t()}(this,function(){return function(e){function t(o){if(n[o])return n[o].exports;var c=n[o]={exports:{},id:o,loaded:!1};return e[o].call(c.exports,c,c.exports,t),c.loaded=!0,c.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Reach=void 0;var c=n(14),a=o(c),i=n(15),r=o(i),d=n(7),s=(o(d),n(2)),u=o(s),l=n(8),f=o(l),h=n(9),m=o(h),v=n(10),b=o(v),p=n(12),S=o(p),g=t.Reach=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?"http://webcom.orange.com/base/webrtc":arguments[0];(0,a["default"])(this,e),this.datarefs=(0,f["default"])(t),this.webrtcmngr=(0,S["default"])(this.datarefs)}return(0,r["default"])(e,[{key:"Room",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return b["default"].apply(void 0,t.concat([this.datarefs,this.webrtcmngr]))}},{key:"Reach",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return m["default"].apply(void 0,t.concat([this.datarefs]))}}],[{key:"version",get:function(){return"1.0.3"}},{key:"actions",get:function(){return u["default"]}}]),e}();e.exports=g},function(e,t){var n=e.exports={version:"1.2.6"};"number"==typeof __e&&(__e=n)},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t["default"]={ACTION_TYPE_AUDIO:"audio",ACTION_TYPE_VIDEO:"video",ACTION_TYPE_CHAT:"chat",ACTION_TYPE_AUDIO_VIDEO:"audio-video",ACTION_TYPE_SCREEN_SHARING:"screen-sharing",ACTION_TYPE_CALL:"call"}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){console.log("(ReachSDK::localstream::initVideo)"),b||(b=!0,navigator.getMedia=getUserMedia,h=document.createElement("VIDEO"),h.muted=!0,c.push(h),null===r?navigator.getMedia({audio:!1,video:!0},function(t){r=t,c.forEach(function(e){attachMediaStream(e,r)}),c=[],u.forEach(function(e){e(r)}),u=[],b=!1,e&&e()},function(t){console.error("Error on webrtcLocalStream - webkitGetUserMedia : error="),console.dir(t),b=!1,e&&e(t)}):(c.forEach(function(e){attachMediaStream(e,r)}),c=[],u.forEach(function(e){e(r)}),u=[],b=!1))}function t(e){console.log("(ReachSDK::localstream::initAudio)"),p||(p=!0,navigator.getMedia=getUserMedia,m=document.createElement("AUDIO"),m.muted=!0,a.push(m),null===d?navigator.getMedia({audio:!0,video:!1},function(t){d=t,a.forEach(function(e){attachMediaStream(e,d)}),a=[],l.forEach(function(e){e(d)}),l=[],p=!1,e&&e()},function(t){console.error("Error on webrtcLocalStream - webkitGetUserMedia :error="),console.dir(t),p=!1,e&&e(t)}):(a.forEach(function(e){attachMediaStream(e,d)}),a=[],l.forEach(function(e){e(d)}),l=[],p=!1))}function n(e){console.log("(ReachSDK::localstream::initAudioVideo)"),S||(S=!0,navigator.getMedia=getUserMedia,v=document.createElement("AUDIOVIDEO"),v.muted=!0,i.push(v),null===s?navigator.getMedia({audio:!0,video:!0},function(t){s=t,i.forEach(function(e){attachMediaStream(e,s)}),i=[],f.forEach(function(e){e(s)}),f=[],S=!1,e&&e()},function(t){console.error("(ReachSDK::localstream::initAudioVideo::Error on webrtcLocalStream - webkitGetUserMedia : error="),console.dir(t),S=!1,e&&e(t)}):(i.forEach(function(e){attachMediaStream(e,s)}),i=[],f.forEach(function(e){e(s)}),f=[],S=!1))}function o(){console.log("(ReachSDK::localstream::close)"),h&&(detachMediaStream(h),h=null),s&&(s.stop(),s=null),r&&(r.stop(),r=null),b=!1,m&&(detachMediaStream(m),m=null),d&&(d.stop(),d=null),p=!1,v&&(detachMediaStream(v),v=null),s&&(s.stop(),s=null),S=!1}var c=[],a=[],i=[],r=null,d=null,s=null,u=[],l=[],f=[],h=null,m=null,v=null,b=!1,p=!1,S=!1;return{getVideoStream:function(){return r},addVideoListener:function(e){u.push(e)},initVideo:function(){e()},connectLocalVideoStream:function(t,n,o){t?(t.muted=!0,r?(console.log("(ReachSDK::localstream::connectLocalVideoStream)use existing streamVideo"),attachMediaStream(t,r),o&&"function"==typeof o&&o(r)):(c.push(t),o&&"function"==typeof o&&u.push(o),e(n))):r?o&&"function"==typeof o&&o(r):(o&&"function"==typeof o&&u.push(o),e(n))},getAudioStream:function(){return d},addAudioListener:function(e){l.push(e)},initAudio:function(){t()},connectLocalAudioStream:function(e,n,o){e?(e.muted=!0,d?(console.log("(ReachSDK::localstream::connectLocalAudioStream)use existing streamAudio"),attachMediaStream(e,d),o&&"function"==typeof o&&o(d)):(a.push(e),o&&"function"==typeof o&&l.push(o),t(n))):d?o&&"function"==typeof o&&o(d):(o&&"function"==typeof o&&l.push(o),t(n))},getAudioVideoStream:function(){return s},addAudioVideoListener:function(e){f.push(e)},initAudioVideo:function(){n()},connectLocalAudioVideoStream:function(e,t,o){e?(e.muted=!0,s?(console.log("(ReachSDK::localstream::connectLocalAudioVideoStream)use existing streamAudioVideo"),attachMediaStream(e,s),o&&o(s)):(i.push(e),o&&"function"==typeof o&&f.push(o),n(t))):s?o&&o(s):(o&&"function"==typeof o&&f.push(o),n(t))},close:function(){o()}}}();t["default"]=n},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function t(){return""+e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var n=t();return{appInstanceId:n}}();t["default"]=n},function(e,t,n){e.exports={"default":n(16),__esModule:!0}},function(e,t,n){e.exports={"default":n(18),__esModule:!0}},function(e,t){"use strict";function n(e){e.hasOwnProperty("urls")&&(e.url=e.urls,delete e.urls),e.hasOwnProperty("url")&&e.url.toLowerCase().startsWith("turns")&&navigator.mozGetUserMedia&&console.warn("(ReachSDK::maybeFixConfiguration) turns detected on firefox -> ignore this entry")}function o(e){if(null!==e&&e.iceServers&&e.iceServers.length>0){for(var t=[],o=e.iceServers.length-1;o>=0;o--){var c=e.iceServers[o];n(c),t.push(c)}e.iceServers=t}}function c(e,t,n){var o=arguments.length<=3||void 0===arguments[3]?!1:arguments[3],c=void 0;if(o){var a=e.split("?");(1===a.length||0===a[1].indexOf("transport=udp"))&&(c={url:a[0],credential:n,username:t})}else c={url:e,credential:n,username:t};return c}if(window.RTCPeerConnection=null,window.getUserMedia=null,window.attachMediaStream=null,window.reattachMediaStream=null,window.webrtcDetectedBrowser=null,window.webrtcDetectedVersion=null,navigator.mozGetUserMedia)window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),window.RTCPeerConnection=function(e,t){return o(e),new mozRTCPeerConnection(e,t)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,window.getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,window.createIceServer=function(e,t,n){var o=null,a=e.split(":");return 0===a[0].indexOf("stun")?o={url:e}:0===a[0].indexOf("turn")&&(o=c(e,t,n,window.webrtcDetectedVersion<27)),o},window.createIceServers=function(e,t,n){for(var o=[],c=0;c<e.length;c++){var a=window.createIceServer(e[c],t,n);null!==a&&o.push(a)}return o},window.detachMediaStream=function(e){e&&(e.mozSrcObject=null,e.pause())},window.attachMediaStream=function(e,t){try{e&&t?(e.mozSrcObject=t,e.play&&"function"==typeof e.play?e.play():console.warn("(ReachSDK::attachMediaStream)element.play not available")):console.error("ReachSDK::attachMediaStream->parameters not valid")}catch(n){console.error("(ReachSDK::attachMediaStream)Exception="+n)}},window.reattachMediaStream=function(e,t){e&&t?(e.mozSrcObject=t.mozSrcObject,e.play()):console.error("ReachSDK::reattachMediaStream->parameters not valid")},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]});else{if(!navigator.webkitGetUserMedia)throw new Error("Browser does not appear to be WebRTC-capable");window.webrtcDetectedBrowser="chrome",window.webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),window.createIceServer=function(e,t,n){var o=null,a=e.split(":");return 0===a[0].indexOf("stun")?o={url:e}:0===a[0].indexOf("turn")&&(o=c(e,n,t)),o},window.createIceServers=function(e,t,n){var o=[];if(window.webrtcDetectedVersion>=34)o={urls:e,credential:n,username:t};else for(var c=0;c<e.length;c++){var a=window.createIceServer(e[c],t,n);null!==a&&o.push(a)}return o},window.RTCPeerConnection=function(e,t){return window.webrtcDetectedVersion<34&&o(e),new webkitRTCPeerConnection(e,t)},window.getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,window.attachMediaStream=function(e,t){try{e&&t?(e.src=URL.createObjectURL(t),e.autoplay=!0):console.error("ReachSDK::attachMediaStream ->parameters not valid")}catch(n){console.error("(ReachSDK::attachMediaStream)Exception="+n)}},window.detachMediaStream=function(e){e&&("undefined"!=typeof e.srcObject?e.srcObject="":"undefined"!=typeof e.mozSrcObject?e.mozSrcObject="":"undefined"!=typeof e.src?e.src="":console.log("Error attaching stream to element."))},window.reattachMediaStream=function(e,t){e&&t?e.src=t.src:console.error("ReachSDK::reattachMediaStream media stream->parameters not valid")}}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=function(e){function t(){b=v.child("roomsList"),p=v.child("reach"),S=v.child("webrtc"),g=v.child("sipPhoneNumbers")}function n(){v=new Webcom(e),t()}function o(e){v=new Webcom(e),t()}function c(){return v?v.toString():void 0}function a(e){v=e,t()}function i(){return v}function r(e){b=e}function d(){return b}function s(e){p=e}function u(){return p}function l(e){S=e}function f(){return S}function h(e){g=e}function m(){return g}var v=null,b=null,p=null,S=null,g=null;return n(),{setWebcomBaseUrl:o,getWebcomBaseUrl:c,setDatastore:a,getDatastore:i,setRooms:r,getRooms:d,setReach:s,getReach:u,setWebrtc:l,getWebrtc:f,setSipPhoneNumbers:h,getSipPhoneNumbers:m}}},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var c=n(6),a=o(c),i=n(5),r=o(i),d=n(4),s=o(d),u="ONGOING",l="ACCEPTED",f="REJECTED",h="CANCELED",m="CONNECTED",v="OPEN",b=function(e,t){function n(){j=O.child("userList/"+M+"/connectedList/"+s["default"].appInstanceId),j.onDisconnect().remove(),j.child("status").set(m);try{!function(){var e=j.child("description");s["default"].appInstanceId&&e.child("appInstanceId").set(s["default"].appInstanceId);var t={},n=["appCodeName","appName","appVersion","buildID","cookieEnabled","language","onLine","oscpu","platform","product","productSub","securityPolicy","userAgent","vendor","vendorSub"];n.forEach(function(e){navigator[e]&&(t[e]=navigator[e])}),e.child("navigator").set(t)}()}catch(e){console.error("(ReachSDK::reach::init)failed to get information about device. error="+e)}O.child("userList/"+M+"/wasInsideReach").set(!0)}function o(e,t){console.log("(ReachSDK::reach::_isConnected)userId: "+e),O.child("userList/"+e+"/connectedList").once("value",function(e){t&&"function"==typeof t&&t(null!==e.val())})}function c(e,t){console.log("(ReachSDK::reach::_isRegistered)userId: "+e),O.child("userList/"+e+"/wasInsideReach").once("value",function(e){t&&"function"==typeof t&&t(null!==e.val())})}function i(e){j&&j.child("status").set(e)}function d(e){E&&(O.child("userList").off("child_added",E),E=null),e&&"function"==typeof e&&(E=function(t){console.log("(ReachSDK::reach::onUserAddedCb) "+t.name()+"="+(0,r["default"])(t.val()));var n={};n[t.name()]=t.val(),e(n)},O.child("userList").on("child_added",E))}function b(e){T&&(O.child("userList").off("child_changed",T),T=null),e&&"function"==typeof e&&(T=function(t){console.log("(ReachSDK::reach::onUserChangedCb) "+t.name()+"="+(0,r["default"])(t.val()));var n={};n[t.name()]=t.val(),e(n)},O.child("userList").on("child_changed",T))}function p(e){L&&(O.child("userList").off("child_removed",L),L=null),e&&"function"==typeof e&&(L=function(t){console.log("(ReachSDK::reach::onUserRemovedCb) "+t.name()+"="+(0,r["default"])(t.val()));var n={};n[t.name()]=t.val(),e(n)},O.child("userList").on("child_removed",L))}function S(e){P&&(O.child("invitationList/"+M).off("child_added",P),P=null),e&&"function"==typeof e&&(P=function(t){t.val().status===u&&!function(){console.log("(ReachSDK::reach::_setOnNewRoomInvitation)new Invite received,id) "+t.name()+",content="+(0,r["default"])(t.val()));var n=t.name();x||(x=[]),x[n]&&(x[n].timeout&&clearTimeout(x[n].timeout),delete x[n]),x[n]={};var o={};o[n]=t.val(),e(o);var c=O.child("invitationList/"+M+"/"+n);N&&(x[n].timeout=setTimeout(function(){N&&(console.log("(ReachSDK::reach::_setOnNewRoomInvitation)automatic reject of Invite received="+(0,r["default"])(t.val())),c.onDisconnect().cancel(),U?c.update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:f,status_info:U}):c.update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:f}))},N)),c.once("child_changed",function(e){e&&"status"===e.name()&&e.ref().parent().once("value",function(t){var n=void 0,o=void 0;if(t){n=e.ref().parent().name(),o=t.val();var c={};c[n]=o,x&&x[n]&&x[n].timeout&&clearTimeout(x[n].timeout),console.log("(ReachSDK::reach::_setOnNewRoomInvitation)Invite changed,id=) "+n+", new content="+(0,r["default"])(o)),c&&V&&V(c),delete x[n]}})})}()},O.child("invitationList/"+M).on("child_added",P))}function g(e){V&&(V=null),e&&"function"==typeof e&&(V=e)}function I(e,t){N&&(N=null),U&&(U=null),e&&e===parseInt(e,10)&&e>0&&(console.log("(ReachSDK::reach::_setNewRoomInvitationTimeout)timeout="+e),N=e),t&&(U=t)}function w(e,n,o){return console.log("(ReachSDK::reach::_isUserPresentInRoom)p_roomId="+e+" p_user="+n),e&&"string"==typeof e?n&&"string"==typeof n?o&&"function"==typeof o?void t.getRooms().child(e+"/participantList/"+n+"/wasInsideRoom").once("value",function(t){var c=null!==t.val();console.log("(ReachSDK::reach::_isUserPresentInRoom)p_roomId="+e+",p_user="+n+",result="+c),o(c,e,n)}):void console.error("(ReachSDK::reach::_isUserPresentInRoom)parameter p_cb is incorrect. if defined, expecting a function"):void console.error("(ReachSDK::reach::_isUserPresentInRoom)parameter p_user is incorrect. Expecting non empty string"):void console.error("(ReachSDK::reach::_isUserPresentInRoom)parameter p_roomid is incorrect. Expecting non empty string")}function _(e,t,n){return e&&"string"==typeof e?t&&!t instanceof Array?void console.error("(ReachSDK::reach::_cancelInvitation)parameter p_guestIds is incorrect. Expecting an Array"):(console.log(" (ReachSDK::reach::_cancelInvitation)p_roomId="+e+", p_guestIds="+(0,r["default"])(t)),void(W&&W[e]?t?t.forEach(function(t,o){t&&"string"==typeof t?W[e][t]?W[e][t].InviteDataref?(W[e][t].InviteDataref.onDisconnect().cancel(),W[e][t].InviteChangedCb&&"function"==typeof W[e][t].InviteChangedCb&&W[e][t].InviteDataref.off("child_changed",W[e][t].InviteChangedCb),W[e][t].InviteDataref.once("value",function(o){var c=void 0,a=void 0,i=void 0;o&&o.val()&&(c=o.val().status,i=o.val().room,a=o.ref().parent().name(),c&&c===u?(W[i][a].InviteDataref.update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:h}),W[i][a].statusChangedCb&&"function"==typeof W[i][a].statusChangedCb&&W[i][a].statusChangedCb(i,a,h),console.log("(ReachSDK::reach::_cancelInvitation)deleting Invite to room "+i+" for invitee "+a)):console.warn("(ReachSDK::reach::_cancelInvitation)cannot delete intivation to room "+i+" for guest "+a+" Invitation has been removed/rejected/accepted")),delete W[e][t],n&&"function"==typeof n&&n(t)})):(delete W[e][t],n&&"function"==typeof n&&n(t)):n&&"function"==typeof n&&n(t):console.error("(ReachSDK::reach::inviteToRoom)parameter p_guestIds["+o+"] is incorrect. Expecting non empty string")}):(0,a["default"])(W[e]).forEach(function(t){_(e,[t],n)}):console.warn("(ReachSDK::reach::_cancelInvitation) Invite to room "+e+" not found"))):void console.error("(ReachSDK::reach::_cancelInvitation)parameter p_roomid is incorrect. Expecting non empty string")}function R(e,n,o,c){if(!e||"string"!=typeof e)return void console.error("(ReachSDK::reach::inviteToRoom)parameter p_roomid is incorrect. Expecting non empty string");if(!o||"string"!=typeof o)return void console.error("(ReachSDK::reach::inviteToRoom)parameter p_topic is incorrect. Expecting non empty string");if(c&&"function"!=typeof c&&console.warn("(ReachSDK::reach::inviteToRoom)parameter p_statusChangedCb is incorrect. if defined, expecting a function"),!(n&&n instanceof Array))return void console.error("(ReachSDK::reach::inviteToRoom)parameter p_guestIds is incorrect. Expecting an Array");t.getRooms().child(e).child("commonDataList").update({status:v,owner:M});var a=function(e,n,o){e||t.getRooms().child(n+"/participantList/"+o).update({connected:!1,wasInsideRoom:!1})},i=function(t){if(console.log("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)"),t&&"status"===t.name()){var n=t.ref().parent().parent().name();console.log("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)cb_guestId2="+n),W&&W[e]&&W[e][n]&&W[e][n].InviteChangedCb&&W[e][n].InviteDataref.off("child_changed",W[e][n].InviteChangedCb),t.ref().parent().once("value",function(e){var t=void 0,n=void 0,o=void 0,c=void 0;e?(t=e.val().status,o=e.val().room,c=e.val().status_info,n=e.ref().parent().name(),console.log("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)roomId="+o+" invitee="+n+" new invitation status="+t+" status info="+c),W&&W[o]&&W[o][n]&&W[o][n].InviteDataref?(W[o][n].InviteDataref.onDisconnect().cancel(),W[o][n].statusChangedCb&&"function"==typeof W[o][n].statusChangedCb?W[o][n].statusChangedCb(o,n,t,c):console.warn("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)cannot retrieve mathing p_statusChangedCb"),delete W[o][n]):console.warn("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)cannot retrieve mathing mOutgoingInvite")):console.warn("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)cannot retrieve invitation")})}};n.forEach(function(t,n){if(t&&"string"==typeof t){if(console.log("(ReachSDK::reach::inviteToRoom)roomId="+e+" invitee="+t.toString()),W[e]&&W[e][t])return void _(e,[t],function(n){n&&n===t&&R(e,[n],o,c)});W[e]||(W[e]=[]),W[e][t]={},w(e,t,a),W[e][t].InviteDataref=O.child("invitationList").child(t).push({from:M,room:e,timestamp_creation:Webcom.ServerValue.TIMESTAMP,topic:o,status:u}),console.log("(ReachSDK::reach::inviteToRoom)InviteDataref="+W[e][t].InviteDataref.toString()),W[e][t].InviteChangedCb=i,W[e][t].InviteDataref.on("child_changed",W[e][t].InviteChangedCb),W[e][t].statusChangedCb=c,W[e][t].InviteDataref.onDisconnect().update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:h})}else console.error("(ReachSDK::reach::inviteToRoom)parameter p_guestIds["+n+"] is incorrect. Expecting non empty string")})}function D(e){var t=(0,a["default"])(e)[0];return t?e[t]?void O.child("invitationList/"+M+"/"+t).once("value",function(n){var o=void 0,c=void 0,a=void 0;n&&n.val()&&(a=n.name(),o=n.val().status,c=n.ref().parent().name(),o&&o===u?(console.log("(ReachSDK::reach::_acceptInvitation)inviteId="+t+",data="+(0,r["default"])(e[t])),O.child("invitationList/"+c+"/"+a).update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:l})):console.warn("(ReachSDK::reach::_acceptInvitation)inviteId="+a+",data="+(0,r["default"])(e[t])+", cannot be accepted. It has been removed or canceled"))}):void console.error("(ReachSDK::reach::_acceptInvitation)parameter p_invitation is incorrect. cannot get invitation data"):void console.error("(ReachSDK::reach::_acceptInvitation)parameter p_invitation is incorrect. cannot get invitation Id")}function y(e,t){var n=(0,a["default"])(e)[0];return n?e[n]?void O.child("invitationList/"+M+"/"+n).once("value",function(o){var c=void 0,a=void 0,i=void 0;o&&o.val()&&(i=o.name(),c=o.val().status,a=o.ref().parent().name(),c&&c===u?(console.log("(ReachSDK::reach::_rejectInvitation)inviteId="+n+",data="+(0,r["default"])(e[n])),t?O.child("invitationList/"+a+"/"+i).update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status_info:t,status:f}):O.child("invitationList/"+a+"/"+i).update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:f})):console.warn("(ReachSDK::reach::_rejectInvitation)inviteId="+i+",data="+(0,r["default"])(e[n])+", cannot be rejected. It has been removed or canceled"))}):void console.error("(ReachSDK::reach::_rejectInvitation)parameter p_invitation is incorrect. cannot get invitation data"):void console.error("(ReachSDK::reach::_rejectInvitation)parameter p_invitation is incorrect. cannot get invitation Id")}function K(e,n){e&&n&&"function"==typeof n&&!function(){var o=(0,a["default"])(e)[0];console.log("(ReachSDK::reach::_isRoomActive)inviteId="+o);var c=e[o].room;t.getRooms().child(c+"/commonDataList/status").once("value",function(e){var t=e&&e.val()&&e.val()===v;console.log("(ReachSDK::reach::_isRoomActive)inviteId="+o+" result="+t),n(t)})}()}function k(e,t){console.log("(ReachSDK::reach::_archiveInvitations)userId="+e),O.child("invitationList/"+M).once("value",function(n){n&&n.hasChildren()?!function(){var o=n.numChildren(),c=0;n.forEach(function(n){if(n&&n.val())if(console.log("(ReachSDK::reach::_archiveInvitations)userId="+e+" inviteId="+n.name()),n.val().status===f||n.val().status===h)O.child("invitationListHistory/"+e+"/"+n.name()).update(n.val()),n.ref().remove(),c++,c>=o&&t&&"function"==typeof t&&t();else{var a={};a[n.name()]=n.val(),K(a,function(a){if(a)c++,c>=o&&t&&"function"==typeof t&&t();else{if(n.val().status===u){var i=n.val();i.status=h,O.child("invitationListHistory/"+e+"/"+n.name()).set(i)}else O.child("invitationListHistory/"+e+"/"+n.name()).set(n.val());n.ref().remove(),c++,c>=o&&t&&"function"==typeof t&&t()}})}else t&&"function"==typeof t&&t()})}():t&&"function"==typeof t&&t()})}function A(){console.log("(ReachSDK::reach::_close)"),P&&(O.child("invitationList").child(M).off("child_added",P),P=null),E&&(O.child("userList").off("child_added",E),E=null),T&&(O.child("userList").off("child_changed",T),T=null),L&&(O.child("userList").off("child_removed",L),L=null),W&&(W.forEach(function(e){W[e].forEach(function(e){e.InviteDataref&&(e.InviteDataref.onDisconnect().cancel(),e.InviteDataref.update({status:h,timestamp_end:Webcom.ServerValue.TIMESTAMP}))})}),W=[]),N&&(N=null),U&&(U=null),j&&(j.remove(),j=null)}var C=this,M=e,O=t.getReach(),E=null,T=null,L=null,P=null,V=null,W=[],x=[],N=null,U=null,j=null;return n(),{getMe:function(){return M},isConnected:o,isRegistered:c,setConnectedStatus:i,setOnUserAdded:d,setOnUserChanged:b,setOnUserRemoved:p,inviteToRoom:R,cancelInvitation:_,setOnNewRoomInvitation:S,setOnRoomInvitationChanged:g,setNewRoomInvitationTimeout:I,archiveMyInvitations:function(e){return k(M,e)},acceptInvitation:D,rejectInvitation:y,on:function(e,t){switch(e){case"newRoomInvitation":C.setOnNewRoomInvitation(t);break;case"roomInvitationChanged":C.setOnRoomInvitationChanged(t);break;case"userAdded":C.setOnUserAdded(t);break;case"userChanged":C.setOnUserChanged(t);break;case"userRemoved":C.setOnUserRemoved(t);break;default:return console.error("reach.set: no such event"),-1}},close:A}};t["default"]=b},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=function(e,t,n,o){function c(e){console.log("(ReachSDK::room["+L+"]::_addAvailableStream)data="+(0,r["default"])(e)),x.push(e)}function i(e){if(console.log("(ReachSDK::room["+L+"]::_removeAvailableStream)streamId="+e),x&&e)for(var t=x.length-1;t>=0;t--)x[t]&&(0,a["default"])(x[t])[0]&&(0,a["default"])(x[t])[0]===e&&delete x[t]}function d(){G||(G=function(e){var t={},n=e.name(),o=e.val();console.log("(ReachSDK::room["+L+"]::onPublishedStreamForAvailableStream)stream="+(0,r["default"])(o)),t[n]=o,t[n].roomId=L,c(t)},V.child("publishedMediaList").on("child_added",G)),J||(J=function(e){var t=e.name();console.log("(ReachSDK::room["+L+"]::onUnPublishedStreamForAvailableStream)stream="+t),i(t)},V.child("publishedMediaList").on("child_removed",J))}function u(){V.child("participantList/"+P).update({connected:!0,wasInsideRoom:!0}),V.child("participantList/"+P+"/connected").onDisconnect().set(!1),d()}function f(){return L}function v(){return P}function b(e){var t=V.child("participantList");B&&(t.off("child_added",B),B=null),H&&(t.off("child_changed",H),H=null),e&&"function"==typeof e?(B=function(t){var n=t.name();t.val()&&t.val().connected&&t.val().wasInsideRoom&&(console.log("(ReachSDK::room["+L+"]::_setOnParticipantJoin) user has joined: "+n),e(n))},t.on("child_added",B),H=function(t){var n=t.name();t.val()&&t.val().connected&&t.val().wasInsideRoom&&(console.log("(ReachSDK::room["+L+"]::_setOnParticipantJoin) user has joined: "+n),e(n))},t.on("child_changed",H)):console.error("(ReachSDK::room["+L+"]::_setOnParticipantJoin)parameter incorrect. Expected function")}function p(e){$&&(V.child("participantList").off("child_changed",$),$=null),e&&"function"==typeof e?($=function(t){var n=t.name();t.val()&&!t.val().connected&&t.val().wasInsideRoom&&(console.log("(ReachSDK::room["+L+"]::_setOnParticipantLeave) user has left: "+n),e(n))},V.child("participantList").on("child_changed",$)):console.error("(ReachSDK::room["+L+"]::_setOnParticipantLeave)parameter incorrect. Expected function")}function S(e){""!==e&&(console.log("(ReachSDK::room["+L+"]::sendInstantMessage)message="+e),V.child("instantMessageList").push({from:P,message:e,timestamp:Webcom.ServerValue.TIMESTAMP}))}function g(e){Y&&(V.child("instantMessageList").off("child_added",Y),Y=null),e&&"function"==typeof e?(Y=function(t){var n=t.val();console.log("(ReachSDK::room["+L+"]::_setOnInstantMessage)receive InstantMessage="+(0,r["default"])(n)),e(n)},V.child("instantMessageList").on("child_added",Y)):console.error("(ReachSDK::room["+L+"]::_setOnInstantMessage)parameter incorrect. Expected function")}function I(e,t,n,c){if(console.log("(ReachSDK::room["+L+"]::publishStream)roomId="+L+",streamId="+e+",me="+P+",actionType="+n),!e||"string"!=typeof e)return void console.error("(ReachSDK::reach::inviteToRoom)parameter streamId is incorrect. Expecting non empty string");var a=V.child("publishedMediaList").child(e),i=a.child("subscribersList"),d=function(){a.set({from:P,appInstanceId:h["default"].appInstanceId,actionType:n}),a.onDisconnect().remove();var c=function(c){var a=c.name(),i=c.val(),d=i.userId,s=i.peercoId,u=i.peercoRef,l=U[e]&&U[e].audio,f=U[e]&&U[e].video,h=e+"_pub";console.log("(ReachSDK::room["+L+"]::publishStream::addSubscribersListCb)subscriber "+d+" to stream "+e+" added "+(0,r["default"])(i)),W[h]||(W[h]=[]);var m=o.createWebrtc(t,a,function(){console.log("(ReachSDK::room["+L+"]::publishStream::addSubscribersListCb)subscriber "+d+" to stream "+e+" connection lost")},!0,n,s,u,l,f);W[h].push({stackId:m,subscriberId:d,isPublish:!0,peercoId:s,peercoRef:u})},d=function(t){var n=t.name(),c=W[e+"_pub"];if(n&&c){console.log("(ReachSDK::room["+L+"]::publishStream::removeSubscribersListCb)subscriber "+n+" to stream "+e+" removed");for(var a=c.length-1;a>=0;a--)c[a].subscriberId===n&&o.closeWebrtc(c[a].stackId,!0);delete W[e+"_pub"]}};N[e]={addSubscribersListCb:c,removeSubscribersListCb:d},i.on("child_added",c),i.on("child_removed",d)};n&&(n===s["default"].ACTION_TYPE_VIDEO?l["default"].connectLocalVideoStream(t,d,c):n===s["default"].ACTION_TYPE_AUDIO?l["default"].connectLocalAudioStream(t,d,c):n===s["default"].ACTION_TYPE_AUDIO_VIDEO&&l["default"].connectLocalAudioVideoStream(t,d,c))}function w(e){F&&(V.child("publishedMediaList").off("child_added",F),F=null),e&&"function"==typeof e?(F=function(t){var n={},o=t.name();n[o]=t.val(),n[o].roomId=L,e(n)},V.child("publishedMediaList").on("child_added",F)):console.error("(ReachSDK::room["+L+"]::_setOnPublishedStream)parameter incorrect. Expected function")}function _(e,t){console.log("(ReachSDK::room["+L+"]::unPublishStream)streamId "+e);var n=V.child("publishedMediaList/"+e),c=n.child("subscribersList"),a=e+"_pub";N[e]&&N[e].addSubscribersListCb&&c.off("child_added",N[e].addSubscribersListCb),N[e]&&N[e].removeSubscribersListCb&&c.off("child_removed",N[e].removeSubscribersListCb),delete N[e],delete U[e],n.onDisconnect().cancel(),n.remove(),W[a]&&W[a].length>0?!function(){for(var e=W[a].length,n=function(){e--,1>e&&(delete W[a],t&&"function"==typeof t&&t())},c=e-1;c>=0;c--)o.closeWebrtc(W[a][c].stackId,!0,n)}():(delete W[a],t&&"function"==typeof t&&t())}function R(e){z&&(V.child("publishedMediaList").off("child_removed",z),z=null),e&&"function"==typeof e?(z=function(t){e(t.name())},V.child("publishedMediaList").on("child_removed",z)):console.error("(ReachSDK::room["+L+"]::_setOnUnPublishedStream)parameter incorrect. Expected function")}function D(e,t,c){var i=(0,a["default"])(e)[0],r=e[i].actionType;if(console.log("(ReachSDK::room["+L+"]::subscribeToStream)streamId "+i),N&&N[i])return r&&(r===s["default"].ACTION_TYPE_VIDEO?l["default"].connectLocalVideoStream(t,c):r===s["default"].ACTION_TYPE_AUDIO?l["default"].connectLocalAudioStream(t,c):r===s["default"].ACTION_TYPE_AUDIO_VIDEO&&l["default"].connectLocalAudioVideoStream(t,c)),i;var d=e[i].appInstanceId,u=V.child("publishedMediaList").child(i),f=u.child("subscribersList"),m=i+"_sub",v=void 0,b=void 0;W[m]?W[m]&&W[m][0]&&W[m][0].peercoId&&(v=W[m][0].peercoId):W[m]=[];var p=function(e,t){return Math.floor(Math.random()*(t-e+1))+e};v||(v=Math.floor(Date.now()).toString()+p(0,1e6)),b=n.getWebrtc().push().name(),f.child(h["default"].appInstanceId).set({ts:Webcom.ServerValue.TIMESTAMP,userId:P,peercoId:v,peercoRef:b});var S=U[i]&&U[i].audio,g=U[i]&&U[i].video,I=o.createWebrtc(t,d,function(){},!1,r,v,b,S,g,c);return j||(j=function(e){var t=(0,a["default"])(e)[0]+"_sub";if(W[t]){for(var n=0;n<W[t].length;)o.closeWebrtc(W[t][n].stackId,!1),n++;delete W[t]}},V.child("publishedMediaList").on("child_removed",j)),W[m].push({stackId:I,isPublish:!1,peercoId:v,peercoRef:b}),i}function y(e){console.log("(ReachSDK::room["+L+"]::unSubscribeFromStream)streamId "+e);var t=V.child("publishedMediaList").child(e),n=t.child("subscribersList"),c=e+"_sub";if(n.child(h["default"].appInstanceId).remove(),W[c]){for(var a=0;a<W[c].length;)W[c][a]&&o.closeWebrtc(W[c][a].stackId,!1),a++;delete W[c]}delete U[e]}function K(){return console.log("(ReachSDK::room["+L+"]::_getAvailableStreams)"),x}function k(e){if(console.log("(ReachSDK::room["+L+"]::_getAvailableStream)streamId="+e),x&&e)for(var t=x.length-1;t>=0;t--)if(x[t]&&(0,a["default"])(x[t])[0]&&(0,a["default"])(x[t])[0]===e)return x[t];return null}function A(){console.log("(ReachSDK::room["+L+"]::_removeAllAvailableStreams"),x=[]}function C(e){return e&&"string"==typeof e?(console.log("(ReachSDK::room["+L+"]::_muteAudioStream)streamId="+e),U[e]||(U[e]={}),U[e].audio=!0,void(W&&[W[e+"_pub"],W[e+"_sub"]].forEach(function(e){if(e&&e.length>0)for(var t=e.length-1;t>=0;t--)o.muteAudioWebrtcStack(e[t].stackId)}))):void console.error("(ReachSDK::room["+L+"]::_muteAudioStream)parameter streamId is incorrect. Expecting non empty string")}function M(e){return e&&"string"==typeof e?(U[e]&&U[e].audio&&(U[e].audio=!1),console.log("(ReachSDK::room["+L+"]::_unmuteAudioStream)streamId="+e),void(W&&[W[e+"_pub"],W[e+"_sub"]].forEach(function(e){if(e&&e.length>0)for(var t=e.length-1;t>=0;t--)o.unmuteAudioWebrtcStack(e[t].stackId)}))):void console.error("(ReachSDK::room["+L+"]::_unmuteAudioStream)parameter streamId is incorrect. Expecting non empty string")}function O(e){return e&&"string"==typeof e?(console.log("(ReachSDK::room["+L+"]::_muteVideoStream)streamId="+e),U[e]||(U[e]={}),U[e].video=!0,void(W&&[W[e+"_pub"],W[e+"_sub"]].forEach(function(e){if(e&&e.length>0)for(var t=e.length-1;t>=0;t--)o.muteVideoWebrtcStack(e[t].stackId)}))):void console.error("(ReachSDK::room["+L+"]::_muteVideoStream)parameter streamId is incorrect. Expecting non empty string")}function E(e){return e&&"string"==typeof e?(U[e]&&U[e].video&&(U[e].video=!1),
console.log("(ReachSDK::room["+L+"]::_unmuteVideoStream)streamId="+e),void(W&&[W[e+"_pub"],W[e+"_sub"]].forEach(function(e){if(e&&e.length>0)for(var t=e.length-1;t>=0;t--)o.unmuteVideoWebrtcStack(e[t].stackId)}))):void console.error("(ReachSDK::room["+L+"]::_unmuteVideoStream)parameter streamId is incorrect. Expecting non empty string")}function T(e){console.log("(ReachSDK::room["+L+"]::_close)room "+L+", detroyRoom="+e);var t=V.child("participantList"),n=V.child("publishedMediaList");t.child(P+"/connected").set(!1),(0,a["default"])(N).forEach(_),N=[],Y&&(V.child("instantMessageList").off("child_added",Y),Y=null),F&&(n.off("child_added",F),F=null),G&&(n.off("child_added",G),G=null),z&&(n.off("child_removed",z),z=null),J&&(n.off("child_removed",J),J=null),B&&(t.off("child_added",B),B=null),H&&(t.off("child_changed",H),H=null),$&&(t.off("child_changed",$),$=null),j&&(n.off("child_removed",j),j=null),(0,a["default"])(W).forEach(function(e){W[e].forEach(function(e){e&&(o.closeWebrtc(e.stackId,e.isPublish),o.clearWebrtcStacks(e.stackId))})}),W={},U=[],A(),e&&e===!0&&V.child("commonDataList/status").set(m)}var L=t,P=e,V=n.getRooms().child(L),W={},x=[],N=[],U=[],j=null,Y=null,F=null,G=null,z=null,J=null,B=null,H=null,$=null;return u(),{getRoomId:f,getMe:v,setOnParticipantJoin:b,setOnParticipantLeave:p,sendInstantMessage:S,setOnInstantMessage:g,publishStream:I,setOnPublishedStream:w,unPublishStream:_,setOnUnPublishedStream:R,subscribeToStream:D,unSubscribeFromStream:y,getAvailableStreams:K,getAvailableStream:k,muteAudioStream:C,unmuteAudioStream:M,muteVideoStream:O,unmuteVideoStream:E,close:T,on:function(e,t){switch(e){case"instantMessage":g(t);break;case"publishedStream":w(t);break;case"unPublishedStream":R(t);break;case"participantJoin":b(t);break;case"participantLeave":p(t);break;default:console.err("(ReachSDK::room["+L+"]::on)unsupported "+e+" event")}}}};var c=n(6),a=o(c),i=n(5),r=o(i),d=n(2),s=o(d),u=n(3),l=o(u),f=n(4),h=o(f),m="CLOSE"},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var c=n(5),a=o(c),i=n(2),r=o(i),d=n(3),s=o(d),u="disconnected",l="connected",f="completed",h="checking",m="closed",v="failed",b="other",p={iceServers:[{url:"turns:turn1.webcom.orange.com:443",username:"admin",credential:"webcom1234"},{url:"turn:turn2.webcom.orange.com:443",username:"admin",credential:"webcom1234"},{url:"turns:turn3.webcom.orange.com:443",username:"admin",credential:"webcom1234"}]},S=function(e,t,n,o,c,i,d,S){function g(e){console.log("(ReachSDK::webrtc::)stackId="+N+"error="+e),console.dir(e)}function I(e,t){console.log("ReachSDK::webrtc::getIceServersConfigFromServer"),Y?Y.root().child("config").once("value",function(n){var o=n?n.val():null;o?"function"==typeof e&&e(o):"function"==typeof t&&t()},function(e){"function"==typeof t&&t(e)}):"function"==typeof t&&t()}function w(){F.child("iceCandidatesList").on("child_added",G)}function _(){F.child("iceCandidatesList").off("child_added",G)}function R(e,t){t&&t.forEach(function(t){t&&(t.enabled=e)})}function D(e){ue=e;var t=U&&ae?ae:!U&&ce?ce:null;t&&R(!ue,t.getAudioTracks())}function y(){console.log("(ReachSDK::webrtc::_muteAudio)stackId="+N),D(!0)}function K(){console.log("(ReachSDK::webrtc::_unmuteAudio)stackId="+N),D(!1)}function k(e){le=e;var t=U&&ae?ae:!U&&ce?ce:null;t&&R(!ue,t.getVideoTracks())}function A(){console.log("(ReachSDK::webrtc::_muteVideo)stackId="+N),k(!0)}function C(){console.log("(ReachSDK::webrtc::_unmuteVideo)stackId="+N),k(!1)}function M(e){if(console.log("(ReachSDK::webrtc::_initlocalStream)stackId="+N+" get local video stream and renders to local video"),q){var t=void 0;q===r["default"].ACTION_TYPE_VIDEO?(t=function(){console.log("(ReachSDK::webrtc::_initlocalStream)initlocalStream_video"),ae=s["default"].getVideoStream()&&s["default"].getVideoStream().clone&&"function"==typeof s["default"].getVideoStream().clone?s["default"].getVideoStream().clone():s["default"].getVideoStream(),ue&&y(),le&&A(),j.addStream(ae);for(var t=0;t<te.length;t++)console.log("(ReachSDK::webrtc::_initlocalStream)stackId="+N+" rendering local video to "+te[t].id),attachMediaStream(te[t],s["default"].getVideoStream());e&&"function"==typeof e&&e()},s["default"].getVideoStream()?t():(s["default"].addVideoListener(t),s["default"].initVideo())):q===r["default"].ACTION_TYPE_AUDIO?(t=function(){console.log("(ReachSDK::webrtc::_initlocalStream)initlocalStream_audio"),ae=s["default"].getAudioStream()&&s["default"].getAudioStream().clone&&"function"==typeof s["default"].getAudioStream().clone?s["default"].getAudioStream().clone():s["default"].getAudioStream(),ue&&y(),le&&A(),j.addStream(ae);for(var t=0;t<te.length;t++)console.log("(ReachSDK::webrtc::_initlocalStream)stackId="+N+" rendering local Audio to "+te[t].id),attachMediaStream(te[t],s["default"].getAudioStream());e&&"function"==typeof e&&e()},s["default"].getAudioStream()?t():(s["default"].addAudioListener(t),s["default"].initAudio())):q===r["default"].ACTION_TYPE_AUDIO_VIDEO&&(t=function(){console.log("(ReachSDK::webrtc::_initlocalStream)initlocalStream_audio_video"),ae=s["default"].getAudioVideoStream()&&s["default"].getAudioVideoStream().clone&&"function"==typeof s["default"].getAudioVideoStream().clone?s["default"].getAudioVideoStream().clone():s["default"].getAudioVideoStream(),ue&&y(),le&&A(),j.addStream(ae);for(var t=0;t<te.length;t++)console.log("(ReachSDK::webrtc::_initlocalStream)stackId="+N+" rendering local AudioVideo to "+te[t].id),attachMediaStream(te[t],s["default"].getAudioVideoStream());e&&"function"==typeof e&&e()},s["default"].getAudioVideoStream()?t():(s["default"].addAudioVideoListener(t),s["default"].initAudioVideo()))}else console.warn("(ReachSDK::webrtc::_initlocalStream)no actionType specified")}function O(){console.debug("(ReachSDK::webrtc::_initSdpCallbacks)stackId="+N),U?(z&&F.off("child_added",z),J=function(e){if(!ie&&"sdpAnswer"===e.name()){var t=e.val();console.debug("(ReachSDK::webrtc::sdpAnswerCb)stackId="+N+"-received sdpAnswer: "+(0,a["default"])(t)),j.setRemoteDescription(new Z(t),function(){console.debug("(ReachSDK::webrtc::sdpAnswerCb)stackId="+N+"-remote description set"),w()},g),F.off("child_added",J)}},F.on("child_added",J)):(J&&F.off("child_added",J),z=function(e){if(!ie&&"sdpOffer"===e.name()){var t=e.val();console.debug("(ReachSDK::webrtc::sdpOfferCb)stackId="+N+"-received sdpOffer: "+(0,a["default"])(t)),j.setRemoteDescription(new Z(t),function(){j.createAnswer(function(e){console.log("(ReachSDK::webrtc::sdpOfferCb)stackId="+N+"-sending answer"),j.setLocalDescription(e,function(){console.debug("(ReachSDK::webrtc::sdpOfferCb)stackId="+N+"-set sdpAnswer in base : "+(0,a["default"])(e)),Y.child("sdpAnswer").set(JSON.parse((0,a["default"])(e))),w()},g)},g,ve)},g),F.off("child_added",z)}},F.on("child_added",z))}function E(){J&&(F.off("child_added",J),J=null),z&&(F.off("child_added",z),z=null)}function T(){console.log("(webrtc::sendOffer)stackid="+N+"-creating sdpOffer"),j.createOffer(function(e){j.setLocalDescription(e,function(){console.debug("(ReachSDK::webrtc::createOffer)stackId="+N+"-set sdpOffer in base : "+(0,a["default"])(e)),Y.child("sdpOffer").set(JSON.parse((0,a["default"])(e)))},g)},g,me)}function L(e){if(re||ie)console.debug("(ReachSDK::webrtc::_close)stackId="+N+"-closing webrtc stack already in progress");else{re=!0,se=e,console.debug("(ReachSDK::webrtc::_close)stackId="+N+"-closing webrtc stack"),j&&j.close(),B&&(F.off("child_added",B),B=null),G&&(_(),G=null),E();for(var t=0;t<te.length;t++)te[t]&&(detachMediaStream(te[t]),console.debug("(ReachSDK::webrtc::_close)stackId="+N+"-stopping local video to "+te[t].id));for(var n=0;n<ne.length;n++)ne[n]&&(detachMediaStream(ne[n]),console.debug("(ReachSDK::webrtc::_close)stackId="+N+"-stopping remote vid to "+ne[n].id));ie=!0,console.debug("(ReachSDK::webrtc::_close)stackId="+N+"-closing webrtc stack -> waiting for ICE_CONNECTION_STATE_DISCONNECTED"),!ie||de!==u&&de!==m&&de!==v||(console.debug("(ReachSDK::webrtc::_close)stackId="+N+"-closed webrtc stack complete"),j=null,re=!1,x.clearWebrtcStacks($),se&&"function"==typeof se&&se())}}function P(e,t){q&&(q===r["default"].ACTION_TYPE_VIDEO?s["default"].connectLocalVideoStream(e,t):q===r["default"].ACTION_TYPE_AUDIO?s["default"].connectLocalAudioStream(e,t):q===r["default"].ACTION_TYPE_AUDIO_VIDEO&&s["default"].connectLocalAudioVideoStream(e,t))}function V(e,t){e?ce?(attachMediaStream(e,ce),t&&"function"==typeof t&&t(ce)):(ne.push(e),t&&"function"==typeof t&&oe.push(t)):ce?t&&"function"==typeof t&&t(ce):t&&"function"==typeof t&&oe.push(t)}function W(){console.log("(ReachSDK::webrtc::init_pc)stackId="+N+"_config=",(0,a["default"])(Q)),j=new X(Q,he),j.onicecandidate=function(e){e.candidate&&(console.log("(ReachSDK::webrtc::pc.onicecandidate)stackId="+N+" send ice candidate="+(0,a["default"])(e.candidate)),Y.child("iceCandidatesList").push({label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}))},j.onaddstream=function(e){console.debug("(ReachSDK::webrtc::onaddstream)stackId="+N+"-stream:"+(0,a["default"])(e.stream)),e&&e.stream&&(ce=e.stream,ue&&y(),le&&A())},j.oniceconnectionstatechange=function(){j&&j.iceConnectionState===h?(console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+N+"-checking"),de=h):j&&j.iceConnectionState===l?(de=l,console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+N+"-connected"),ce&&(ne.forEach(function(e){e&&(console.debug("(ReachSDK::webrtc::onaddstream)pc.onaddstream stackId="+N+"-rendering remote vid to "+e.id),attachMediaStream(e,ce))}),oe.forEach(function(e){e&&e(ce)}),oe=[]),_()):j&&j.iceConnectionState===f&&(de=f,console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+N+"-"+f),_()),j&&j.iceConnectionState===u?(de=u,console.log("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+N+"-remote disconnection, closing peer connection"),L()):j&&j.iceConnectionState===m?(console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+N+"-closed"),de=m,L()):j&&j.iceConnectionState===v?(console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+N+"-failed"),de=v,L()):(j?console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+N+"-"+j.iceConnectionState):console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+N+"-pc = null"),de=b),!ie||de!==u&&de!==m&&de!==v||(console.debug("(ReachSDK::webrtc::_close)stackId="+N+"-closed webrtc stack complete"),j=null,re=!1,x.clearWebrtcStacks($),H&&"function"==typeof H&&H(),se&&"function"==typeof se&&se())},G=function(e){var t=e.val(),n=new ee({sdpMLineIndex:t.label,candidate:t.candidate,sdpMid:t.id});console.log("(ReachSDK::webrtc::iceCandidatesListCb)stackId="+N+"received ice candidate="+(0,a["default"])(n)),j.addIceCandidate(n)},U?M(function(){O(),T()}):O()}var x=e,N=(new Date).getTime(),U=t,j=null,Y=n,F=o,G=null,z=null,J=null,B=null,H=null,$=c,q=i,Q=null,X=null,Z=null,ee=null,te=[],ne=[],oe=[],ce=null,ae=null,ie=!1,re=!1,de=null,se=null,ue=!1,le=!1;console.log("(ReachSDK::webrtc::)stackId=${stackId} isPublish=${isPublish},localDataRef=${localDataRef},remoteDataRef=${remoteDataRef})");var fe={DtlsSrtpKeyAgreement:!0},he={optional:[fe]},me={mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}},ve={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};return function(){if(console.log("(ReachSDK::webrtc::init)stackId="+N),"function"!=typeof RTCPeerConnection)throw console.error("(ReachSDK::webrtc::init)stackId="+N+" error=Webrtc is not supported on this browser !"),new Error("Webrtc is not supported on this browser !");if(X=RTCPeerConnection,"function"!=typeof RTCSessionDescription)throw console.error("(ReachSDK::webrtc::init)stackId="+N+" error2=Webrtc is not supported on this browser !"),new Error("Webrtc is not supported on this browser !");if(Z=RTCSessionDescription,"function"!=typeof RTCIceCandidate)throw console.error("(ReachSDK::webrtc::init)stackId="+N+" error3=Webrtc is not supported on this browser !"),new Error("Webrtc is not supported on this browser !");ee=RTCIceCandidate,d&&(ue=!0),S&&(le=!0),I(function(e){Q=e,console.log("(ReachSDK::webrtc::) use server config=",(0,a["default"])(Q)),W()},function(){"undefined"!=typeof p?(Q=p,console.log("(ReachSDK::webrtc::) use DEFAULT_ICE_CONFIG config=",(0,a["default"])(Q))):console.log("(ReachSDK::webrtc::) no ice  config"),W()})}(),{setOnClose:function(e){H=e},close:function(e){console.debug("(ReachSDK::webrtc::_close)stackId="+N+"-close requested"),L(e)},connectLocalStream:P,connectRemoteStream:V,muteAudio:y,unmuteAudio:K,muteVideo:A,unmuteVideo:C}};t["default"]=S},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var c=n(4),a=o(c),i=n(11),r=o(i),d=n(3),s=o(d),u=function(e){function t(t,n,o,c,i,d,s,u,l,m){var v=d,b=e.getWebrtc().child(s+"/"+a["default"].appInstanceId),p=e.getWebrtc().child(s+"/"+n),S=void 0;S=c?{webRtcStackId:v,localVid:t}:{webRtcStackId:v,remoteVid:t};var g=h.push(S)-1;if(f[v])console.debug("ReachSDK::webrtcmngr::createWebrtc->use existing real webrtcStack"),c?(f[v].isPublished++,f[v].stack.connectLocalStream(t,m)):(f[v].isSubscribed++,f[v].stack.connectRemoteStream(t,m));else{console.debug("ReachSDK::webrtcmngr::createWebrtc->create a new real webrtcStack");var I=(0,r["default"])(this,c,b,p,v,i,u,l);I.setOnClose(o),c?(f[v]={stack:I,isPublished:1,isSubscribed:0},I.connectLocalStream(t,m)):(f[v]={stack:I,isPublished:0,isSubscribed:1},I.connectRemoteStream(t,m))}return console.debug("ReachSDK::webrtcmngr::createWebrtc->webrtcStack:"+v+" new isPublished count ="+f[v].isPublished+" new isSubscribed count ="+f[v].isSubscribed),g}function n(e,t,n){if(console.debug("ReachSDK::webrtcmngr::closeWebrtc->id="+e),!h[e])return console.warn("ReachSDK::webrtcmngr::closeWebrtc: virtualstack "+e+" not found"),n&&"function"==typeof n&&n(),!1;var o=h[e].webRtcStackId;return o&&f[o]?(t&&f[o].isPublished>0?f[o].isPublished--:!t&&f[o].isSubscribed>0&&f[o].isSubscribed--,f[o].isPublished<1&&f[o].isSubscribed<1?(console.debug("ReachSDK::webrtcmngr::closeWebrtc->destroy  real webrtcStack:"+o),f[o].stack.close(n),f[o]=null):(console.debug("ReachSDK::webrtcmngr::closeWebrtc->decrement  real webrtcStack:"+o+" new isPublished count ="+f[o].isPublished+" new isSubscribed count ="+f[o].isSubscribed),n&&"function"==typeof n&&n())):(n&&"function"==typeof n&&n(),console.warn("ReachSDK::webrtcmngr::closeWebrtc cannot found real stack")),h[e].localVid&&(s["default"].close(),detachMediaStream(h[e].localVid)),h[e].remoteVid&&detachMediaStream(h[e].remoteVid),!0}function o(e){return console.debug("ReachSDK::webrtcmngr::clearWebrtcStacks id="+e),e&&f&&f[e]&&(f[e]=null),!0}function c(e){if(console.log("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e),h&&h[e]&&h[e].webRtcStackId){var t=h[e].webRtcStackId;console.log("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+" webRtcStackId="+t),f&&f[t]&&f[t].stack?f[t].stack.muteAudio():console.warn("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) webrtcStack="+t+" not found")}else console.warn("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+" not found")}function i(e){if(console.log("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e),h&&h[e]&&h[e].webRtcStackId){var t=h[e].webRtcStackId;console.log("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+",webRtcStackId="+t),f&&f[t]&&f[t].stack?f[t].stack.unmuteAudio():console.warn("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) webrtcStack="+t+" not found")}else console.warn("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+" not found")}function d(e){if(console.log("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e),h&&h[e]&&h[e].webRtcStackId){var t=h[e].webRtcStackId;console.log("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+" webRtcStackId="+t),f&&f[t]&&f[t].stack?f[t].stack.muteVideo():console.warn("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) webrtcStack="+t+" not found")}else console.warn("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+" not found")}function u(e){if(console.log("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e),h&&h[e]&&h[e].webRtcStackId){var t=h[e].webRtcStackId;console.log("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+", webRtcStackId="+t),f&&f[t]&&f[t].stack?f[t].stack.unmuteVideo():console.warn("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) webrtcStack="+t+" not found")}else console.warn("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+" not found")}var l=this,f=[],h=[];return{createWebrtc:function(e,n,o,c,a,i,r,d,s){return t.bind(l)(e,n,o,c,a,i,r,d,s)},closeWebrtc:n,clearWebrtcStacks:o,muteAudioWebrtcStack:c,unmuteAudioWebrtcStack:i,muteVideoWebrtcStack:d,unmuteVideoWebrtcStack:u}};t["default"]=u},function(e,t,n){e.exports={"default":n(17),__esModule:!0}},function(e,t){"use strict";t["default"]=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.__esModule=!0},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}var c=n(13),a=o(c);t["default"]=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),(0,a["default"])(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),t.__esModule=!0},function(e,t,n){var o=n(1);e.exports=function(e){return(o.JSON&&o.JSON.stringify||JSON.stringify).apply(JSON,arguments)}},function(e,t,n){var o=n(25);e.exports=function(e,t,n){return o.setDesc(e,t,n)}},function(e,t,n){n(28),e.exports=n(1).Object.keys},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,n){var o=n(19);e.exports=function(e,t,n){if(o(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,o){return e.call(t,n,o)};case 3:return function(n,o,c){return e.call(t,n,o,c)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e){if(void 0==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,n){var o=n(24),c=n(1),a=n(20),i="prototype",r=function(e,t,n){var d,s,u,l=e&r.F,f=e&r.G,h=e&r.S,m=e&r.P,v=e&r.B,b=e&r.W,p=f?c:c[t]||(c[t]={}),S=f?o:h?o[t]:(o[t]||{})[i];f&&(n=t);for(d in n)s=!l&&S&&d in S,s&&d in p||(u=s?S[d]:n[d],p[d]=f&&"function"!=typeof S[d]?n[d]:v&&s?a(u,o):b&&S[d]==u?function(e){var t=function(t){return this instanceof e?new e(t):e(t)};return t[i]=e[i],t}(u):m&&"function"==typeof u?a(Function.call,u):u,m&&((p[i]||(p[i]={}))[d]=u))};r.F=1,r.G=2,r.S=4,r.P=8,r.B=16,r.W=32,e.exports=r},function(e,t){e.exports=function(e){try{return!!e()}catch(t){return!0}}},function(e,t){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(e,t){var n=Object;e.exports={create:n.create,getProto:n.getPrototypeOf,isEnum:{}.propertyIsEnumerable,getDesc:n.getOwnPropertyDescriptor,setDesc:n.defineProperty,setDescs:n.defineProperties,getKeys:n.keys,getNames:n.getOwnPropertyNames,getSymbols:n.getOwnPropertySymbols,each:[].forEach}},function(e,t,n){var o=n(22),c=n(1),a=n(23);e.exports=function(e,t){var n=(c.Object||{})[e]||Object[e],i={};i[e]=t(n),o(o.S+o.F*a(function(){n(1)}),"Object",i)}},function(e,t,n){var o=n(21);e.exports=function(e){return Object(o(e))}},function(e,t,n){var o=n(27);n(26)("keys",function(e){return function(t){return e(o(t))}})}])});