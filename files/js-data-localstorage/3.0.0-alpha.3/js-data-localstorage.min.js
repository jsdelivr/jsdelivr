/*!
* js-data-localstorage
* @version 3.0.0-alpha.3 - Homepage <https://github.com/js-data/js-data-localstorage>
* @author Jason Dobry <jason.dobry@gmail.com>
* @copyright (c) 2014-2016 Jason Dobry
* @license MIT <https://github.com/js-data/js-data-localstorage/blob/master/LICENSE>
*
* @overview localStorage adapter for js-data.
*/
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("js-data")):"function"==typeof define&&define.amd?define(["js-data"],e):"object"==typeof exports?exports.LocalStorageAdapter=e(require("js-data")):t.LocalStorageAdapter=e(t.JSData)}(this,function(t){return function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t){return null!=t&&""!==t}function a(t,e){return e||(e=""),t.filter(o).join(e)}function i(){for(var t=arguments.length,e=Array(t),n=0;t>n;n++)e[n]=arguments[n];var r=a(e,"/");return r.replace(/([^:\/]|^)\/{2,}/g,"$1/")}function u(t){var e={},n=[];return t.forEach(function(t){t in e||(n.push(t),e[t]=0)}),n}function f(t){O.push(t)}function c(){O.length&&!C&&(C=!0,O[0]())}function l(t){O.length?f(t):(f(t),c())}function d(t){return new Promise(t).then(function(t){return C=!1,O.shift(),setTimeout(c,0),t},function(t){return C=!1,O.shift(),setTimeout(c,0),K(t)})}function s(t){m(this,t||{}),m(this,T)}var h=n(1),p=n(2),v=h.Query,g=h.utils,y=g.addHiddenPropsToTarget,b=g.deepMixIn,A=g.extend,m=g.fillIn,I=g.forEachRelation,x=g.forOwn,P=g.fromJson,w=g.get,M=g.isArray,j=g.isUndefined,F=g.resolve,K=g.reject,U=g.set,E=g.toJson,O=[],C=!1,D=function(){for(var t=this,e=arguments.length,n=Array(e),r=0;e>r;r++)n[r]=arguments[r];var o=n[n.length-1];return t.dbg.apply(t,[o.op].concat(n)),F()},S=function(){for(var t=this,e=arguments.length,n=Array(e),r=0;e>r;r++)n[r]=arguments[r];var o=n[n.length-2];return t.dbg.apply(t,[o.op].concat(n)),F()},T={basePath:"",debug:!1,storage:localStorage};s.extend=A,y(s.prototype,{afterCreate:S,afterCreateMany:S,afterDestroy:S,afterDestroyAll:S,afterFind:S,afterFindAll:S,afterUpdate:S,afterUpdateAll:S,afterUpdateMany:S,beforeCreate:D,beforeCreateMany:D,beforeDestroy:D,beforeDestroyAll:D,beforeFind:D,beforeFindAll:D,beforeUpdate:D,beforeUpdateAll:D,beforeUpdateMany:D,_create:function(t,e,n){var r=this,o={},a=t.relationFields||[];x(e,function(t,e){-1===a.indexOf(e)&&(o[e]=t)});var i=w(o,t.idAttribute)||p();U(o,t.idAttribute,i);var u=r.getIdPath(t,n,i);return r.storage.setItem(u,E(o)),r.ensureId(i,t,n),P(r.storage.getItem(u))},create:function(t,e,n){var r=this;return e||(e={}),n||(n={}),d(function(o,a){l(function(){var i=void 0;return i=n.op="beforeCreate",F(r[i](t,e,n)).then(function(o){var a=j(o)?e:o;return a=r._create(t,a,n),i=n.op="afterCreate",r[i](t,e,n,a).then(function(t){return a=j(t)?a:t,n.raw?{data:a,created:1}:a})}).then(o,a)})})},createMany:function(t,e,n){var r=this;return e||(e={}),n||(n={}),d(function(o,a){l(function(){var i=void 0;return i=n.op="beforeCreateMany",F(r[i](t,e,n)).then(function(o){var a=j(o)?e:o;return a=a.map(function(e){return r._create(t,e,n)}),i=n.op="afterCreateMany",r[i](t,e,n,a).then(function(t){return a=j(t)?a:t,n.raw?{data:a,created:a.length}:a})}).then(o,a)})})},dbg:function(){for(var t=arguments.length,e=Array(t),n=0;t>n;n++)e[n]=arguments[n];this.log.apply(this,["debug"].concat(e))},destroy:function(t,e,n){var r=this;return n||(n={}),d(function(o,a){l(function(){var i=void 0;return i=n.op="beforeDestroy",F(r[i](t,e,n)).then(function(){return i=n.op="destroy",r.dbg(i,e,n),r.storage.removeItem(r.getIdPath(t,n,e)),r.removeId(e,t,n),i=n.op="afterDestroy",r[i](t,e,n).then(function(t){return e=j(t)?e:t,n.raw?{data:e,deleted:1}:e})}).then(o,a)})})},destroyAll:function(t,e,n){var r=this;return e||(e={}),n||(n={}),d(function(o,a){l(function(){var i=void 0;return i=n.op="beforeDestroyAll",F(r[i](t,e,n)).then(function(){return i=n.op="destroyAll",r.dbg(i,e,n),r.findAll(t,e,n)}).then(function(o){var a=t.idAttribute,u=o.map(function(t){return w(t,a)});return u.forEach(function(e){r.storage.removeItem(r.getIdPath(t,n,e))}),r.removeId(u,t,n),i=n.op="afterDestroyAll",r[i](t,e,n,u).then(function(t){return u=j(t)?u:t,n.raw?{data:u,deleted:o.length}:u})}).then(o,a)})})},ensureId:function(t,e,n){var r=this.getIds(e,n);if(M(t)){if(!t.length)return;t.forEach(function(t){r[t]=1})}else r[t]=1;this.saveKeys(r,e,n)},find:function(t,e,n){var o=this,a=void 0,i=void 0;return n||(n={}),n.with||(n.with=[]),i=n.op="beforeFind",F(o[i](t,e,n)).then(function(){i=n.op="find",o.dbg(i,e,n);var f=o.getIdPath(t,n,e);if(a=o.storage.getItem(f),j(a))return void(a=void 0);a=P(a);var c=[];return I(t,n,function(e,n){var i=e.getRelation(),f=void 0;if("hasOne"!==e.type&&"hasMany"!==e.type||!e.foreignKey)if("hasMany"===e.type&&e.localKeys){var l=[],d=w(a,e.localKeys)||[];d=Array.isArray(d)?d:Object.keys(d),l=l.concat(d||[]),f=o.findAll(i,{where:r({},i.idAttribute,{in:u(l).filter(function(t){return t})})},n).then(function(t){return U(a,e.localField,t),t})}else"belongsTo"===e.type&&(f=o.find(i,w(a,e.foreignKey),n).then(function(t){return U(a,e.localField,t),t}));else f=o.findAll(i,r({},e.foreignKey,w(a,t.idAttribute)),n).then(function(t){return"hasOne"===e.type&&t.length?U(a,e.localField,t[0]):U(a,e.localField,t),t});f&&c.push(f)}),Promise.all(c)}).then(function(){return i=n.op="afterFind",F(o[i](t,e,n,a)).then(function(t){return a=j(t)?a:t,n.raw?{data:a,found:a?1:0}:a})})},findAll:function(t,e,n){var o=this,a=[],i=void 0;return n||(n={}),n.with||(n.with=[]),i=n.op="beforeFindAll",F(o[i](t,e,n)).then(function(){i=n.op="findAll",o.dbg(i,e,n);var f=o.getIds(t,n);x(f,function(e,r){var i=o.storage.getItem(o.getIdPath(t,n,r));i&&a.push(P(i))});var c=t.idAttribute,l=new v({index:{getAll:function(){return a}}});a=l.filter(e).run();var d=[];return I(t,n,function(t,e){var n=t.getRelation(),i=void 0;"hasOne"!==t.type&&"hasMany"!==t.type||!t.foreignKey?"hasMany"===t.type&&t.localKeys?!function(){var f=[];a.forEach(function(e){var n=w(e,t.localKeys)||[];n=Array.isArray(n)?n:Object.keys(n),f=f.concat(n||[])}),i=o.findAll(n,{where:r({},n.idAttribute,{in:u(f).filter(function(t){return t})})},e).then(function(e){return a.forEach(function(r){var o=[],a=w(r,t.localKeys)||[];a=Array.isArray(a)?a:Object.keys(a),e.forEach(function(t){a&&-1!==a.indexOf(t[n.idAttribute])&&o.push(t)}),U(r,t.localField,o)}),e})}():"belongsTo"===t.type&&(i=o.findAll(n,{where:r({},n.idAttribute,{in:a.map(function(e){return w(e,t.foreignKey)}).filter(function(t){return t})})},e).then(function(e){return a.forEach(function(r){e.forEach(function(e){e[n.idAttribute]===w(r,t.foreignKey)&&U(r,t.localField,e)})}),e})):i=o.findAll(n,{where:r({},t.foreignKey,{in:a.map(function(t){return w(t,c)}).filter(function(t){return t})})},e).then(function(e){return a.forEach(function(n){var r=[];e.forEach(function(e){w(e,t.foreignKey)===w(n,c)&&r.push(e)}),"hasOne"===t.type&&r.length?U(n,t.localField,r[0]):U(n,t.localField,r)}),e}),i&&d.push(i)}),Promise.all(d)}).then(function(){return i=n.op="afterFindAll",F(o[i](t,e,n,a)).then(function(t){return a=j(t)?a:t,n.raw?{data:a,found:a.length}:a})})},getPath:function(t,e){return e=e||{},i(void 0===e.basePath?void 0===t.basePath?this.basePath:t.basePath:e.basePath,t.name)},getIdPath:function(t,e,n){return e=e||{},i(e.basePath||this.basePath||t.basePath,t.endpoint,n)},getIds:function(t,e){var n=void 0,r=this.getPath(t,e),o=this.storage.getItem(r);return n=o?P(o):{}},log:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;e>r;r++)n[r-1]=arguments[r];if(t&&!n.length&&(n.push(t),t="debug"),"debug"!==t||this.debug){var o=t.toUpperCase()+": (LocalStorageAdapter)";if(console[t]){var a;(a=console)[t].apply(a,[o].concat(n))}else{var i;(i=console).log.apply(i,[o].concat(n))}}},removeId:function(t,e,n){var r=this.getIds(e,n);if(M(t)){if(!t.length)return;t.forEach(function(t){delete r[t]})}else delete r[t];this.saveKeys(r,e,n)},saveKeys:function(t,e,n){t=t||{};var r=this.getPath(e,n);Object.keys(t).length?this.storage.setItem(r,E(t)):this.storage.removeItem(r)},update:function(t,e,n,r){var o=this;return n||(n={}),r||(r={}),d(function(a,i){l(function(){var u=void 0;return u=r.op="beforeUpdate",F(o[u](t,e,n,r)).then(function(a){n=j(a)?n:a;var i=o.getIdPath(t,r,e),f=o.storage.getItem(i);f=f?P(f):void 0;var c=0;return f&&(b(f,n),o.storage.setItem(i,E(f)),c++),u=r.op="afterUpdate",o[u](t,e,n,r,f).then(function(t){return f=j(t)?f:t,r.raw?{data:f,updated:c}:f})}).then(a,i)})})},updateAll:function(t,e,n,r){var o=this;return e||(e={}),n||(n={}),r||(r={}),d(function(a,i){l(function(){var u=void 0;return u=r.op="beforeUpdateAll",F(o[u](t,e,n,r)).then(function(a){return e=j(a)?e:a,u=r.op="updateAll",o.dbg(u,n,r),o.findAll(t,n,r)}).then(function(a){var i=t.idAttribute,f=0;return a.forEach(function(n){n||(n={});var a=w(n,i),u=o.getIdPath(t,r,a);b(n,e),o.storage.setItem(u,E(n)),f++}),u=r.op="afterUpdateAll",o[u](t,e,n,r,a).then(function(t){return a=j(t)?a:t,r.raw?{data:a,updated:f}:a})}).then(a,i)})})},updateMany:function(t,e,n){var r=this;return e||(e=[]),n||(n={}),d(function(o,a){l(function(){var i=void 0,u=[];return i=n.op="beforeUpdateMany",F(r[i](t,e,n)).then(function(o){e=j(o)?e:o,i=n.op="updateMany",r.dbg(i,e,n);var a=t.idAttribute;return e.forEach(function(e){if(e){var o=w(e,a);if(!j(o)){var i=r.getIdPath(t,n,o),f=r.storage.getItem(i),c=f?P(f):void 0;c&&(b(c,e),r.storage.setItem(i,E(c)),u.push(c))}}}),i=n.op="afterUpdateMany",r[i](t,e,n,u).then(function(t){return e=j(t)?u:t,n.raw?{data:e,updated:u.length}:e})}).then(o,a)})})}}),s.version={full:"<%= pkg.version %>",major:parseInt("<%= major %>",10),minor:parseInt("<%= minor %>",10),patch:parseInt("<%= patch %>",10),alpha:"<%= alpha %>",beta:"<%= beta %>"},t.exports=s},function(e,n){e.exports=t},function(t,e,n){function r(){return o(8)+"-"+o(4)+"-4"+o(3)+"-"+a(8,9,"a","b")+o(3)+"-"+o(12)}var o=n(3),a=n(4);t.exports=r},function(t,e,n){function r(t){t=t&&t>0?t:6;for(var e="";t--;)e+=o(a);return e}var o=n(4),a="0123456789abcdef".split("");t.exports=r},function(t,e,n){function r(t){var e=1===arguments.length&&a(t)?t:arguments;return e[o(0,e.length-1)]}var o=n(5),a=n(10);t.exports=r},function(t,e,n){function r(t,e){return t=null==t?o:~~t,e=null==e?a:~~e,Math.round(i(t-.5,e+.499999999999))}var o=n(6),a=n(7),i=n(8);t.exports=r},function(t,e){t.exports=-2147483648},function(t,e){t.exports=2147483647},function(t,e,n){function r(t,e){return t=null==t?a:t,e=null==e?i:e,t+(e-t)*o()}var o=n(9),a=n(6),i=n(7);t.exports=r},function(t,e){function n(){return n.get()}n.get=Math.random,t.exports=n},function(t,e,n){var r=n(11),o=Array.isArray||function(t){return r(t,"Array")};t.exports=o},function(t,e,n){function r(t,e){return o(t)===e}var o=n(12);t.exports=r},function(t,e){function n(t){return null===t?"Null":t===r?"Undefined":o.exec(a.call(t))[1]}var r,o=/^\[object (.*)\]$/,a=Object.prototype.toString;t.exports=n}])});
//# sourceMappingURL=dist/js-data-localstorage.min.map