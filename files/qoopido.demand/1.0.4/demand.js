/*! Qoopido.demand 1.0.4 | https://github.com/dlueth/qoopido.demand | (c) 2015 Dirk Lueth */
!function(e,t,r,n,a,o,u,i,c,s){"use strict";function l(){var e=this||{},t=j(e,O)?e:le,r=Q.call(arguments);return r.forEach(h,t),S.all(r)}function p(){var e,t,r=E(arguments[0],oe)?arguments[0]:le,n=r?arguments[1]:arguments[0];if(!r&&P.current&&(e=P.current,r=e.type+"!"+e.path),r)return o(function(){var a,o,i,c=U.path(r),s=xe[c.type]||(xe[c.type]={});e||!s[c.path]?(a=new O(r,n,t),o=xe[a.type][a.path]=a.pledge,e&&(e.timeout=u(e.timeout),i=e.defered,o.then(i.resolve,function(){i.reject(new k("unable to resolve module",r,arguments))}),!e.cached&&e.store(),P.length>0&&P.next())):v("duplicate found for module "+c.path)}),{when:function(){t=arguments}};throw new k("unspecified anonymous provide")}function f(e){var t,r=e.cache,n=e.storage,a=e.debug,o=e.version,u=e.timeout,i=e.lifetime,c=e.base,s=e.pattern,l=e.probes;if(N=E(r,ue)?r:N,_=E(n,oe)?n:_,B=E(a,ue)?a:B,H=E(o,oe)?o:H,q(u)&&(F=1e3*Math.min(Math.max(u,2),10),G=Math.min(Math.max(F/5,1e3),5e3)),q(i)&&(J=1e3*i),E(c,oe)&&(L=be.base=new M("",U.url(c))),I(s))for(t in s)"base"!==t&&(be[t]=new M(t,s[t]));if(I(l))for(t in l)je[t]=l[t];return!0}function h(e,t,r){var n=this,a=U.path(e,n),o=a.type,u=a.path,i=xe[o]||(xe[o]={});r[t]=i[u]||(i[u]=new T(e,n).pledge)}function d(e,t){p(e,function(){return t})}function m(){return+new Date}function g(e){V.href=e;var t=V.search,r="demand[timestamp]="+m();return V.search+=t&&"?"!==t?"&"+r:"?"+r,V.href}function v(e){var t=j(e,k)?"error":"warn";E(console,ae)||!B&&"warn"===t||console[t](e.toString())}function y(e,t){return new RegExp(e,t)}function w(e){return e.replace(me,"\\$&")}function x(e){return e.replace(ve,"")}function b(e){return he.test(e)}function j(e,t){return e instanceof t}function E(e,t){return typeof e===t}function I(e){return e&&E(e,"object")}function q(e){return E(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function S(e){function t(){n(ce,arguments)}function r(){n(se,arguments)}function n(e,t){a.state===ie&&(a.state=e,a.value=t,o[e].forEach(function(e){e.apply(le,a.value)}))}var a=this,o={resolved:[],rejected:[]};a.then=function(e,t){if(a.state===ie)e&&o[ce].push(e),t&&o[se].push(t);else switch(a.state){case ce:e.apply(le,a.value);break;case se:t.apply(le,a.value)}},e(t,r)}function k(e,t,r){var n=this;n.message=e,t&&(n.module=t),r&&(n.stack=Q.call(r))}function M(e,t){var r=this;r.weight=e.length,r.url=U.url(t),r.regexPattern=y("^"+w(e)),r.regexUrl=y("^"+w(t))}function R(){var e=this;e.current=le,e.queue=[]}function T(e,t){var r,n=this,a=S.defer();U.path.call(n,e,t),n.defered=a,n.pledge=a.pledge,t||n.pledge.then(le,v),l(te+n.type).then(function(e){n.retrieve(),n.handler=e,n.cached?P.add(n):(r=A.test(n.url)?new pe:new fe,r.onprogress=function(){},r.ontimeout=r.onerror=r.onabort=function(){a.reject(new k("unable to load module",n.path))},r.onload=function(){n.timeout=u(n.timeout),n.source=r.responseText,P.add(n)},r.open("GET",g(e.prepare(n.url)),!0),r.send(),n.timeout=o(function(){r.readyState<4&&r.abort()},F))},a.reject)}function O(e,t,r){var n=this,a=S.defer();U.path.call(n,e),(n.pledge=a.pledge).then(le,function(){v(new k("unable to resolve module",n.path,arguments))}),r&&r.length>0?l.apply(n,r).then(function(){a.resolve(t.apply(le,arguments))},function(){a.reject(new k("unable to resolve dependencies for",n.path,arguments))}):a.resolve(t())}var A,D,P,U,X,$,C,L,N,_,B,F,G,H,J,Q=Array.prototype.slice,z=Array.prototype.concat,K=t.getElementsByTagName("head")[0],V=t.createElement("a"),W="demand",Y="["+W+"]",Z="[state]",ee="[value]",te="/"+W+"/handler/",re="/"+W+"/storage/",ne="/validator/",ae="undefined",oe="string",ue="boolean",ie="pending",ce="resolved",se="rejected",le=null,pe=a,fe="XDomainRequest"in e&&e.XDomainRequest||pe,he=/^\//i,de=/^([-\w]+\/?)+!/,me=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,ge=/\/\/#\s+sourceMappingURL\s*=\s*(.+?)\.map/g,ve=/^http(s?):/,ye=r&&"remainingSpace"in r,we={cache:!0,storage:"localstorage",handler:"js",debug:!1,version:"1.0.0",lifetime:0,timeout:5,base:"/"},xe={},be={},je={};U={url:function(e){return V.href=e,V.href},path:function(e,t){var r,n,a=this,o=e.match(de)||we.handler,u=j(a,T);E(o,oe)||(e=e.replace(y("^"+w(o[0])),""),o=o[1]),b(e)||(e="/"+U.url((t&&t.path&&U.url(t.path+"/../")||"/")+e).replace(A,""));for(r in be)be[r].matches(e)&&(!n||n.weight<be[r].weight)&&(n=be[r]);return u||j(a,O)?(a.type=o,a.path=e,u&&(a.url=x(U.url(n.process(e)))),void 0):{type:o,path:e}}},C={get:function(e,t){var a,o;if(r){if(a=Y+"["+e+"]",o=n.parse(r.getItem(a+Z)),o&&o.version===H&&o.url===t&&(0===o.expires||o.expires>m))return r.getItem(a+ee);C.clear.path(e)}},set:function(e,t,a){var o,u;if(r){o=Y+"["+e+"]";try{if(u=ye?r.remainingSpace:le,r.setItem(o+ee,t),r.setItem(o+Z,n.stringify({version:H,expires:J>0?m+J:0,url:a})),u!==le&&r.remainingSpace===u)throw"QUOTA_EXCEEDED_ERR"}catch(i){v("unable to cache module "+e)}}},clear:{path:function(e){var t;r&&(t=Y+"["+e+"]",r.removeItem(t+Z),r.removeItem(t+ee))},all:function(){var e;if(r)for(e in r)0===e.indexOf(Y)&&r.removeItem(e)},expired:function(){var e,t,a;if(r)for(e in r)t=e.match(D),t&&(a=n.parse(r.getItem(Y+"["+t[1]+"]"+Z)),a&&a.expires>0&&a.expires<=m&&C.clear.path(t[1]))}}},$={prepare:function(e){return e+".js"},resolve:function(e,r){var n=t.createElement("script");n.defer=n.async=!0,n.text=r,n.setAttribute("demand-path",e),K.appendChild(n)},modify:function(e,t){for(var r,n;r=ge.exec(t);)n=x(U.url(e+"/../"+r[1])),t=t.replace(r[0],"//# sourcemap="+n+".map");return t}},S.prototype={constructor:S,state:ie,value:le,listener:le,then:le},S.defer=function(){var e={};return e.pledge=new S(function(t,r){e.resolve=t,e.reject=r}),e},S.all=function(e){var t=S.defer(),r=t.pledge,n=[],a=[],o=e.length,u=0;return e.forEach(function(e,r){e.then(function(){n[r]=Q.call(arguments),u++,u===o&&t.resolve.apply(le,z.apply([],n))},function(){a.push(Q.call(arguments)),a.length+u===o&&t.reject.apply(le,z.apply([],a))})}),r},S.race=function(e){var t=S.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},k.prototype={message:le,module:le,stack:le,toString:function(){var e=this,t=Y+" "+e.message+" "+e.module;return e.stack&&(t=k.traverse(e.stack,t,1)),t}},k.traverse=function(e,t,r){var n=new Array(r+1).join(" ");return e.forEach(function(e){t+="\n"+n+"> "+e.message+" "+e.module,e.stack&&(t=k.traverse(e.stack,t,r+1))}),t},M.prototype={weight:0,url:le,regexPattern:le,regexUrl:le,matches:function(e){return this.regexPattern.test(e)},remove:function(e){return e.replace(this.regexUrl,"")},process:function(e){var t=this;return e.replace(t.regexPattern,t.url)}},R.prototype={current:le,queue:le,length:0,add:function(e){var t=this,r=t.queue;r.push(e),t.length++,1===r.length&&t.next()},next:function(){var e,t,r,n=this,a=n.current,u=n.queue;a&&(n.current=le,u.shift(),n.length--),u.length&&(a=n.current=n.queue[0],e=a.defered,t=a.path,r=a.handler,!a.cached&&r.modify&&(a.source=r.modify(a.url,a.source)),r.resolve(t,a.source),je[t]&&a.probe(),a.timeout=o(function(){e.reject(new k("timeout resolving module",t))},G))}},T.prototype={type:le,handler:le,path:le,url:le,defered:le,pledge:le,cached:le,source:le,timeout:le,probe:function(){var e,t=this,r=t.path,n=t.pledge.state===ie;n&&((e=je[r]())?p(function(){return e}):o(t.probe,100))},store:function(){var e=this;N&&X.set(e.path,e.source,e.url)},retrieve:function(){var e=this,t=N&&X.get(e.path,e.url),r=e.cached=!!t;r&&(e.source=t)}},O.prototype={type:le,path:le,pledge:le},A=y("^"+w(U.url("/"))),D=y("^"+w(Y+"[(.+?)]"+Z+"$")),P=new R,be["/"+W]=new M("/"+W,U.url(i+"/../").slice(0,-1)),f(we)&&s&&f(s),l.configure=f,e.demand=l,e.provide=p,d("/"+W,l),d("/provide",p),d("/pledge",S),d("/resolve/url",U.url),d(ne+"isObject",I),d(ne+"isTypeOf",E),d(ne+"isInstanceOf",j),d(ne+"isPositiveInteger",q),d(re+we.storage,C),d(te+we.handler,$),o(function(){l(re+_).then(function(e){X=e,l.clear=X.clear,X.clear.expired(),c&&o(function(){l(c)})})})}(this,document,localStorage,JSON,XMLHttpRequest,setTimeout,clearTimeout,demand.url,demand.main,demand.settings);
//# sourceMappingURL=demand.js.map