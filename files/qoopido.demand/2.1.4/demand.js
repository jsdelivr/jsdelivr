/*! Qoopido.demand 2.1.4 | https://github.com/dlueth/qoopido.demand | (c) 2016 Dirk Lueth */
!function(e,t,r,n,a,c,o){"use strict";function i(){for(var e,t=this!==window?this:te,r=U.call(arguments),n=0;e=r[n];n++)r[n]=I.dependency(e,t);return x.all(r)}function s(e){var t,r=e.cache,n=e.version,a=e.timeout,c=e.lifetime,o=e.base,i=e.pattern,s=e.modules,u=le.modules;if(u[F]?(b(r,Z)||j(r))&&(u[F]=r):u[F]=le.cache,b(n,Y)&&(le.version=n),P(a)&&(le.timeout=1e3*Math.min(Math.max(a,2),12)),P(c)&&c>0&&(le.lifetime=1e3*c),b(o,Y)&&""!==o&&(le.pattern.base=new E("",o)),j(i))for(t in i)"base"!==t&&(le.pattern[t]=new E(t,i[t]));if(j(s))for(t in s)t!==F&&(u[t]=s[t])}function u(e){fe[e]&&(!!fe[e].cache&&C.clean.path(e),delete fe[e],delete pe[e])}function l(e,t){var r;if(b(e,Y)&&b(t,ee))for(e=e.split(" ");r=e.shift();)ue.test(r)&&(he[r]||(he[r]=[])).push(t);return i}function f(e){var t,r,n,a=he[e];if(a)for(t=U.call(arguments,1),r=0;n=a[r];r++)n.apply(te,t)}function p(e){var t,r,n;if(e){t=[];for(r in fe)n=fe[r].pledge,n.state!==e&&n.cache!==e||t.push(r)}else t=Object.keys(fe);return t}function h(){var e,t,r,n=arguments,a=b(n[0],Y)?n[0]:te,c=k(n[a?1:0])?n[a?1:0]:te,o=c?n[a?2:1]:n[a?1:0];if(!a&&O.current&&(a=O.current.path,O.current=te,O.items>0&&O.process()),!a)throw"unspecified anonymous provide";a=I.path(a,this),e=fe[a]||(fe[a]=x.defer()),t=e.pledge,r=b(o,ee),t.state===K&&(c?i.apply(a,c).then(function(){e.resolve(r?o.apply(te,arguments):o)},function(){d(new q("error providing",a,arguments))}):e.resolve(r?o():o))}function d(e){b(console,"undefined")||console.error(e.toString())}function m(e){for(var t,r,n,a=[],c=0;t=e[c];c++)n=t.match(ie),t=t.replace(ie,""),e[c]=(n?"mock:"+n.slice(1).join(""):"mock:")+"!"+t,r=(pe[t]=x.defer()).pledge,r.then(function(e){delete pe[e.path]}),a.push(r);return i.apply(te,e),x.all(a)}function v(e,t){h(e,function(){return t})}function g(e){return e.replace(se,"\\$&")}function y(e,t){return new RegExp(e,t)}function w(){return+new Date}function k(e){return"[object Array]"===H.call(e)}function j(e){return e&&b(e,"object")}function b(e,t){return typeof e===t}function R(e,t){return e instanceof t}function P(e){return b(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function x(e){function t(){n(V,arguments)}function r(){n(W,arguments)}function n(e,t){var r;a.state===K&&(a.state=e,a.value=t,c[e].forEach(function(e){try{r=e.handler.apply(te,t),r&&"function"==typeof r.then?r.then(e.defered.resolve,e.defered.reject):e.defered.resolve(r)}catch(n){e.defered.reject(n)}}))}var a=this,c={resolved:[],rejected:[]};a.then=function(e,t){var r=x.defer();if(a.state===K)e&&c[V].push({handler:e,defered:r}),t&&c[W].push({handler:t,defered:r});else switch(a.state){case V:try{r.resolve(e&&e.apply(te,a.value))}catch(n){r.reject(n)}break;case W:try{r.reject(t&&t.apply(te,a.value))}catch(n){r.reject(n)}}return r.pledge},e(t,r)}function E(e,t){var r=this;r.weight=e.length,r.url=I.url(t).replace(oe,"$1"),r.matchPattern=y("^"+g(e)),r.matchUrl=y("^"+g(t))}function q(e,t,r){var n=this;n.message=e,t&&(n.module=t),r&&(n.stack=U.call(r))}function S(){var e=this;e.items=0,e.stack=[]}function T(e,t){var r,n,o=this,s=x.defer(),u=s.pledge,l=t.handler;return o.deferred=s,o.path=e,o.url=t.url,o.cache=t.cache,o.version=t.version,o.lifetime=t.lifetime,i(G+l).then(function(e){o.handler=e,o.mock=t.mock?pe[o.path]:te,e.onPreRequest&&e.onPreRequest.call(o),o.mock?o.mock.dependencies?o.mock.dependencies.then(function(){o.mock.resolve(o)},o.mock.reject):o.mock.resolve(o):o.cache!==!1&&C.get(o)?a(function(){I.loader(o)}):(f("preRequest",o),u.state===K&&(r=M.test(o.url)?new re:new ne,r.onprogress=function(){},r.ontimeout=r.onerror=r.onabort=function(){s.reject(new q("timeout requesting",o.path))},r.onload=function(){var t=r.getResponseHeader&&r.getResponseHeader("content-type");n=c(n),"status"in r&&200!==r.status||t&&e.matchType&&!e.matchType.test(t)?s.reject(new q("error requesting",o.path)):(o.source=r.responseText,f("postRequest",o),u.state===K&&(e.onPostRequest&&e.onPostRequest.call(o),I.loader(o),o.cache===te&&u.then(function(){C.set(o)})))},r.open("GET",o.url,!0),r.send(),n=a(function(){r.readyState<4&&r.abort()},le.timeout)))},s.reject),s}var I,M,O,C,A=Array.prototype,U=A.slice,$=A.concat,D=Object.prototype,H=D.toString,X=t.createElement("a"),L="demand",N="provide",_="settings",B="/"+L+"/",F=B+"storage/",G=B+"handler/",J=B+"local",Q=B+"settings",z=B+"validator/",K="pending",V="resolved",W="rejected",Y="string",Z="boolean",ee="function",te=null,re=n,ne="XDomainRequest"in e&&e.XDomainRequest||re,ae=/^\//,ce=/^(http(s?):)?\/\//i,oe=/(.+)\/$/,ie=/^(mock:)?(!)?((?:[-\w]+\/?)+)?(?:@(\d+\.\d+.\d+))?(?:#(\d+))?!/,se=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,ue=/^cache(Miss|Hit|Clear|Exceed)|(pre|post)(Request|Process|Cache)$/,le={cache:!0,timeout:8e3,pattern:{},modules:{},handler:"module"},fe={},pe={},he={};I={url:function(e){return X.href=e,X.href},path:function(e,t){return e=e.replace(ie,""),ae.test(e)||ce.test(e)||(e="/"+I.url((t&&I.url(t+"/../")||"/")+e).replace(M,"")),e},dependency:function(e,t){var r,n,a=b(e,Y)?I.path(e,t):te;if(a){if(t&&(e===L||e===N||e===_)){switch(e){case L:a=J+a,r=function(){var e,r=i.bind(t);for(e in i)r[e]=i[e];return r};break;case N:a=J+a,r=function(){return h.bind(t)};break;case _:a=Q+t,r=function(){return le.modules[t]||te}}!fe[a]&&h(a,r)}return(fe[a]||(fe[a]=new T(a,I.parameter(e,t)))).pledge}return n=x.defer(),n.resolve(e),n.pledge},parameter:function(e,t){var r,n,a=e.match(ie),c=le.pattern;if(e=I.path(e,t),!ce.test(e))for(r in c)c[r].matches(e)&&(!n||n.weight<c[r].weight)&&(n=c[r]);return{mock:!(!a||!a[1]),cache:a&&a[2]?!1:te,handler:a&&a[3]||le.handler,version:a&&a[4]||le.version,lifetime:a&&a[5]&&1e3*a[5]||le.lifetime,url:n?I.url(n.process(e)):e}},loader:function(e){var t=e.handler;f("preProcess",e),e.deferred.pledge.state===K&&(t.onPreProcess&&t.onPreProcess.call(e),t.process&&O.add(e))}},x.prototype={state:K},x.defer=function(){var e={};return e.pledge=new x(function(t,r){e.resolve=t,e.reject=r}),e},x.all=function(e){function t(){o===c?r.resolve.apply(te,$.apply([],n)):a.length+o===c&&r.reject.apply(te,$.apply([],a))}var r=x.defer(),n=[],a=[],c=e.length,o=0;return e.forEach(function(e,r){e.then(function(){n[r]=U.call(arguments),o++,t()},function(){a.push(U.call(arguments)),t()})}),r.pledge},x.race=function(e){var t=x.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},E.prototype={matches:function(e){return this.matchPattern.test(e)},remove:function(e){return e.replace(this.matchUrl,"")},process:function(e){var t=this;return e.replace(t.matchPattern,t.url)}},q.prototype={toString:function(){var e=this,t=L+": "+e.message+" "+(e.module?'"'+e.module+'"':"");return e.stack&&(t=q.traverse(e.stack,t,1)),t}},q.traverse=function(e,t,r){var n=new Array(r+1).join(" ");return e.forEach(function(e){t+="\n"+n+"> "+e.message+" "+(e.module?'"'+e.module+'"':""),e.stack&&(t=q.traverse(e.stack,t,r+1))}),t},S.prototype={add:function(){O.stack=O.stack.concat(U.call(arguments)),O.items+=arguments.length,!O.current&&O.process()},process:function(){var e;O.items&&(O.items--,e=O.current=O.stack.shift(),e.handler.process.call(e),f("postProcess",e))}},M=y("^"+g(I.url("/"))),s({base:"/",pattern:{"/demand":I.url((o&&o.url||location.href)+"/../").slice(0,-1)}}),o&&o.settings&&s(o.settings),v(B+"queue",(O=new S).add),v(B+"mock",m),v(B+"pledge",x),v(B+"reason",q),v(B+"function/resolveUrl",I.url),v(z+"isArray",k),v(z+"isObject",j),v(z+"isTypeOf",b),v(z+"isInstanceOf",R),v(z+"isPositiveInteger",P),i.configure=s,i.remove=u,i.on=l,i.list=p,e.demand=i,e.provide=h,function(){function e(){var e=t.getElementsByTagName("head")[0],r=/\/\/#\s+sourceMappingURL\s*=\s*(?!(?:http[s]?:)?\/\/)(.+?)\.map/g;return{matchType:/^(application|text)\/javascript/,onPreRequest:function(){var e=this,t=e.url;e.url=".js"!==t.slice(-3)?t+".js":t},onPostRequest:function(){var e,t,n=this,a=n.source;if(a){for(;e=r.exec(a);)ae.test(e[1])?(X.href=n.url,t=X.protocol+"//"+X.host+e[1]):t=I.url(n.url+"/../"+e[1]),a=a.replace(e[0],"//# sourceMappingURL="+t+".map");n.source=a}},process:function(){var r,n=this,a=n.source;a&&(r=t.createElement("script"),r.async=!0,r.text=a,r.setAttribute("demand-path",n.path),e.appendChild(r))}}}h(G+"module",e)}(),function(){function t(t){function n(e){for(var t,r,n=0;t=m[n];n++)0===e.indexOf(t.pattern)&&(!r||t.weight>r.weight)&&(r=t);return r?r.state:!1}function a(){}var c,o,s="["+L+"]",u="[state]",l="[value]",p=y("^"+g(s)+"\\[(.+?)\\]"+g(u)+"$"),h=function(){try{return"localStorage"in e&&e.localStorage}catch(t){return!1}}(),d=h&&"remainingSpace"in h,m=[];if(j(t))for(o in t)m.push({pattern:o,weight:o.length,state:t[o]});else b(t,Z)&&(c=t);return a.prototype={get:function(e){var t,a,o,i=e.path;if(h&&(c||n(i))){if(t=s+"["+i+"]",a=r.parse(h.getItem(t+u)),o=e.deferred.pledge,a&&a.version===e.version&&a.url===e.url&&(!a.expires&&!e.lifetime||a.expires>w()))return o.cache="hit",e.source=h.getItem(t+l),f("cacheHit",e),e.source;o.cache="miss",f("cacheMiss",e),this.clear.path(i)}},set:function(e){var t,a,o,i=e.path;if(h&&(c||n(i))){f("preCache",e),t=e.lifetime,a=s+"["+i+"]",e.state={version:e.version,expires:t?w()+t:t,url:e.url};try{if(o=d?h.remainingSpace:te,h.setItem(a+l,e.source),h.setItem(a+u,r.stringify(e.state)),o!==te&&h.remainingSpace===o)throw"QUOTA_EXCEEDED_ERR";f("postCache",e)}catch(p){f("cacheExceed",e)}}},clear:{path:function(e){var t;h&&(t=s+"["+e+"]",h.removeItem(t+u),h.removeItem(t+l),f("cacheClear",e))},all:function(){var e,t;if(h)for(e in h)t=e.match(p),t&&this.path(t[1])},expired:function(){var e,t,n;if(h)for(e in h)t=e.match(p),t&&(n=r.parse(h.getItem(s+"["+t[1]+"]"+u)),n&&n.expires>0&&n.expires<=w()&&this.path(t[1]))}}},C=new a,C.clear.expired(),i.clear=C.clear,C}h(F,["settings"],t)}(),o&&o.main&&i(o.main)}(this,document,JSON,XMLHttpRequest,setTimeout,clearTimeout,"demand"in this&&demand);
//# sourceMappingURL=demand.js.map
