function MediaStreamRecorder(a){if(!a){throw"MediaStream is mandatory."}this.start=function(d){var c=IsChrome?window.StereoRecorder:window.MediaRecorderWrapper;if(this.mimeType.indexOf("video")!=-1){c=IsChrome?window.WhammyRecorder:window.MediaRecorderWrapper}if(this.mimeType==="image/gif"){c=window.GifRecorder}b=new c(a);b.ondataavailable=this.ondataavailable;b.onstop=this.onstop;b.onStartedDrawingNonBlankFrames=this.onStartedDrawingNonBlankFrames;b=mergeProps(b,this);b.start(d)};this.onStartedDrawingNonBlankFrames=function(){};this.clearOldRecordedFrames=function(){if(!b){return}b.clearOldRecordedFrames()};this.stop=function(){if(b){b.stop()}};this.ondataavailable=function(c){console.log("ondataavailable..",c)};this.onstop=function(c){console.warn("stopped..",c)};var b}function loadScript(d,c){var a=window.MediaStreamRecorderScriptsDir;var b=document.createElement("script");b.src=a+d;b.onload=c||function(){};document.documentElement.appendChild(b)}if(!window.requestAnimationFrame){requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame}if(!window.cancelAnimationFrame){cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame}if(!window.AudioContext){window.AudioContext=window.webkitAudioContext||window.mozAudioContext}URL=window.URL||window.webkitURL;navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;if(window.webkitMediaStream){window.MediaStream=window.webkitMediaStream}IsChrome=!!navigator.webkitGetUserMedia;function mergeProps(c,a){a=reformatProps(a);for(var b in a){if(typeof a[b]!=="function"){c[b]=a[b]}}return c}function reformatProps(c){var a={};for(var d in c){if(d.indexOf("-")!=-1){var e=d.split("-");var b=e[0]+e[1].split("")[0].toUpperCase()+e[1].substr(1);a[b]=c[d]}else{a[d]=c[d]}}return a}var ObjectStore={AudioContext:window.AudioContext||window.webkitAudioContext};function MediaRecorderWrapper(d){if(this.type=="audio"&&d.getVideoTracks&&d.getVideoTracks().length&&!navigator.mozGetUserMedia){var e=new AudioContext();var g=e.createMediaStreamSource(d);var a=e.createMediaStreamDestination();g.connect(a);d=a.stream}this.start=function(h){h=h||1000;b=false;function i(){if(b){return}f=new MediaRecorder(d);f.ondataavailable=function(k){console.log("ondataavailable",k.data.type,k.data.size,k.data);if(!k.data.size){console.warn("Recording of",k.data.type,"failed.");return}var j=new window.Blob([k.data],{type:k.data.type||c.mimeType||"audio/ogg"});c.ondataavailable(j)};f.onstop=function(j){};f.onerror=function(j){console.error(j);c.start(h)};f.onwarning=function(j){console.warn(j)};f.start(0);setTimeout(function(){f.stop();i()},h)}i()};var b=false;this.stop=function(){b=true;if(c.onstop){c.onstop({})}};this.ondataavailable=this.onstop=function(){};var c=this;if(!c.mimeType&&!!d.getAudioTracks){c.mimeType=d.getAudioTracks().length&&d.getVideoTracks().length?"video/webm":"audio/ogg"}var f}function StereoRecorder(a){this.start=function(d){d=d||1000;c=new StereoAudioRecorder(a,this);c.record();b=setInterval(function(){c.requestData()},d)};this.stop=function(){if(c){c.stop();clearTimeout(b)}};this.ondataavailable=function(){};var c;var b}function StereoAudioRecorder(n,m){var i=[];var p=[];var r;var a=false;var j=0;var o;var g;var c=m.sampleRate||44100;var l;var b;var q=m.audioChannels||2;this.record=function(){a=true;i.length=p.length=0;j=0};this.requestData=function(){if(j==0){h=false;return}h=true;var C=i.slice(0);var u=p.slice(0);var E=j;i.length=p.length=[];j=0;h=false;var t=f(C,E);var z=f(C,E);if(q===2){var D=k(t,z)}else{var D=t}var v=new ArrayBuffer(44+D.length*2);var B=new DataView(v);d(B,0,"RIFF");B.setUint32(4,44+D.length*2,true);d(B,8,"WAVE");d(B,12,"fmt ");B.setUint32(16,16,true);B.setUint16(20,1,true);B.setUint16(22,q,true);B.setUint32(24,c,true);B.setUint32(28,c*4,true);B.setUint16(32,q*2,true);B.setUint16(34,16,true);d(B,36,"data");B.setUint32(40,D.length*2,true);var A=D.length;var y=44;var x=1;for(var w=0;w<A;w++){B.setInt16(y,D[w]*(32767*x),true);y+=2}var s=new Blob([B],{type:"audio/wav"});console.debug("audio recorded blob size:",bytesToSize(s.size));m.ondataavailable(s)};this.stop=function(){a=false;this.requestData()};function k(u,t){var w=u.length+t.length;var s=new Float32Array(w);var x=0;for(var v=0;v<w;){s[v++]=u[x];s[v++]=t[x];x++}return s}function f(x,t){var s=new Float32Array(t);var y=0;var v=x.length;for(var w=0;w<v;w++){var u=x[w];s.set(u,y);y+=u.length}return s}function d(s,w,u){var t=u.length;for(var v=0;v<t;v++){s.setUint8(w+v,u.charCodeAt(v))}}var l=ObjectStore.AudioContext;if(!ObjectStore.AudioContextConstructor){ObjectStore.AudioContextConstructor=new l()}var b=ObjectStore.AudioContextConstructor;if(!ObjectStore.VolumeGainNode){ObjectStore.VolumeGainNode=b.createGain()}var o=ObjectStore.VolumeGainNode;if(!ObjectStore.AudioInput){ObjectStore.AudioInput=b.createMediaStreamSource(n)}var g=ObjectStore.AudioInput;g.connect(o);var e=m.bufferSize||2048;if(m.bufferSize==0){e=0}if(b.createJavaScriptNode){r=b.createJavaScriptNode(e,q,q)}else{if(b.createScriptProcessor){r=b.createScriptProcessor(e,q,q)}else{throw"WebAudio API has no support on this browser."}}e=r.bufferSize;console.debug("using audio buffer-size:",e);var h=false;window.scriptprocessornode=r;if(q==1){console.debug("All right-channels are skipped.")}r.onaudioprocess=function(u){if(!a||h){return}var t=u.inputBuffer.getChannelData(0);i.push(new Float32Array(t));if(q==2){var s=u.inputBuffer.getChannelData(1);p.push(new Float32Array(s))}j+=e};o.connect(r);r.connect(b.destination)}function WhammyRecorderHelper(o,m){this.record=function(p){if(!this.width){this.width=320}if(!this.height){this.height=240}if(this.video&&this.video instanceof HTMLVideoElement){if(!this.width){this.width=b.videoWidth||320}if(!this.height){this.height=b.videoHeight||240}}if(!this.video){this.video={width:this.width,height:this.height}}if(!this.canvas){this.canvas={width:this.width,height:this.height}}d.width=this.canvas.width;d.height=this.canvas.height;if(this.video&&this.video instanceof HTMLVideoElement){b=this.video.cloneNode()}else{b=document.createElement("video");b.src=URL.createObjectURL(o);b.width=this.video.width;b.height=this.video.height}b.muted=true;b.play();a=new Date().getTime();j=new Whammy.Video();console.log("canvas resolutions",d.width,"*",d.height);console.log("video width/height",b.width||d.width,"*",b.height||d.height);g()};this.clearOldRecordedFrames=function(){k=[]};var e=false;this.requestData=function(){if(!k.length){e=false;return}e=true;var q=k.slice(0);k=[];j.frames=f(q,-1);var p=j.compile();m.ondataavailable(p);console.debug("video recorded blob size:",bytesToSize(p.size));e=false};var k=[];var l=false;function g(){if(h){return}if(e){return setTimeout(g,100)}var p=new Date().getTime()-a;if(!p){return g()}a=new Date().getTime();c.drawImage(b,0,0,d.width,d.height);!h&&k.push({duration:p,image:d.toDataURL("image/webp")});if(!l&&!i(k[k.length-1])){l=true;m.onStartedDrawingNonBlankFrames()}setTimeout(g,10)}var h=false;this.stop=function(){h=true;this.requestData()};var d=document.createElement("canvas");var c=d.getContext("2d");var b;var a;var j;var n=this;function i(q,E,w){var z=document.createElement("canvas");z.width=d.width;z.height=d.height;var v=z.getContext("2d");var y={r:0,g:0,b:0};var F=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2));var C=E&&E>=0&&E<=1?E:0;var B=w&&w>=0&&w<=1?w:0;var r,u,D;var s=new Image();s.src=q.image;v.drawImage(s,0,0,d.width,d.height);var p=v.getImageData(0,0,d.width,d.height);r=0;u=p.data.length;D=p.data.length/4;for(var x=0;x<u;x+=4){var t={r:p.data[x],g:p.data[x+1],b:p.data[x+2]};var A=Math.sqrt(Math.pow(t.r-y.r,2)+Math.pow(t.g-y.g,2)+Math.pow(t.b-y.b,2));if(A<=F*C){r++}}if(D-r<=D*B){return false}else{return true}}function f(J,L,B,t){var I=document.createElement("canvas");I.width=d.width;I.height=d.height;var y=I.getContext("2d");var A=[];var D=L===-1;var x=(L&&L>0&&L<=J.length)?L:J.length;var K={r:0,g:0,b:0};var u=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2));var v=B&&B>=0&&B<=1?B:0;var r=t&&t>=0&&t<=1?t:0;var s=false;for(var F=0;F<x;F++){var C,p,H;if(!s){var z=new Image();z.src=J[F].image;y.drawImage(z,0,0,d.width,d.height);var E=y.getImageData(0,0,d.width,d.height);C=0;p=E.data.length;H=E.data.length/4;for(var q=0;q<p;q+=4){var w={r:E.data[q],g:E.data[q+1],b:E.data[q+2]};var G=Math.sqrt(Math.pow(w.r-K.r,2)+Math.pow(w.g-K.g,2)+Math.pow(w.b-K.b,2));if(G<=u*v){C++}}}if(!s&&H-C<=H*r){}else{if(D){s=true}A.push(J[F])}}A=A.concat(J.slice(x));if(A.length<=0){A.push(J[J.length-1])}return A}}function WhammyRecorder(a){this.start=function(d){d=d||1000;c=new WhammyRecorderHelper(a,this);for(var e in this){if(typeof this[e]!=="function"){c[e]=this[e]}}c.record();b=setInterval(function(){c.requestData()},d)};this.stop=function(){if(c){c.stop();clearTimeout(b)}};this.clearOldRecordedFrames=function(){if(c){c.clearOldRecordedFrames()}};this.ondataavailable=function(){};var c;var b}var Whammy=(function(){function j(t){var p=i(t);var r=30000;var q=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1000000,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:a(p.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:25541},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:p.width,id:176},{data:p.height,id:186}]}]}]}]}];var u=0;var w=0;while(u<t.length){var s=[];var o=0;do{s.push(t[u]);o+=t[u].duration;u++}while(u<t.length&&o<r);var n=0;var v={id:524531317,data:[{data:w,id:231}].concat(s.map(function(x){var y=l({discardable:0,frame:x.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(n)});n+=x.duration;return{data:y,id:163}}))};q[1].data.push(v);w+=o}return k(q)}function i(r){if(!r[0]){console.warn("Something went wrong. Maybe WebP format is not supported in the current browser.");return}var p=r[0].width,n=r[0].height,q=r[0].duration;for(var o=1;o<r.length;o++){q+=r[o].duration}return{duration:q,width:p,height:n}}function b(n){var o=[];while(n>0){o.push(n&255);n=n>>8}return new Uint8Array(o.reverse())}function h(n){return new Uint8Array(n.split("").map(function(o){return o.charCodeAt(0)}))}function d(p){var o=[];var q=(p.length%8)?(new Array(1+8-(p.length%8))).join("0"):"";p=q+p;for(var n=0;n<p.length;n+=8){o.push(parseInt(p.substr(n,8),2))}return new Uint8Array(o)}function k(u){var o=[];for(var q=0;q<u.length;q++){var p=u[q].data;if(typeof p=="object"){p=k(p)}if(typeof p=="number"){p=d(p.toString(2))}if(typeof p=="string"){p=h(p)}var r=p.size||p.byteLength||p.length;var s=Math.ceil(Math.ceil(Math.log(r)/Math.log(2))/8);var t=r.toString(2);var n=(new Array((s*7+7+1)-t.length)).join("0")+t;var v=(new Array(s)).join("0")+"1"+n;o.push(b(u[q].id));o.push(d(v));o.push(p)}return new Blob(o,{type:"video/webm"})}function e(p){var o="";var q=(p.length%8)?(new Array(1+8-(p.length%8))).join("0"):"";p=q+p;for(var n=0;n<p.length;n+=8){o+=String.fromCharCode(parseInt(p.substr(n,8),2))}return o}function m(u){var o="";for(var q=0;q<u.length;q++){var p=u[q].data;if(typeof p=="object"){p=m(p)}if(typeof p=="number"){p=e(p.toString(2))}var r=p.length;var s=Math.ceil(Math.ceil(Math.log(r)/Math.log(2))/8);var t=r.toString(2);var n=(new Array((s*7+7+1)-t.length)).join("0")+t;var v=(new Array(s)).join("0")+"1"+n;o+=e(u[q].id.toString(2))+e(v)+p}return o}function l(p){var n=0;if(p.keyframe){n|=128}if(p.invisible){n|=8}if(p.lacing){n|=(p.lacing<<1)}if(p.discardable){n|=1}if(p.trackNum>127){throw"TrackNumber > 127 not supported"}var o=[p.trackNum|128,p.timecode>>8,p.timecode&255,n].map(function(q){return String.fromCharCode(q)}).join("")+p.frame;return o}function c(u){var p=u.RIFF[0].WEBP[0];var o=p.indexOf("\x9d\x01\x2a");for(var r=0,t=[];r<4;r++){t[r]=p.charCodeAt(o+3+r)}var s,n,q;q=(t[1]<<8)|t[0];s=q&16383;q=(t[3]<<8)|t[2];n=q&16383;return{width:s,height:n,data:p,riff:u}}function f(o){var q=0;var s={};while(q<o.length){var r=o.substr(q,4);var n=parseInt(o.substr(q+4,4).split("").map(function(t){var u=t.charCodeAt(0).toString(2);return(new Array(8-u.length+1)).join("0")+u}).join(""),2);var p=o.substr(q+4+4,n);q+=4+4+n;s[r]=s[r]||[];if(r=="RIFF"||r=="LIST"){s[r].push(f(p))}else{s[r].push(p)}}return s}function a(n){return[].slice.call(new Uint8Array((new Float64Array([n])).buffer),0).map(function(o){return String.fromCharCode(o)}).reverse().join("")}function g(n){this.frames=[];this.duration=n||1;this.quality=100}g.prototype.add=function(o,n){if("canvas" in o){o=o.canvas}if("toDataURL" in o){o=o.toDataURL("image/webp",this.quality)}if(!(/^data:image\/webp;base64,/ig).test(o)){throw"Input must be formatted properly as a base64 encoded DataURI of type image/webp"}this.frames.push({image:o,duration:n||this.duration})};g.prototype.compile=function(){return new j(this.frames.map(function(o){var n=c(f(atob(o.image.slice(23))));n.duration=o.duration;return n}))};return{Video:g,toWebM:j}})();function GifRecorder(l){if(!window.GIFEncoder){throw"Please link: https://cdn.webrtc-experiment.com/gif-recorder.js"}this.start=function(p){p=p||1000;var n=this.videoWidth||320;var m=this.videoHeight||240;d.width=a.width=n;d.height=a.height=m;h=new GIFEncoder();h.setRepeat(0);h.setDelay(this.frameRate||200);h.setQuality(this.quality||1);h.start();c=Date.now();function o(q){i=requestAnimationFrame(o);if(typeof j===undefined){j=q}if(q-j<90){return}b.drawImage(a,0,0,n,m);h.addFrame(b);j=q}i=requestAnimationFrame(o);g=setTimeout(f,p)};function f(){e=Date.now();var m=new Blob([new Uint8Array(h.stream().bin)],{type:"image/gif"});k.ondataavailable(m);h.stream().bin=[]}this.stop=function(){if(i){cancelAnimationFrame(i);clearTimeout(g);f()}};this.ondataavailable=function(){};this.onstop=function(){};var k=this;var d=document.createElement("canvas");var b=d.getContext("2d");var a=document.createElement("video");a.muted=true;a.autoplay=true;a.src=URL.createObjectURL(l);a.play();var i=null;var c,e,j;var h;var g}function MultiStreamRecorder(b){if(!b){throw"MediaStream is mandatory."}var a=this;var g=!!navigator.mozGetUserMedia;this.stream=b;this.start=function(i){e=new MediaStreamRecorder(b);f=new MediaStreamRecorder(b);e.mimeType="audio/ogg";f.mimeType="video/webm";for(var j in this){if(typeof this[j]!=="function"){e[j]=f[j]=this[j]}}e.ondataavailable=function(k){if(!d[c]){d[c]={}}d[c].audio=k;if(d[c].video&&!d[c].onDataAvailableEventFired){d[c].onDataAvailableEventFired=true;h(d[c])}};f.ondataavailable=function(k){if(g){return a.ondataavailable({video:k,audio:k})}if(!d[c]){d[c]={}}d[c].video=k;if(d[c].audio&&!d[c].onDataAvailableEventFired){d[c].onDataAvailableEventFired=true;h(d[c])}};function h(k){c++;a.ondataavailable(k)}f.onstop=e.onstop=function(k){a.onstop(k)};if(!g){f.onStartedDrawingNonBlankFrames=function(){f.clearOldRecordedFrames();e.start(i)};f.start(i)}else{f.start(i)}};this.stop=function(){if(e){e.stop()}if(f){f.stop()}};this.ondataavailable=function(h){console.log("ondataavailable..",h)};this.onstop=function(h){console.warn("stopped..",h)};var e;var f;var d={};var c=0}function bytesToSize(a){var b=1000;var d=["Bytes","KB","MB","GB","TB"];if(a===0){return"0 Bytes"}var c=parseInt(Math.floor(Math.log(a)/Math.log(b)),10);return(a/Math.pow(b,c)).toPrecision(3)+" "+d[c]};
