tQuery.WebAudio=function(){console.assert(!0===tQuery.WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination)};tQuery.WebAudio.fn=tQuery.WebAudio.prototype;tQuery.WebAudio.prototype.destroy=function(){};tQuery.WebAudio.isAvailable=window.webkitAudioContext?!0:!1;
tQuery.WebAudio.prototype.context=function(){return this._ctx};tQuery.WebAudio.prototype._entryNode=function(){return this._gainNode};tQuery.WebAudio.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};tQuery.WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};tQuery.WebAudio.NodeChainBuilder.prototype.destroy=function(){};
tQuery.WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};tQuery.WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};tQuery.WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};
tQuery.WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
tQuery.WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};tQuery.WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
tQuery.WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};tQuery.WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};tQuery.WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
tQuery.WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof tQuery.WebAudio);void 0===b&&(b=(new tQuery.WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof tQuery.WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=
this._chain.nodes().analyser;this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};tQuery.WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};tQuery.WebAudio.Sound.fn=tQuery.WebAudio.Sound.prototype;
tQuery.WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};tQuery.WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};tQuery.WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c};tQuery.WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
tQuery.WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};tQuery.WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};tQuery.WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};
tQuery.WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};tQuery.WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
tQuery.WebAudio.Sound.prototype.amplitude=function(a){var a=void 0!==a?a:2,b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};tQuery.WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
tQuery.WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};tQuery.WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
tQuery.WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};tQuery.WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};tQuery.WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
tQuery.WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.register("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new tQuery.WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.register("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.register("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.register("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.register("supportWebAudio",function(){return tQuery.WebAudio.isAvailable});tQuery.register("createSound",function(a,b){a=a||tQuery.world;return new tQuery.WebAudio.Sound(a.getWebAudio(),b)});
tQuery.WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.camera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};tQuery.WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
tQuery.WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
tQuery.WebAudio=function(){console.assert(!0===tQuery.WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination)};tQuery.WebAudio.fn=tQuery.WebAudio.prototype;tQuery.WebAudio.prototype.destroy=function(){};tQuery.WebAudio.isAvailable=window.webkitAudioContext?!0:!1;
tQuery.WebAudio.prototype.context=function(){return this._ctx};tQuery.WebAudio.prototype._entryNode=function(){return this._gainNode};tQuery.WebAudio.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};tQuery.WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};tQuery.WebAudio.NodeChainBuilder.prototype.destroy=function(){};
tQuery.WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};tQuery.WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};tQuery.WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};
tQuery.WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
tQuery.WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};tQuery.WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
tQuery.WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};tQuery.WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};tQuery.WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
tQuery.WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof tQuery.WebAudio);void 0===b&&(b=(new tQuery.WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof tQuery.WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=
this._chain.nodes().analyser;this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};tQuery.WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};tQuery.WebAudio.Sound.fn=tQuery.WebAudio.Sound.prototype;
tQuery.WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};tQuery.WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};tQuery.WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c};tQuery.WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
tQuery.WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};tQuery.WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};tQuery.WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};
tQuery.WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};tQuery.WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
tQuery.WebAudio.Sound.prototype.amplitude=function(a){var a=void 0!==a?a:2,b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};tQuery.WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
tQuery.WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};tQuery.WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
tQuery.WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};tQuery.WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};tQuery.WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
tQuery.WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.register("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new tQuery.WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.register("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.register("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.register("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.register("supportWebAudio",function(){return tQuery.WebAudio.isAvailable});tQuery.register("createSound",function(a,b){a=a||tQuery.world;return new tQuery.WebAudio.Sound(a.getWebAudio(),b)});
tQuery.WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.camera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};tQuery.WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
tQuery.WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
WebAudio=function(){console.assert(!0===WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination)};WebAudio.fn=WebAudio.prototype;WebAudio.prototype.destroy=function(){};WebAudio.isAvailable=window.webkitAudioContext?!0:!1;WebAudio.prototype.context=function(){return this._ctx};
WebAudio.prototype.createSound=function(){return new WebAudio.Sound(this)};WebAudio.prototype._entryNode=function(){return this._gainNode};WebAudio.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};WebAudio.NodeChainBuilder.prototype.destroy=function(){};
WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof WebAudio);void 0===b&&(b=(new WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=this._chain.nodes().analyser;
this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};WebAudio.Sound.fn=WebAudio.Sound.prototype;WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};
WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c};WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};
WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
WebAudio.Sound.prototype.amplitude=function(a){var a=void 0!==a?a:2,b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.register("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.register("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.register("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.register("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.register("supportWebAudio",function(){return WebAudio.isAvailable});tQuery.register("createSound",function(a,b){a=a||tQuery.world;return new WebAudio.Sound(a.getWebAudio(),b)});WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.camera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};
WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
WebAudio=function(){console.assert(!0===WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination)};WebAudio.fn=WebAudio.prototype;WebAudio.prototype.destroy=function(){};WebAudio.isAvailable=window.webkitAudioContext?!0:!1;WebAudio.prototype.context=function(){return this._ctx};
WebAudio.prototype.createSound=function(){return new WebAudio.Sound(this)};WebAudio.prototype._entryNode=function(){return this._gainNode};WebAudio.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};WebAudio.NodeChainBuilder.prototype.destroy=function(){};
WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof WebAudio);void 0===b&&(b=(new WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=this._chain.nodes().analyser;
this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};WebAudio.Sound.fn=WebAudio.Sound.prototype;WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};
WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c};WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};
WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
WebAudio.Sound.prototype.amplitude=function(a){var a=void 0!==a?a:2,b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};
WebAudio.Flow=function(){var a,b=[],c=setTimeout(function(){c=null;a._next()},0);return a={destroy:function(){c&&clearTimeout(c)},par:function(c,e){(e||!(b[b.length-1]instanceof Array))&&b.push([]);b[b.length-1].push(c);return a},seq:function(b){return a.par(b,!0)},_next:function(c,e){for(var f=[],h=[],i=b.shift()||[],j=i.length,k=1==j,g=0;g<i.length;g++)(function(b,g){b(function(b,c){f[g]=b;h[g]=c;0==--j&&a._next(k?f[0]:f,k?h[0]:h)},c,e)})(i[g],g)}}};
WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.register("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.register("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.register("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.register("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.register("supportWebAudio",function(){return WebAudio.isAvailable});tQuery.register("createSound",function(a,b){a=a||tQuery.world;return new WebAudio.Sound(a.getWebAudio(),b)});WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.camera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};
WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
WebAudio=function(){console.assert(!0===WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination)};WebAudio.fn=WebAudio.prototype;WebAudio.prototype.destroy=function(){};WebAudio.isAvailable=window.webkitAudioContext?!0:!1;WebAudio.prototype.context=function(){return this._ctx};
WebAudio.prototype.createSound=function(){return new WebAudio.Sound(this)};WebAudio.prototype._entryNode=function(){return this._gainNode};WebAudio.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};WebAudio.NodeChainBuilder.prototype.destroy=function(){};
WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof WebAudio);void 0===b&&(b=(new WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=this._chain.nodes().analyser;
this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};WebAudio.Sound.fn=WebAudio.Sound.prototype;WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};
WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c};WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};WebAudio.Sound.prototype.buffer=function(a){if(void 0===a)return this._source.buffer;this._source.buffer=a;return this};WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};
WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
WebAudio.Sound.prototype.amplitude=function(a){var a=void 0!==a?a:2,b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};WebAudio.Sound.prototype.tone=function(a,b){for(var a=void 0!==a?a:200,b=void 0!==b?b:1,c=webaudio.context().createBuffer(1,44100*b,44100),d=c.getChannelData(0),e=0;e<d.length;e++)d[e]=2*Math.sin(a*(e/c.sampleRate)*Math.PI);this.buffer(c).loop(!0);return this};
WebAudio.Sound.prototype.makeHistogram=function(a){var b=this._analyser,c=this._privHisto=this._privHisto||new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var a=Math.floor(c.length/a),b=[],d=0,e=0;d<c.length;e++){for(var f=0,h=0;h<a;h++,d++)f+=c[d];b[e]=f/a}return b};WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};
WebAudio.Flow=function(){var a,b=[],c=setTimeout(function(){c=null;a._next()},0);return a={destroy:function(){c&&clearTimeout(c)},par:function(c,e){(e||!(b[b.length-1]instanceof Array))&&b.push([]);b[b.length-1].push(c);return a},seq:function(b){return a.par(b,!0)},_next:function(c,e){for(var f=[],h=[],i=b.shift()||[],j=i.length,k=1==j,g=0;g<i.length;g++)(function(b,g){b(function(b,c){f[g]=b;h[g]=c;0==--j&&a._next(k?f[0]:f,k?h[0]:h)},c,e)})(i[g],g)}}};
WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.register("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.register("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.register("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.register("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.register("supportWebAudio",function(){return WebAudio.isAvailable});tQuery.register("createSound",function(a,b){a=a||tQuery.world;return new WebAudio.Sound(a.getWebAudio(),b)});WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.camera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};
WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
WebAudio=function(){console.assert(!0===WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination)};WebAudio.fn=WebAudio.prototype;WebAudio.prototype.destroy=function(){};WebAudio.isAvailable=window.webkitAudioContext?!0:!1;WebAudio.prototype.context=function(){return this._ctx};
WebAudio.prototype.createSound=function(){return new WebAudio.Sound(this)};WebAudio.prototype._entryNode=function(){return this._gainNode};WebAudio.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};WebAudio.NodeChainBuilder.prototype.destroy=function(){};
WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof WebAudio);void 0===b&&(b=(new WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=this._chain.nodes().analyser;
this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};WebAudio.Sound.fn=WebAudio.Sound.prototype;WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};
WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c};WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};WebAudio.Sound.prototype.buffer=function(a){if(void 0===a)return this._source.buffer;this._source.buffer=a;return this};WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};
WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
WebAudio.Sound.prototype.amplitude=function(a){var a=void 0!==a?a:2,b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};WebAudio.Sound.prototype.tone=function(a,b){for(var a=void 0!==a?a:200,b=void 0!==b?b:1,c=webaudio.context().createBuffer(1,44100*b,44100),d=c.getChannelData(0),e=0;e<d.length;e++)d[e]=2*Math.sin(a*(e/c.sampleRate)*Math.PI);this.buffer(c).loop(!0);return this};
WebAudio.Sound.prototype.makeHistogram=function(a){var b=this._analyser,c=this._privHisto=this._privHisto||new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var a=Math.floor(c.length/a),b=[],d=0,e=0;d<c.length;e++){for(var f=0,h=0;h<a;h++,d++)f+=c[d];b[e]=f/a}return b};WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};
WebAudio.Flow=function(){var a,b=[],c=setTimeout(function(){c=null;a._next()},0);return a={destroy:function(){c&&clearTimeout(c)},par:function(c,e){(e||!(b[b.length-1]instanceof Array))&&b.push([]);b[b.length-1].push(c);return a},seq:function(b){return a.par(b,!0)},_next:function(c,e){for(var f=[],h=[],i=b.shift()||[],j=i.length,k=1==j,g=0;g<i.length;g++)(function(b,g){b(function(b,c){f[g]=b;h[g]=c;0==--j&&a._next(k?f[0]:f,k?h[0]:h)},c,e)})(i[g],g)}}};
WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.register("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.register("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.register("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.register("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.register("supportWebAudio",function(){return WebAudio.isAvailable});tQuery.register("createSound",function(a,b){a=a||tQuery.world;return new WebAudio.Sound(a.getWebAudio(),b)});WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.camera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};
WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
WebAudio=function(){console.assert(!0===WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination)};WebAudio.fn=WebAudio.prototype;WebAudio.prototype.destroy=function(){};WebAudio.isAvailable=window.webkitAudioContext?!0:!1;WebAudio.prototype.context=function(){return this._ctx};
WebAudio.prototype.createSound=function(){return new WebAudio.Sound(this)};WebAudio.prototype._entryNode=function(){return this._gainNode};WebAudio.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};WebAudio.NodeChainBuilder.prototype.destroy=function(){};
WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof WebAudio);void 0===b&&(b=(new WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=this._chain.nodes().analyser;
this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};WebAudio.Sound.fn=WebAudio.Sound.prototype;WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};
WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c};WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};WebAudio.Sound.prototype.buffer=function(a){if(void 0===a)return this._source.buffer;this._source.buffer=a;return this};WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};
WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
WebAudio.Sound.prototype.amplitude=function(a){var a=void 0!==a?a:2,b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};WebAudio.Sound.prototype.tone=function(a,b){for(var a=void 0!==a?a:200,b=void 0!==b?b:1,c=webaudio.context().createBuffer(1,44100*b,44100),d=c.getChannelData(0),e=0;e<d.length;e++)d[e]=2*Math.sin(a*(e/c.sampleRate)*Math.PI);this.buffer(c).loop(!0);return this};
WebAudio.Sound.prototype.makeHistogram=function(a){var b=this._analyser,c=this._privHisto=this._privHisto||new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var a=Math.floor(c.length/a),b=[],d=0,e=0;d<c.length;e++){for(var f=0,h=0;h<a;h++,d++)f+=c[d];b[e]=f/a}return b};WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};
WebAudio.Flow=function(){var a,b=[],c=setTimeout(function(){c=null;a._next()},0);return a={destroy:function(){c&&clearTimeout(c)},par:function(c,e){(e||!(b[b.length-1]instanceof Array))&&b.push([]);b[b.length-1].push(c);return a},seq:function(b){return a.par(b,!0)},_next:function(c,e){for(var f=[],h=[],i=b.shift()||[],j=i.length,k=1==j,g=0;g<i.length;g++)(function(b,g){b(function(b,c){f[g]=b;h[g]=c;0==--j&&a._next(k?f[0]:f,k?h[0]:h)},c,e)})(i[g],g)}}};
WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.register("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.register("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.register("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.register("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.register("supportWebAudio",function(){return WebAudio.isAvailable});tQuery.register("createSound",function(a,b){a=a||tQuery.world;return new WebAudio.Sound(a.getWebAudio(),b)});WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.camera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};
WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
WebAudio=function(){console.assert(!0===WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;x;this._muted=!1;this._volume=1;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination)};WebAudio.fn=WebAudio.prototype;WebAudio.prototype.destroy=function(){};WebAudio.isAvailable=window.webkitAudioContext?!0:!1;
WebAudio.prototype.context=function(){return this._ctx};WebAudio.prototype.createSound=function(){return new WebAudio.Sound(this)};WebAudio.prototype._entryNode=function(){return this._gainNode};WebAudio.prototype.volume=function(a){if(void 0===a)return this._volume;this._volume=!0;!1===this._muted&&(this._gainNode.gain.value=a);return this};WebAudio.prototype.mute=function(a){if(void 0===a)return this._muted;this._muted=a;this._gainNode.gain.value=this._muted?0:this._volume;return this};
WebAudio.prototype.toggleMute=function(){this.mute()?this.mute(!1):this.mute(!0)};WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};WebAudio.NodeChainBuilder.prototype.destroy=function(){};WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};
WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof WebAudio);void 0===b&&(b=(new WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=this._chain.nodes().analyser;
this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};WebAudio.Sound.fn=WebAudio.Sound.prototype;WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};
WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c};WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};WebAudio.Sound.prototype.buffer=function(a){if(void 0===a)return this._source.buffer;this._source.buffer=a;return this};WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};
WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
WebAudio.Sound.prototype.amplitude=function(a){var a=void 0!==a?a:2,b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};WebAudio.Sound.prototype.tone=function(a,b){for(var a=void 0!==a?a:200,b=void 0!==b?b:1,c=webaudio.context().createBuffer(1,44100*b,44100),d=c.getChannelData(0),e=0;e<d.length;e++)d[e]=2*Math.sin(a*(e/c.sampleRate)*Math.PI);this.buffer(c);return this};
WebAudio.Sound.prototype.makeHistogram=function(a){var b=this._analyser,c=this._privHisto=this._privHisto||new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var a=Math.floor(c.length/a),b=[],d=0,e=0;d<c.length;e++){for(var f=0,h=0;h<a;h++,d++)f+=c[d];b[e]=f/a}return b};WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};
WebAudio.Flow=function(){var a,b=[],c=setTimeout(function(){c=null;a._next()},0);return a={destroy:function(){c&&clearTimeout(c)},par:function(c,e){(e||!(b[b.length-1]instanceof Array))&&b.push([]);b[b.length-1].push(c);return a},seq:function(b){return a.par(b,!0)},_next:function(c,e){for(var f=[],h=[],i=b.shift()||[],j=i.length,k=1==j,g=0;g<i.length;g++)(function(b,g){b(function(b,c){f[g]=b;h[g]=c;0==--j&&a._next(k?f[0]:f,k?h[0]:h)},c,e)})(i[g],g)}}};
WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.register("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.register("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.register("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.register("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.register("supportWebAudio",function(){return WebAudio.isAvailable});tQuery.register("createSound",function(a,b){a=a||tQuery.world;return new WebAudio.Sound(a.getWebAudio(),b)});WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.tCamera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};
WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
WebAudio=function(){console.assert(!0===WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;this._muted=!1;this._volume=1;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination)};WebAudio.fn=WebAudio.prototype;WebAudio.prototype.destroy=function(){};WebAudio.isAvailable=window.webkitAudioContext?!0:!1;
WebAudio.prototype.context=function(){return this._ctx};WebAudio.prototype.createSound=function(){return new WebAudio.Sound(this)};WebAudio.prototype._entryNode=function(){return this._gainNode};WebAudio.prototype.volume=function(a){if(void 0===a)return this._volume;this._volume=a;!1===this._muted&&(this._gainNode.gain.value=this._volume);return this};WebAudio.prototype.mute=function(a){if(void 0===a)return this._muted;this._muted=a;this._gainNode.gain.value=this._muted?0:this._volume;return this};
WebAudio.prototype.toggleMute=function(){this.mute()?this.mute(!1):this.mute(!0)};WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};WebAudio.NodeChainBuilder.prototype.destroy=function(){};WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};
WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof WebAudio);void 0===b&&(b=(new WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=this._chain.nodes().analyser;
this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};WebAudio.Sound.fn=WebAudio.Sound.prototype;WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};
WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c};WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};WebAudio.Sound.prototype.buffer=function(a){if(void 0===a)return this._source.buffer;this._source.buffer=a;return this};WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};
WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
WebAudio.Sound.prototype.amplitude=function(a){var a=void 0!==a?a:2,b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};WebAudio.Sound.prototype.tone=function(a,b){for(var a=void 0!==a?a:200,b=void 0!==b?b:1,c=webaudio.context().createBuffer(1,44100*b,44100),d=c.getChannelData(0),e=0;e<d.length;e++)d[e]=2*Math.sin(a*(e/c.sampleRate)*Math.PI);this.buffer(c);return this};
WebAudio.Sound.prototype.makeHistogram=function(a){var b=this._analyser,c=this._privHisto=this._privHisto||new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var a=Math.floor(c.length/a),b=[],d=0,e=0;d<c.length;e++){for(var f=0,h=0;h<a;h++,d++)f+=c[d];b[e]=f/a}return b};WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};
WebAudio.Flow=function(){var a,b=[],c=setTimeout(function(){c=null;a._next()},0);return a={destroy:function(){c&&clearTimeout(c)},par:function(c,e){(e||!(b[b.length-1]instanceof Array))&&b.push([]);b[b.length-1].push(c);return a},seq:function(b){return a.par(b,!0)},_next:function(c,e){for(var f=[],h=[],i=b.shift()||[],j=i.length,k=1==j,g=0;g<i.length;g++)(function(b,g){b(function(b,c){f[g]=b;h[g]=c;0==--j&&a._next(k?f[0]:f,k?h[0]:h)},c,e)})(i[g],g)}}};
WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.register("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.register("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.register("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.register("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.register("supportWebAudio",function(){return WebAudio.isAvailable});tQuery.register("createSound",function(a,b){a=a||tQuery.world;return new WebAudio.Sound(a.getWebAudio(),b)});WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.tCamera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};
WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
WebAudio=function(){console.assert(!0===WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;this._muted=!1;this._volume=1;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination);this._pageVisibilityCtor()};WebAudio.fn=WebAudio.prototype;WebAudio.prototype.destroy=function(){this._pageVisibilityDtor()};
WebAudio.isAvailable=window.webkitAudioContext?!0:!1;WebAudio.prototype.context=function(){return this._ctx};WebAudio.prototype.createSound=function(){return new WebAudio.Sound(this)};WebAudio.prototype._entryNode=function(){return this._gainNode};WebAudio.prototype.volume=function(a){if(void 0===a)return this._volume;this._volume=a;!1===this._muted&&(this._gainNode.gain.value=this._volume);return this};
WebAudio.prototype.mute=function(a){if(void 0===a)return this._muted;this._muted=a;this._gainNode.gain.value=this._muted?0:this._volume;return this};WebAudio.prototype.toggleMute=function(){this.mute()?this.mute(!1):this.mute(!0)};
WebAudio.prototype._pageVisibilityCtor=function(){this._pageVisibilityEventStr=void 0!==document.hidden?"visibilitychange":void 0!==document.mozHidden?"mozvisibilitychange":void 0!==document.msHidden?"msvisibilitychange":void 0!==document.webkitHidden?"webkitvisibilitychange":console.assert(!1,"Page Visibility API unsupported");this._pageVisibilityDocumentStr=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?
"webkitHidden":console.assert(!1,"Page Visibility API unsupported");this._$pageVisibilityCallback=function(){console.log("dddd");this.mute(document[this._pageVisibilityDocumentStr]?!0:!1)}.bind(this);document.addEventListener(this._pageVisibilityEventStr,this._$pageVisibilityCallback,!1)};WebAudio.prototype._pageVisibilityDtor=function(){document.removeEventListener(this._pageVisibilityEventStr,this._$pageVisibilityCallback,!1)};
WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};WebAudio.NodeChainBuilder.prototype.destroy=function(){};WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};
WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof WebAudio);void 0===b&&(b=(new WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=this._chain.nodes().analyser;
this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};WebAudio.Sound.fn=WebAudio.Sound.prototype;WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};
WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c};WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};WebAudio.Sound.prototype.buffer=function(a){if(void 0===a)return this._source.buffer;this._source.buffer=a;return this};WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};
WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
WebAudio.Sound.prototype.amplitude=function(a){var a=void 0!==a?a:2,b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};WebAudio.Sound.prototype.tone=function(a,b){for(var a=void 0!==a?a:200,b=void 0!==b?b:1,c=webaudio.context().createBuffer(1,44100*b,44100),d=c.getChannelData(0),e=0;e<d.length;e++)d[e]=2*Math.sin(a*(e/c.sampleRate)*Math.PI);this.buffer(c);return this};
WebAudio.Sound.prototype.makeHistogram=function(a){var b=this._analyser,c=this._privHisto=this._privHisto||new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var a=Math.floor(c.length/a),b=[],d=0,e=0;d<c.length;e++){for(var f=0,h=0;h<a;h++,d++)f+=c[d];b[e]=f/a}return b};WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};
WebAudio.Flow=function(){var a,b=[],c=setTimeout(function(){c=null;a._next()},0);return a={destroy:function(){c&&clearTimeout(c)},par:function(c,e){(e||!(b[b.length-1]instanceof Array))&&b.push([]);b[b.length-1].push(c);return a},seq:function(b){return a.par(b,!0)},_next:function(c,e){for(var f=[],h=[],i=b.shift()||[],j=i.length,k=1==j,g=0;g<i.length;g++)(function(b,g){b(function(b,c){f[g]=b;h[g]=c;0==--j&&a._next(k?f[0]:f,k?h[0]:h)},c,e)})(i[g],g)}}};
WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.register("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.register("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.register("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.register("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.register("supportWebAudio",function(){return WebAudio.isAvailable});tQuery.register("createSound",function(a,b){a=a||tQuery.world;return new WebAudio.Sound(a.getWebAudio(),b)});WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.tCamera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};
WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
WebAudio=function(){console.assert(!0===WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;this._muted=!1;this._volume=1;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination);this._pageVisibilityCtor()};WebAudio.fn=WebAudio.prototype;WebAudio.prototype.destroy=function(){this._pageVisibilityDtor()};
WebAudio.isAvailable=window.webkitAudioContext?!0:!1;WebAudio.prototype.context=function(){return this._ctx};WebAudio.prototype.createSound=function(){return new WebAudio.Sound(this)};WebAudio.prototype._entryNode=function(){return this._gainNode};WebAudio.prototype.volume=function(a){if(void 0===a)return this._volume;this._volume=a;!1===this._muted&&(this._gainNode.gain.value=this._volume);return this};
WebAudio.prototype.mute=function(a){if(void 0===a)return this._muted;this._muted=a;this._gainNode.gain.value=this._muted?0:this._volume;return this};WebAudio.prototype.toggleMute=function(){this.mute()?this.mute(!1):this.mute(!0)};
WebAudio.prototype._pageVisibilityCtor=function(){this._pageVisibilityEventStr=void 0!==document.hidden?"visibilitychange":void 0!==document.mozHidden?"mozvisibilitychange":void 0!==document.msHidden?"msvisibilitychange":void 0!==document.webkitHidden?"webkitvisibilitychange":console.assert(!1,"Page Visibility API unsupported");this._pageVisibilityDocumentStr=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?
"webkitHidden":console.assert(!1,"Page Visibility API unsupported");this._$pageVisibilityCallback=function(){this.mute(document[this._pageVisibilityDocumentStr]?!0:!1)}.bind(this);document.addEventListener(this._pageVisibilityEventStr,this._$pageVisibilityCallback,!1)};WebAudio.prototype._pageVisibilityDtor=function(){document.removeEventListener(this._pageVisibilityEventStr,this._$pageVisibilityCallback,!1)};
WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};WebAudio.NodeChainBuilder.prototype.destroy=function(){};WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};
WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof WebAudio);void 0===b&&(b=(new WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=this._chain.nodes().analyser;
this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};WebAudio.Sound.fn=WebAudio.Sound.prototype;WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};
WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c};WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};WebAudio.Sound.prototype.buffer=function(a){if(void 0===a)return this._source.buffer;this._source.buffer=a;return this};WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};
WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
WebAudio.Sound.prototype.amplitude=function(a){var a=void 0!==a?a:2,b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};WebAudio.Sound.prototype.tone=function(a,b){for(var a=void 0!==a?a:200,b=void 0!==b?b:1,c=webaudio.context().createBuffer(1,44100*b,44100),d=c.getChannelData(0),e=0;e<d.length;e++)d[e]=2*Math.sin(a*(e/c.sampleRate)*Math.PI);this.buffer(c);return this};
WebAudio.Sound.prototype.makeHistogram=function(a){var b=this._analyser,c=this._privHisto=this._privHisto||new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var a=Math.floor(c.length/a),b=[],d=0,e=0;d<c.length;e++){for(var f=0,h=0;h<a;h++,d++)f+=c[d];b[e]=f/a}return b};WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};
WebAudio.Flow=function(){var a,b=[],c=setTimeout(function(){c=null;a._next()},0);return a={destroy:function(){c&&clearTimeout(c)},par:function(c,e){(e||!(b[b.length-1]instanceof Array))&&b.push([]);b[b.length-1].push(c);return a},seq:function(b){return a.par(b,!0)},_next:function(c,e){for(var f=[],h=[],i=b.shift()||[],j=i.length,k=1==j,g=0;g<i.length;g++)(function(b,g){b(function(b,c){f[g]=b;h[g]=c;0==--j&&a._next(k?f[0]:f,k?h[0]:h)},c,e)})(i[g],g)}}};
WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.register("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.register("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.register("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.register("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.register("supportWebAudio",function(){return WebAudio.isAvailable});tQuery.register("createSound",function(a,b){a=a||tQuery.world;return new WebAudio.Sound(a.getWebAudio(),b)});WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.tCamera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};
WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
WebAudio=function(){console.assert(!0===WebAudio.isAvailable,"webkitAudioContext isnt available on your browser");this._ctx=new webkitAudioContext;this._muted=!1;this._volume=1;this._gainNode=this._ctx.createGainNode();this._compressor=this._ctx.createDynamicsCompressor();this._gainNode.connect(this._compressor);this._compressor.connect(this._ctx.destination);this._pageVisibilityCtor()};WebAudio.fn=WebAudio.prototype;WebAudio.prototype.destroy=function(){this._pageVisibilityDtor()};
WebAudio.isAvailable=window.webkitAudioContext?!0:!1;WebAudio.prototype.context=function(){return this._ctx};WebAudio.prototype.createSound=function(){return new WebAudio.Sound(this)};WebAudio.prototype._entryNode=function(){return this._gainNode};WebAudio.prototype.volume=function(a){if(void 0===a)return this._volume;this._volume=a;!1===this._muted&&(this._gainNode.gain.value=this._volume);return this};
WebAudio.prototype.mute=function(a){if(void 0===a)return this._muted;this._muted=a;this._gainNode.gain.value=this._muted?0:this._volume;return this};WebAudio.prototype.toggleMute=function(){this.mute()?this.mute(!1):this.mute(!0)};
WebAudio.prototype._pageVisibilityCtor=function(){this._pageVisibilityEventStr=void 0!==document.hidden?"visibilitychange":void 0!==document.mozHidden?"mozvisibilitychange":void 0!==document.msHidden?"msvisibilitychange":void 0!==document.webkitHidden?"webkitvisibilitychange":console.assert(!1,"Page Visibility API unsupported");this._pageVisibilityDocumentStr=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?
"webkitHidden":console.assert(!1,"Page Visibility API unsupported");this._$pageVisibilityCallback=function(){this.mute(document[this._pageVisibilityDocumentStr]?!0:!1)}.bind(this);document.addEventListener(this._pageVisibilityEventStr,this._$pageVisibilityCallback,!1)};WebAudio.prototype._pageVisibilityDtor=function(){document.removeEventListener(this._pageVisibilityEventStr,this._$pageVisibilityCallback,!1)};
WebAudio.NodeChainBuilder=function(a){console.assert(a instanceof webkitAudioContext);this._context=a;this._lastNode=this._firstNode=null;this._nodes={}};WebAudio.NodeChainBuilder.prototype.destroy=function(){};WebAudio.NodeChainBuilder.prototype.nodes=function(){return this._nodes};WebAudio.NodeChainBuilder.prototype.first=function(){return this._firstNode};WebAudio.NodeChainBuilder.prototype.last=function(){return this._lastNode};
WebAudio.NodeChainBuilder.prototype._addNode=function(a,b){this._lastNode&&"playbackRate"in this._lastNode&&(this._bufferSourceDst=a);null!==this._lastNode&&this._lastNode.connect(a);null===this._firstNode&&(this._firstNode=a);this._lastNode=a;for(var c in b)a[c]=b[c];return this};
WebAudio.NodeChainBuilder.prototype.cloneBufferSource=function(){console.assert(this._nodes.bufferSource,"no buffersource presents. Add one.");var a=this._nodes.bufferSource,b=this._context.createBufferSource();b.buffer=a.buffer;b.playbackRate=a.playbackRate;b.loop=a.loop;b.connect(this._bufferSourceDst);return b};WebAudio.NodeChainBuilder.prototype.bufferSource=function(a){var b=this._context.createBufferSource();this._nodes.bufferSource=b;return this._addNode(b,a)};
WebAudio.NodeChainBuilder.prototype.mediaStreamSource=function(a,b){var c=this._context.createMediaStreamSource(a);this._nodes.bufferSource=c;return this._addNode(c,b)};WebAudio.NodeChainBuilder.prototype.panner=function(a){var b=this._context.createPanner();this._nodes.panner=b;return this._addNode(b,a)};WebAudio.NodeChainBuilder.prototype.analyser=function(a){var b=this._context.createAnalyser();this._nodes.analyser=b;return this._addNode(b,a)};
WebAudio.NodeChainBuilder.prototype.gainNode=function(a){var b=this._context.createGainNode();this._nodes.gainNode=b;return this._addNode(b,a)};
WebAudio.Sound=function(a,b){this._webaudio=a;this._context=this._webaudio.context();console.assert(this._webaudio instanceof WebAudio);void 0===b&&(b=(new WebAudio.NodeChainBuilder(this._context)).bufferSource().gainNode().analyser().panner());console.assert(b instanceof WebAudio.NodeChainBuilder);this._chain=b;this._chain.last().connect(this._webaudio._entryNode());this._source=this._chain.nodes().bufferSource;this._gainNode=this._chain.nodes().gainNode;this._analyser=this._chain.nodes().analyser;
this._panner=this._chain.nodes().panner;console.assert(this._source,"no bufferSource: not yet supported");console.assert(this._gainNode,"no gainNode: not yet supported");console.assert(this._analyser,"no analyser: not yet supported");console.assert(this._panner,"no panner: not yet supported")};WebAudio.Sound.prototype.destroy=function(){this._chain.last().disconnect();this._chain.destroy();this._chain=null};WebAudio.Sound.fn=WebAudio.Sound.prototype;WebAudio.Sound.prototype.nodes=function(){return this._chain.nodes()};
WebAudio.Sound.prototype.isPlayable=function(){return this._source.buffer?!0:!1};WebAudio.Sound.prototype.play=function(a){void 0===a&&(a=0);if(!1!==this.isPlayable()){var b=this._chain.cloneBufferSource();b.noteOn(a);var c={node:b,stop:function(a){void 0===a&&(a=0);this.node.noteOff(a);return c}};return c}};WebAudio.Sound.prototype.volume=function(a){if(void 0===a)return this._gainNode.gain.value;this._gainNode.gain.value=a;return this};
WebAudio.Sound.prototype.loop=function(a){if(void 0===a)return this._source.loop;this._source.loop=a;return this};WebAudio.Sound.prototype.buffer=function(a){if(void 0===a)return this._source.buffer;this._source.buffer=a;return this};WebAudio.Sound.prototype.pannerCone=function(a,b,c){this._panner.coneInnerAngle=180*a/Math.PI;this._panner.coneOuterAngle=180*b/Math.PI;this._panner.coneOuterGain=c;return this};
WebAudio.Sound.prototype.pannerConeInnerAngle=function(a){if(void 0===a)return this._panner.coneInnerAngle/180*Math.PI;this._panner.coneInnerAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterAngle=function(a){if(void 0===a)return this._panner.coneOuterAngle/180*Math.PI;this._panner.coneOuterAngle=180*a/Math.PI;return this};WebAudio.Sound.prototype.pannerConeOuterGain=function(a){if(void 0===a)return this._panner.coneOuterGain;this._panner.coneOuterGain=a;return this};
WebAudio.Sound.prototype.amplitude=function(a){a=void 0!==a?a:2;var b=this._analyser,c=new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);for(var d=b=0;d<a;d++)b+=c[d];return b/(256*a-1)};WebAudio.Sound.prototype.tone=function(a,b){a=void 0!==a?a:200;b=void 0!==b?b:1;for(var c=webaudio.context().createBuffer(1,44100*b,44100),d=c.getChannelData(0),e=0;e<d.length;e++)d[e]=2*Math.sin(a*(e/c.sampleRate)*Math.PI);this.buffer(c);return this};
WebAudio.Sound.prototype.makeHistogram=function(a){var b=this._analyser,c=this._privHisto=this._privHisto||new Uint8Array(b.frequencyBinCount);b.getByteFrequencyData(c);a=Math.floor(c.length/a);for(var b=[],d=0,e=0;d<c.length;e++){for(var f=0,h=0;h<a;h++,d++)f+=c[d];b[e]=f/a}return b};WebAudio.Sound.prototype.load=function(a,b){this._loadAndDecodeSound(a,function(a){this._source.buffer=a;b&&b(this)}.bind(this),function(){console.warn("unable to load sound "+a)});return this};
WebAudio.Sound.prototype._loadAndDecodeSound=function(a,b,c){var d=this._context,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.decodeAudioData(e.response,function(a){b&&b(a)},function(){c&&c()})};e.send()};
WebAudio.Flow=function(){var a,b=[],c=setTimeout(function(){c=null;a._next()},0);return a={destroy:function(){c&&clearTimeout(c)},par:function(c,e){(e||!(b[b.length-1]instanceof Array))&&b.push([]);b[b.length-1].push(c);return a},seq:function(b){return a.par(b,!0)},_next:function(c,e){for(var f=[],h=[],j=b.shift()||[],k=j.length,l=1==k,g=0;g<j.length;g++)(function(b,g){b(function(b,c){f[g]=b;h[g]=c;0==--k&&a._next(l?f[0]:f,l?h[0]:h)},c,e)})(j[g],g)}}};
WebAudio.Sound.fn.updateWithObject3d=function(a,b){console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();this.updateWithMatrix4(a.matrixWorld,b);return this};
WebAudio.Sound.fn.updateWithMatrix4=function(a,b){console.assert(a instanceof THREE.Matrix4);console.assert("number"===typeof b);var c=a.getPosition();this._panner.setPosition(c.x,c.y,c.z);var c=new THREE.Vector3(0,0,1),d=a.clone();d.setPosition({x:0,y:0,z:0});d.multiplyVector3(c);c.normalize();this._panner.setOrientation(c.x,c.y,c.z);void 0===this._prevPos?this._prevPos=a.getPosition().clone():(c=a.getPosition(),c=c.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.getPosition().clone(),
this._panner.setVelocity(c.x,c.y,c.z))};WebAudio.Sound.fn.follow=function(a,b){console.assert(!1===this.isFollowing());a instanceof tQuery.Object3D&&(console.assert(1===a.length),a=a.get(0));console.assert(a instanceof THREE.Object3D);this._followCb=function(b){this.updateWithObject3d(a,b)}.bind(this);b.loop().hook(this._followCb);return this};WebAudio.Sound.fn.unfollow=function(){this._world.loop().unhook(this._followCb);this._followCb=null;return this};
WebAudio.Sound.prototype.isFollowing=function(){return this._followCb?!0:!1};tQuery.World.registerInstance("enableWebAudio",function(){console.assert(!1===this.hasWebAudio(),"there is already a webaudio");var a=new WebAudio;a.followListener(this);tQuery.data(this,"webaudio",a);return this});tQuery.World.registerInstance("disabledWebAudio",function(){if(!1===this.hasWebAudio())return this;tQuery.data(this,"webaudio").destroy();tQuery.removeData(this,"webaudio");return this});
tQuery.World.registerInstance("getWebAudio",function(){return tQuery.data(this,"webaudio")});tQuery.World.registerInstance("hasWebAudio",function(){return tQuery.data(this,"webaudio")?!0:!1});tQuery.World.registerInstance("supportWebAudio",function(){return WebAudio.isAvailable});tQuery.registerStatic("createSound",function(a,b){a=a||tQuery.world;return new WebAudio.Sound(a.getWebAudio(),b)});
WebAudio.fn.followListener=function(a){this._$followListenerCb=function(b){this._followListenerCb(a.tCamera(),b)}.bind(this);a.loop().hook(this._$followListenerCb)};WebAudio.fn.unfollowListener=function(a){a.loop().unhook(this._$followListenerCb);this._$followListenerCb=null};
WebAudio.fn._followListenerCb=function(a,b){var c=this._ctx;console.assert(a instanceof THREE.Object3D);console.assert("number"===typeof b);a.updateMatrixWorld();var d=a.matrixWorld.getPosition();c.listener.setPosition(d.x,d.y,d.z);d=a.matrixWorld.clone();d.setPosition({x:0,y:0,z:0});var e=new THREE.Vector3(0,0,1);d.multiplyVector3(e);e.normalize();var f=new THREE.Vector3(0,-1,0);d.multiplyVector3(f);f.normalize();c.listener.setOrientation(e.x,e.y,e.z,f.x,f.y,f.z);void 0===this._prevPos?this._prevPos=
a.matrixWorld.getPosition().clone():(d=a.matrixWorld.getPosition(),d=d.clone().subSelf(this._prevPos).divideScalar(b),this._prevPos=a.matrixWorld.getPosition().clone(),c.listener.setVelocity(d.x,d.y,d.z))};
