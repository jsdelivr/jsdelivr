YUI.add("gallery-querybuilder-extras",function(d){var b=d.Lang,a=(0<d.UA.ie&&d.UA.ie<9),c=d.DataType.Date;d.QueryBuilder.Calendar=function(f,e){this.qb=f;this.op_menu_name_pattern=e.field_prefix+"query_op_{i}";this.val_input_name_pattern=e.field_prefix+"query_val_{i}_c{j}";};d.QueryBuilder.Calendar.prototype={create:function(e,m,p,n){var f,j,g;f=this.qb._createContainer();f.set("className",this.qb.getClassName("operator"));f.set("innerHTML",this._operationsMenu(this.operationName(e)));this.op_menu=f.one("select");this.date_format=m.date_format||"%m/%d/%Y";this.value_input=[];this.value_input_normalized=[];var q=d.Node.getDOMNode(this.op_menu).options;for(var h=0;h<p.length;h++){q[h]=new Option(p[h].text,p[h].value);}n=n||["",""];if(n[0]){this.op_menu.set("value",n[0]);}if(a){this.op_menu.on("change",this.qb._notifyChanged,this.qb);}this._createDateRangeCalendar(m);var l=n[1]||m.start_date;var k=n[2]||m.end_date;if(n[2]){visible=true;}else{visible=p[0].multipleValue;}j=this._createCellValue(e,m,p,n,l,true,0);g=this._createCellValue(e,m,p,n,k,visible,1);var o=this;this.op_menu.on("change",function(){var i=this.get("value");for(h=0;h<p.length;h++){if(i===p[h].value){if(p[h].multipleValue){o.value_input[1].setStyle("display","inherit");o.hasMultipleSelection=true;}else{o.value_input[1].setStyle("display","none");o.hasMultipleSelection=false;}}}});return[f,j,g];},postCreate:function(g,f,e,h){},validate:function(){if(!this.hasMultipleSelection){return true;}if(this.value_input_normalized[0]>this.value_input_normalized[1]){this.qb.displayFieldMessage(this.value_input[0],"Please select a valid date range","error");return false;}return true;},destroy:function(){this.op_menu=null;for(var e=0;e<this.value_input;e++){this.value_input[e]=null;}},updateName:function(e){this.op_menu.setAttribute("name",this.operationName(e));for(var f=0;f<this.value_input;f++){this.value_input[f].setAttribute("name",this.valueName(e,f));}},set:function(f,g){this.op_menu.set("value",g[this.operationName(f)]);for(var e=0;e<this.value_input;e++){this.value_input[e].set("value",g[this.valueName(f,1)]);}},toDatabaseQuery:function(){var e=[this.value_input[0].get("value")];if(this.hasMultipleSelection){e.push(this.value_input[1].get("value"));}return[[this.op_menu.get("value"),e]];},operationName:function(e){return d.Lang.sub(this.op_menu_name_pattern,{i:e});},valueName:function(f,e){return d.Lang.sub(this.val_input_name_pattern,{i:f,j:e});},_operationsMenu:function(f){var e='<select name="{n}" class="{f} {c}" />';return d.Lang.sub(e,{n:f,f:d.FormManager.field_marker_class,c:this.qb.getClassName("field")});},_valueInput:function(g,f){var e='<input type="text" name="{n}" class="yiv-required {f} {c}"/>';return d.Lang.sub(e,{n:g,f:d.FormManager.field_marker_class,c:f+" "+this.qb.getClassName("field")});},_createCellValue:function(e,i,l,j,f,g,h){var m,k;f=f||new Date();m=this.qb._createContainer();k=this._valueInput(this.valueName(e,0),i.validation);m.set("className",this.qb.getClassName("value"));m.set("innerHTML",k);this.value_input[h]=m.one("input");this.value_input[h].set("value",j[1]);this.value_input[h].set("value",c.format(f,{format:this.date_format}));this.value_input_normalized[h]=f;this.value_input[h].on("click",d.bind(this._showCalendarOverlay,this,h));if(!g){this.value_input[h].setStyle("display","none");this.hasMultipleSelection=false;}return m;},_showCalendarOverlay:function(f){var g;g=d.WidgetPositionAlign;var e=this.qb.dateRangeCalendar.overlay;e.show();e.set("align",{node:this.value_input[f],points:[g.TC,g.RC]});this.qb.dateRangeCalendar.calendar.deselectDates();this.qb.focusedInputBox=this.value_input[f];this.qb.value_input_normalized=this.value_input_normalized;this.qb.focusedIndex=f;},_createDateRangeCalendar:function(g){var i,f,h,e;i=g.calendar_config||{};if(this.qb.dateRangeCalendar){return;}f={height:"215px",width:"200px",visible:true,showPrevMonth:true,showNextMonth:true,date:new Date()};for(key in f){i[key]=i[key]||f[key];}h=new d.Calendar(i).render();e=new d.Overlay({height:g.height,width:g.width,visible:false});e.render();e.plug(d.Plugin.OverlayAutohide);e.set("bodyContent",h.get("boundingBox"));e.get("boundingBox").addClass("yui3-querybuilder-extras");this.qb.dateRangeCalendar={overlay:e,calendar:h};h.on("selectionChange",this._updateTheFocusedInputBox,this);},_updateTheFocusedInputBox:function(f){var e=f.newSelection[0];if(e&&this.qb.dateRangeCalendar){this.qb.value_input_normalized[this.qb.focusedIndex]=e;this.qb.focusedInputBox.set("value",c.format(e,{format:this.date_format}));this.qb.dateRangeCalendar.overlay.hide();}},getCalendar:function(){return this.qb.dateRangeCalendar.calendar;},getOverlay:function(){return this.qb.dateRangeCalendar.overlay;}};d.QueryBuilder.plugin_mapping.calendar=d.QueryBuilder.Calendar;},"gallery-2012.08.08-20-03",{requires:["calendar","datatype-date","gallery-overlay-extras","gallery-querybuilder"],skinnable:true});