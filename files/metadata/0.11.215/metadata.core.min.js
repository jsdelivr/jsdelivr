/*!
 metadata.js &copy; Evgeniy Malyarov http://www.oknosoft.ru 2014-2016
 metadata.js may be freely distributed under the AGPL-3.0. To obtain _Oknosoft Commercial license_, contact info@oknosoft.ru
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.$p=t()}(this,function(){function e(){this.__define({version:{value:"0.11.215",writable:!1},toString:{value:function(){return"Oknosoft data engine. v:"+this.version},writable:!1},utils:{value:new t},injected_data:{value:{},writable:!1},ajax:{value:new n,writable:!1},msg:{value:new a,writable:!1},wsql:{value:new r,writable:!1},eve:{value:new N,writable:!1},aes:{value:new T("metadata.js"),writable:!1},moment:{get:function(){return this.utils.moment}},_patch:{value:function(e,t){for(var n in t)"object"==typeof t[n]&&e[n]&&"object"==typeof e[n]?M._patch(e[n],t[n]):e[n]=t[n];return e}},_find:{value:function(e,t,n){var r,a,i;if("object"!=typeof t)for(a in e){r=e[a];for(var o in r)if("function"!=typeof r[o]&&M.utils.is_equal(r[o],t))return r}else for(a in e){r=e[a],i=!0;for(var o in t)if("function"!=typeof r[o]&&!M.utils.is_equal(r[o],t[o])){i=!1;break}if(i)return r}}},_selection:{value:function(e,t){var n,r,a,i=!0;if(t)if("function"==typeof t)i=t.call(this,e);else for(n in t)if(r=t[n],a="object"==typeof r,"_"!=n.substr(0,1))if("function"==typeof r){if(i=r.call(this,e,n),!i)break}else if("or"==n&&Array.isArray(r)){if(i=r.some(function(t){var n=Object.keys(t)[0];return t[n].hasOwnProperty("like")?e[n]&&e[n].toLowerCase().indexOf(t[n].like.toLowerCase())!=-1:M.utils.is_equal(e[n],t[n])}),!i)break}else if(a&&r.hasOwnProperty("like")){if(!e[n]||e[n].toLowerCase().indexOf(r.like.toLowerCase())==-1){i=!1;break}}else if(a&&r.hasOwnProperty("not")){if(M.utils.is_equal(e[n],r.not)){i=!1;break}}else if(a&&r.hasOwnProperty("in")){if(i=r.in.some(function(t){return M.utils.is_equal(t,e[n])}),!i)break}else if(a&&r.hasOwnProperty("lt")){if(i=e[n]<r.lt,!i)break}else if(a&&r.hasOwnProperty("gt")){if(i=e[n]>r.gt,!i)break}else if(a&&r.hasOwnProperty("between")){var o=e[n];if("number"!=typeof o&&(o=M.utils.fix_date(e[n])),i=o>=r.between[0]&&o<=r.between[1],!i)break}else if(!M.utils.is_equal(e[n],r)){i=!1;break}return i}},_find_rows:{value:function(e,t,n){var r,a,i=[],o=0;t&&(t._top?(a=t._top,delete t._top):a=300);for(var s in e)if(r=e[s],M._selection.call(this,r,t)){if(n){if(n.call(this,r)===!1)break}else i.push(r);if(a&&(o++,o>=a))break}return i}},on:{value:function(e,t){if("object"!=typeof e)return this.eve.attachEvent(e,t);for(var n in e)e[n]._evnts||(e[n]._evnts=[]),e[n]._evnts.push(this.eve.attachEvent(n,e[n]))}},off:{value:function(e){"function"==typeof e&&e._evnts?e._evnts.forEach(function(e){M.eve.detachEvent(e)}):e?M.eve.detachEvent(e):M.eve.detachAllEvents()}},record_log:{value:function(e){M.ireg&&M.ireg.$log&&M.ireg.$log.record(e),console.log(e)}},md:{value:new o},enm:{value:new function(){this.toString=function(){return M.msg.meta_enn_mgr}}},cat:{value:new function(){this.toString=function(){return M.msg.meta_cat_mgr}}},doc:{value:new function(){this.toString=function(){return M.msg.meta_doc_mgr}}},ireg:{value:new function(){this.toString=function(){return M.msg.meta_ireg_mgr}}},areg:{value:new function(){this.toString=function(){return M.msg.meta_areg_mgr}}},"aссreg":{value:new function(){this.toString=function(){return M.msg.meta_accreg_mgr}}},dp:{value:new function(){this.toString=function(){return M.msg.meta_dp_mgr}}},rep:{value:new function(){this.toString=function(){return M.msg.meta_reports_mgr}}},cacc:{value:new function(){this.toString=function(){return M.msg.meta_charts_of_accounts_mgr}}},cch:{value:new function(){this.toString=function(){return M.msg.meta_charts_of_characteristic_mgr}}},tsk:{value:new function(){this.toString=function(){return M.msg.meta_task_mgr}}},bp:{value:new function(){this.toString=function(){return M.msg.meta_bp_mgr}}},DataManager:{value:s},RefDataManager:{value:_},DataProcessorsManager:{value:u},EnumManager:{value:l},RegisterManager:{value:c},InfoRegManager:{value:f},InfoRegManager:{value:f},LogManager:{value:d},AccumRegManager:{value:p},CatManager:{value:h},ChartOfCharacteristicManager:{value:m},ChartOfAccountManager:{value:y},DocManager:{value:g},TaskManager:{value:b},BusinessProcessManager:{value:v},DataObj:{value:j},CatObj:{value:O},DocObj:{value:k},DataProcessorObj:{value:q},TaskObj:{value:A},BusinessProcessObj:{value:D},EnumObj:{value:R},RegisterRow:{value:P},TabularSection:{value:w},TabularSectionRow:{value:x}})}function t(){this.moment="function"==typeof moment?moment:require("moment"),this.moment._masks={date:"DD.MM.YY",date_time:"DD.MM.YYYY HH:mm",ldt:"DD MMMM YYYY, HH:mm",iso:"YYYY-MM-DDTHH:mm:ss"},this.fix_date=function(e,t){if(e instanceof Date)return e;var n=this.moment(e,["DD-MM-YYYY","DD-MM-YYYY HH:mm","DD-MM-YYYY HH:mm:ss","DD-MM-YY HH:mm","YYYYDDMMHHmmss",this.moment.ISO_8601]);return n.isValid()?n.toDate():t?this.blank.date:e},this.fix_guid=function(e,t){if(e&&"string"==typeof e);else{if(e instanceof j)return e.ref;if(e&&"object"==typeof e)if(e.presentation){if(e.ref)return e.ref;if(e.name)return e.name}else e="object"==typeof e.ref&&e.ref.hasOwnProperty("ref")?e.ref.ref:e.ref}return this.is_guid(e)||t===!1?e:t?this.generate_guid():this.blank.guid},this.fix_number=function(e,t){var n=parseFloat(e);return isNaN(n)?t?0:e:n},this.fix_boolean=function(e){return"string"==typeof e?!(!e||"false"==e.toLowerCase()):!!e},this.blank={date:this.fix_date("0001-01-01T00:00:00"),guid:"00000000-0000-0000-0000-000000000000",by_type:function(e){var t;return t=e.is_ref?this.guid:e.date_part?this.date:e.digits?0:(!e.types||"boolean"!=e.types[0])&&""}},this.fetch_type=function(e,t){var n=e;return t.is_ref?n=this.fix_guid(e):t.date_part?n=this.fix_date(e,!0):t.digits?n=this.fix_number(e,!0):"boolean"==t.types[0]&&(n=this.fix_boolean(e)),n},this.date_add_day=function(e,t,n){var r=new Date(e);return r.setDate(e.getDate()+t),n&&r.setHours(0,-r.getTimezoneOffset(),0,0),r},this.generate_guid=function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:7&n|8).toString(16)})},this.is_guid=function(e){return!("string"!=typeof e||e.length<36)&&(e.length>36&&(e=e.substr(0,36)),/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(e))},this.is_empty_guid=function(e){return!e||e===this.blank.guid},this.is_data_obj=function(e){return e&&e instanceof j},this.is_data_mgr=function(e){return e&&e instanceof s},this.is_equal=function(e,t){return e==t||typeof e!=typeof t&&this.fix_guid(e,!1)==this.fix_guid(t,!1)},this.blob_as_text=function(e,t){return new Promise(function(n,r){var a=new FileReader;a.onload=function(e){n(a.result)},a.onerror=function(e){r(e)},"data_url"==t?a.readAsDataURL(e):a.readAsText(e)})}}function n(){function e(e,t,n,r,a){return new Promise(function(i,o){if("undefined"==typeof window&&r&&r.request)r.request({url:encodeURI(t),headers:{Authorization:r.auth}},function(e,t,n){e?o(e):200!=t.statusCode?o({message:t.statusMessage,description:n,status:t.statusCode}):i({response:n})});else{var s=new XMLHttpRequest;if(window.dhx4&&window.dhx4.isIE&&(t=encodeURI(t)),r){var _,u;"object"==typeof r&&r.username&&r.hasOwnProperty("password")?(_=r.username,u=r.password):M.ajax.username&&M.ajax.authorized?(_=M.ajax.username,u=M.aes.Ctr.decrypt(M.ajax.password)):(_=M.wsql.get_user_param("user_name"),u=M.aes.Ctr.decrypt(M.wsql.get_user_param("user_pwd")),!_&&M.job_prm&&M.job_prm.guest_name&&(_=M.job_prm.guest_name,u=M.aes.Ctr.decrypt(M.job_prm.guest_pwd))),s.open(e,t,!0,_,u),s.withCredentials=!0,s.setRequestHeader("Authorization","Basic "+btoa(unescape(encodeURIComponent(_+":"+u))))}else s.open(e,t,!0);a&&a.call(this,s),"GET"!=e?this.hide_headers||r.hide_headers||(s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.setRequestHeader("X-Requested-With","XMLHttpRequest")):n=null,s.onload=function(){200==s.status&&(s.response instanceof Blob||"<!DOCTYPE"!==s.response.substr(0,9))?(void 0==s.responseURL&&(s.responseURL=t),i(s)):o(s.response?{message:s.statusText,description:s.response,status:s.status}:Error(s.statusText))},s.onerror=function(){o(Error("Network Error"))},s.send(n)}})}this.username="",this.password="",this.root=!0,this.authorized=!1,this.get=function(t){return e.call(this,"GET",t)},this.post=function(t,n){return 1==arguments.length?n="":2==arguments.length&&"function"==typeof n?(onLoad=n,n=""):n=String(n),e.call(this,"POST",t,n)},this.get_ex=function(t,n,r){return e.call(this,"GET",t,null,n,r)},this.post_ex=function(t,n,r,a){return e.call(this,"POST",t,n,r,a)},this.put_ex=function(t,n,r,a){return e.call(this,"PUT",t,n,r,a)},this.patch_ex=function(t,n,r,a){return e.call(this,"PATCH",t,n,r,a)},this.delete_ex=function(t,n,r){return e.call(this,"DELETE",t,null,n,r)},this.get_and_show_blob=function(e,t,n){function r(t){return e=window.URL.createObjectURL(t.response),a=window.open(e,"wnd_print",i),a.onload=function(t){window.URL.revokeObjectURL(e)},a}var a,i="menubar=no,toolbar=no,location=no,status=no,directories=no,resizable=yes,scrollbars=yes";return!n||"string"==typeof n&&n.toLowerCase().indexOf("post")!=-1?this.post_ex(e,"object"==typeof t?JSON.stringify(t):t,!0,function(e){e.responseType="blob"}).then(r):this.get_ex(e,!0,function(e){e.responseType="blob"}).then(r)},this.get_and_save_blob=function(e,t,n){return this.post_ex(e,"object"==typeof t?JSON.stringify(t):t,!0,function(e){e.responseType="blob"}).then(function(e){saveAs(e.response,n)})},this.default_attr=function(e,t){e.url||(e.url=t),e.username||(e.username=this.username),e.password||(e.password=this.password),e.hide_headers=!0,M.job_prm["1c"]&&(e.auth=M.job_prm["1c"].auth,e.request=M.job_prm["1c"].request)}}function r(){var e,t=this,n={};this.__define({js_time_diff:{value:-new Date("0001-01-01").valueOf()},time_diff:{get:function(){var e=this.get_user_param("time_diff","number");return!e||isNaN(e)||e<621355716e5||e>62135622e6?this.js_time_diff:e}},set_user_param:{value:function(t,r){var a=r;"object"==typeof r?a=JSON.stringify(r):r===!1&&(a=""),e.setItem(M.job_prm.local_storage_prefix+t,a),n[t]=r}},get_user_param:{value:function(t,r){return!n.hasOwnProperty(t)&&e&&(n[t]=this.fetch_type(e.getItem(M.job_prm.local_storage_prefix+t),r)),n[t]}},promise:{value:function(e,n){return new Promise(function(r,a){t.alasql(e,n||[],function(e,t){t?a(t):r(e)})})}},save_options:{value:function(e,n){return t.set_user_param(e+"_"+n.name,n)}},restore_options:{value:function(e,n){var r=t.get_user_param(e+"_"+n.name,"object");for(var a in r)if("object"!=typeof r[a])n[a]=r[a];else{n[a]||(n[a]={});for(var i in r[a])n[a][i]=r[a][i]}return n}},fetch_type:{value:function(e,t){if("object"==t){try{e=JSON.parse(e)}catch(t){e={}}return e}return"number"==t?M.utils.fix_number(e,!0):"date"==t?M.utils.fix_date(e,!0):"boolean"==t?M.utils.fix_boolean(e):e}},alasql:{value:"undefined"!=typeof alasql?alasql:require("alasql")},init_params:{value:function(){if(!M.job_prm.local_storage_prefix&&!M.job_prm.create_tables)return Promise.resolve();e="undefined"==typeof localStorage?"undefined"==typeof WorkerGlobalScope?new require("node-localstorage").LocalStorage("./localstorage"):{setItem:function(e,t){},getItem:function(e){}}:localStorage;var n,r=[{p:"user_name",v:"",t:"string"},{p:"user_pwd",v:"",t:"string"},{p:"browser_uid",v:M.utils.generate_guid(),t:"string"},{p:"zone",v:M.job_prm.hasOwnProperty("zone")?M.job_prm.zone:1,t:M.job_prm.zone_is_string?"string":"number"},{p:"enable_save_pwd",v:M.job_prm.enable_save_pwd,t:"boolean"},{p:"autologin",v:"",t:"boolean"},{p:"skin",v:"dhx_web",t:"string"},{p:"rest_path",v:"",t:"string"}];M.job_prm.additional_params&&(r=r.concat(M.job_prm.additional_params)),e.getItem(M.job_prm.local_storage_prefix+"zone")||(n=M.job_prm.hasOwnProperty("zone")?M.job_prm.zone:1),M.job_prm.url_prm.hasOwnProperty("zone")&&(n=M.job_prm.zone_is_string?M.job_prm.url_prm.zone:M.utils.fix_number(M.job_prm.url_prm.zone,!0)),void 0!==n&&t.set_user_param("zone",n),r.forEach(function(e){(void 0==t.get_user_param(e.p,e.t)||!t.get_user_param(e.p,e.t)&&e.p.indexOf("url")!=-1)&&t.set_user_param(e.p,M.job_prm.hasOwnProperty(e.p)?M.job_prm[e.p]:e.v)});var a={path:t.get_user_param("couch_path","string")||M.job_prm.couch_path||"",zone:t.get_user_param("zone","number"),prefix:M.job_prm.local_storage_prefix,suffix:t.get_user_param("couch_suffix","string")||""};a.path&&(t.__define("pouch",{value:new i}),t.pouch.init(a)),this.create_tables&&(this.alasq(this.create_tables,[]),this.create_tables="")}},drop_tables:{value:function(e){function n(){i--,i<=0?setTimeout(e,10):r()}function r(){var e=o[i-1].tableid;"_"==e.substr(0,1)?n():t.alasql("drop table IF EXISTS "+e,[],n)}function a(e){o=e,(i=e.length)?r():n()}var i=0,o=[];t.alasql("SHOW TABLES",[],a)}}}),this.__define({aladb:{value:new this.alasql.Database("md")}})}function a(){this.toString=function(){return"Интернационализация сообщений"},this.russian_names=function(){M.job_prm.russian_names&&(window.__define({"Метаданные":{get:function(){return M.md},enumerable:!1},"Справочники":{get:function(){return M.cat},enumerable:!1},"Документы":{get:function(){return M.doc},enumerable:!1},"РегистрыСведений":{get:function(){return M.ireg},enumerable:!1},"РегистрыНакопления":{get:function(){return M.areg},enumerable:!1},"РегистрыБухгалтерии":{get:function(){return M.accreg},enumerable:!1},"Обработки":{get:function(){return M.dp},enumerable:!1},"Отчеты":{get:function(){return M.rep},enumerable:!1},"ОбластьКонтента":{get:function(){return M.iface.docs},enumerable:!1},"Сообщить":{get:function(){return M.msg.show_msg},enumerable:!1},"Истина":{value:!0,enumerable:!1},"Ложь":{value:!1,enumerable:!1}}),s.prototype.__define({"ФормаВыбора":{get:function(){return this.form_selection},enumerable:!1},"ФормаОбъекта":{get:function(){return this.form_obj},enumerable:!1},"Найти":{get:function(){return this.find},enumerable:!1},"НайтиСтроки":{get:function(){return this.find_rows},enumerable:!1},"НайтиПоНаименованию":{get:function(){return this.by_name},enumerable:!1}}),j.prototype.__define({"ФормаОбъекта":{get:function(){return this.form_obj},enumerable:!1}}))},"undefined"!=typeof window&&"dhtmlx"in window&&(this.show_msg=function(e,t){if(e){if("string"==typeof e){if(M.iface.synctxt)return void M.iface.synctxt.show_message(e);e={type:"info",text:e}}t&&"function"==typeof t.setText&&t.setText(e.text),dhtmlx.message(e)}},this.check_soap_result=function(e){return e?"limit_query"==e.error?(M.iface.docs.progressOff(),M.msg.show_msg({type:"alert-warning",text:M.msg.limit_query.replace("%1",e.queries).replace("%2",e.queries_avalable),title:M.msg.srv_overload}),!0):"network"==e.error||"empty"==e.error?(M.iface.docs.progressOff(),M.msg.show_msg({type:"alert-warning",text:M.msg.error_network,title:M.msg.error_critical}),!0):e.error&&e.error_description?(M.iface.docs.progressOff(),e.error_description.indexOf("Недостаточно прав")!=-1&&(e.error_type="alert-warning",e.error_title=M.msg.error_rights),M.msg.show_msg({type:e.error_type||"alert-error",text:e.error_description,title:e.error_title||M.msg.error_critical}),!0):e.error&&!e.messages?(M.iface.docs.progressOff(),M.msg.show_msg({type:"alert-error",title:M.msg.error_critical,text:M.msg.unknown_error.replace("%1","unknown_error")}),!0):void 0:(M.msg.show_msg({type:"alert-error",text:M.msg.empty_response,title:M.msg.error_critical}),!0)},this.show_not_implemented=function(){M.msg.show_msg({type:"alert-warning",text:M.msg.not_implemented,title:M.msg.main_title})})}function i(){var e,t,n,r,a=this,i={};a.__define({DB:{value:"undefined"==typeof PouchDB?require("pouchdb-core").plugin(require("pouchdb-adapter-memory")).plugin(require("pouchdb-adapter-http")).plugin(require("pouchdb-replication")).plugin(require("pouchdb-mapreduce")):PouchDB},init:{value:function(e){i._mixin(e),i.path&&0!=i.path.indexOf("http")&&"undefined"!=typeof location&&(i.path=location.protocol+"//"+location.host+i.path)}},local:{get:function(){if(!e){var t={auto_compaction:!0,revs_limit:2};e={ram:new a.DB(i.prefix+i.zone+"_ram",t),doc:new a.DB(i.prefix+i.zone+"_doc",t),meta:new a.DB(i.prefix+"meta",t),sync:{}}}return i.path&&!e._meta&&(e._meta=new a.DB(i.path+"meta",{auth:{username:"guest",password:"meta"},skip_setup:!0}),a.run_sync(e.meta,e._meta,"meta")),e}},remote:{get:function(){return!t&&n&&(t={ram:new a.DB(i.path+i.zone+"_ram",{auth:{username:n.username,password:n.password},skip_setup:!0}),doc:new a.DB(i.path+i.zone+"_doc"+i.suffix,{auth:{username:n.username,password:n.password},skip_setup:!0})}),t}},log_in:{value:function(e,t){return void 0==e&&void 0==t&&(e=M.job_prm.guest_name,t=M.aes.Ctr.decrypt(M.job_prm.guest_pwd)),n?n.username==e?Promise.resolve():Promise.reject():M.ajax.get_ex(i.path+i.zone+"_ram",{username:e,password:t}).then(function(r){return n={username:e,password:t},setTimeout(function(){dhx4.callEvent("log_in",[e])}),{ram:a.run_sync(a.local.ram,a.remote.ram,"ram"),doc:a.run_sync(a.local.doc,a.remote.doc,"doc")}})}},log_out:{value:function(){if(n){if(e.sync.doc)try{e.sync.doc.cancel()}catch(e){}if(e.sync.ram)try{e.sync.ram.cancel()}catch(e){}n=null}t&&t.ram&&delete t.ram,t&&t.doc&&delete t.doc,t=null,dhx4.callEvent("log_out")}},reset_local_data:{value:function(){var e=a.local.ram.destroy.bind(a.local.ram),t=a.local.doc.destroy.bind(a.local.doc),n=function(){setTimeout(function(){M.eve.redirect=!0,location.reload(!0)},1e3)};a.log_out(),setTimeout(function(){e().then(t).catch(t).then(n).catch(n)},1e3)}},load_data:{value:function(){var e={limit:200,include_docs:!0},t={total_rows:0,limit:e.limit,page:0,start:Date.now()};return new Promise(function(n,i){function o(){a.local.ram.allDocs(e,function(s,_){_?(t.page++,t.total_rows=_.total_rows,t.duration=Date.now()-t.start,M.eve.callEvent("pouch_load_data_page",[t]),a.load_changes(_,e)?o():(n(),r=!0,M.eve.callEvent("pouch_load_data_loaded",[t]),t.note="pouch_load_data_loaded",M.record_log(t))):s&&(i(s),M.eve.callEvent("pouch_load_data_error",[s]))})}a.local.ram.info().then(function(e){e.doc_count>=(M.job_prm.pouch_ram_doc_count||10)?(M.eve.callEvent("pouch_load_data_start",[t]),o()):(M.eve.callEvent("pouch_load_data_error",[e]),i(e))})})}},authorized:{get:function(){return n&&n.username}},data_loaded:{get:function(){return!!r}},run_sync:{value:function(t,n,i){var o,s;return t.info().then(function(e){return o=e,n.info()}).then(function(e){return"ram"!=i?e:n.get("data_version").then(function(t){return t.version!=M.wsql.get_user_param("couch_ram_data_version")&&(M.wsql.get_user_param("couch_ram_data_version")&&(e=a.reset_local_data()),M.wsql.set_user_param("couch_ram_data_version",t.version)),e}).catch(function(e){M.record_log(e)}).then(function(){return e})}).then(function(_){if(_){"ram"==i&&o.doc_count<(M.job_prm.pouch_ram_doc_count||10)?(s={total_rows:_.doc_count,local_rows:o.doc_count,docs_written:0,limit:200,page:0,start:Date.now()},M.eve.callEvent("pouch_load_data_start",[s])):"doc"==i&&setTimeout(function(){M.eve.callEvent("pouch_doc_sync_start")});var u="ram"==i||"meta"==i||M.wsql.get_user_param("zone")==M.job_prm.zone_demo?t.replicate.from:t.sync,l={live:!0,retry:!0,batch_size:200,batches_limit:8};return"meta"==i?l.filter="auth/meta":M.job_prm.pouch_filter&&M.job_prm.pouch_filter[i]&&(l.filter=M.job_prm.pouch_filter[i]),e.sync[i]=u(n,l),e.sync[i].on("change",function(e){"ram"==i&&(a.load_changes(e),o.doc_count<(M.job_prm.pouch_ram_doc_count||10)&&(s.page++,s.docs_written=e.docs_written,s.duration=Date.now()-s.start,M.eve.callEvent("pouch_load_data_page",[s]),s.docs_written>=s.total_rows&&(r=!0,M.eve.callEvent("pouch_load_data_loaded",[s]),s.note="pouch_load_data_loaded",M.record_log(s)))),M.eve.callEvent("pouch_change",[i,e])}).on("paused",function(e){e&&M.eve.callEvent("pouch_paused",[i,e])}).on("active",function(e){M.eve.callEvent("pouch_active",[i,e])}).on("denied",function(e){M.eve.callEvent("pouch_denied",[i,e])}).on("complete",function(e){M.eve.callEvent("pouch_complete",[i,e])}).on("error",function(e){M.eve.callEvent("pouch_error",[i,e])}),e.sync[i]}})}},load_obj:{value:function(e){return e._manager.pouch_db.get(e._manager.class_name+"|"+e.ref).then(function(t){delete t._id,delete t._rev,e._mixin(t)._set_loaded()}).catch(function(e){if(404!=e.status)throw e}).then(function(t){return e})}},save_obj:{value:function(e,t){var n=e._obj._clone(),r=e._manager.pouch_db;return n._id=e._manager.class_name+"|"+e.ref,delete n.ref,t.attachments&&(n._attachments=t.attachments),(e.is_new()?Promise.resolve():r.get(n._id)).then(function(e){if(e){n._rev=e._rev;for(var t in e._attachments)n._attachments||(n._attachments={}),n._attachments[t]||(n._attachments[t]=e._attachments[t])}}).catch(function(e){if(404!=e.status)throw e}).then(function(){return r.put(n)}).then(function(){if(e.is_new()&&e._set_loaded(e.ref),n._attachments){e._attachments||(e._attachments={});for(var r in n._attachments)e._attachments[r]&&n._attachments[r].stub||(e._attachments[r]=n._attachments[r])}return n=null,t=null,e})}},load_changes:{value:function(e,t){var n,r,a,i,o={};if(t)n=e.rows;else if(e.direction){if("pull"!=e.direction)return;n=e.change.docs}else n=e.docs;if(n.length>0){t&&(t.startkey=n[n.length-1].key,t.skip=1),n.forEach(function(e){if(r=t?e.doc:e,!r)if(e.value&&e.value.deleted)r={_id:e.id,_deleted:!0};else if(e.error)return;i=r._id.split("|"),a=i[0].split("."),r.ref=i[1],delete r._id,delete r._rev,o[a[0]]||(o[a[0]]={}),o[a[0]][a[1]]||(o[a[0]][a[1]]=[]),o[a[0]][a[1]].push(r)});for(var s in o)for(a in o[s])M[s]&&M[s][a]&&M[s][a].load_array(o[s][a],!0);return o=e=n=r=null,!0}return!1}},backup_database:{value:function(e){}},restore_database:{value:function(e){}}})}function o(){function e(e){return e.info().then(function(){return e.get("meta")}).then(function(n){return t=n,n=null,e.get("meta_patch")}).then(function(e){M._patch(t,e),e=null,delete t._id,delete t._rev})}var t;_md=this,_md.create_managers=function(){},_md.init=function(n){function r(){return!n||o||s?e(n||M.wsql.pouch.local.meta).then(function(){return o?void _md.create_managers():t}).catch(M.record_log):(t=n,n=null,_md.create_managers(),void 0)}function a(){dhtmlx.confirm({title:M.msg.file_new_date_title,text:M.msg.file_new_date,ok:"Перезагрузка",cancel:"Продолжить",callback:function(e){e?(M.wsql.pouch.log_out(),setTimeout(function(){M.eve.redirect=!0,location.reload(!0)},1e3)):(i++,setTimeout(a,3e4*i))}})}var i=0,o=!n||M.wsql.pouch&&n==M.wsql.pouch.local.meta,s=n&&M.wsql.pouch&&n==M.wsql.pouch.local._meta;return M.on("pouch_change",function(e,n){"meta"==e&&(t?performance.now()>2e4&&n.docs.some(function(e){return"meta"!=e._id.substr(0,4)})&&a():r())}),r()},_md.get=function(e,n){var r=e.split(".");if(!n)return t[r[0]][r[1]];var a={multiline_mode:!1,note:"",synonym:"",tooltip:"",type:{is_ref:!1,types:["string"]}},i="doc,tsk,bp".indexOf(r[0])!=-1,o="cat,cch,cacc,tsk".indexOf(r[0])!=-1;return i&&"number_doc"==n?(a.synonym="Номер",a.tooltip="Номер документа",a.type.str_len=11):i&&"date"==n?(a.synonym="Дата",a.tooltip="Дата документа",a.type.date_part="date_time",a.type.types[0]="date"):i&&"posted"==n?(a.synonym="Проведен",a.type.types[0]="boolean"):o&&"id"==n?a.synonym="Код":o&&"name"==n?a.synonym="Наименование":"_deleted"==n?(a.synonym="Пометка удаления",a.type.types[0]="boolean"):"is_folder"==n?(a.synonym="Это группа",a.type.types[0]="boolean"):"ref"==n?(a.synonym="Ссылка",a.type.is_ref=!0,a.type.types[0]=e):a=n?t[r[0]][r[1]].fields[n]:t[r[0]][r[1]],a},_md.get_classes=function(){var e={};for(var n in t){e[n]=[];for(var r in t[n])e[n].push(r)}return e},_md.sql_type=function(e,t,n,r){var a;return a="type"==t&&"cch_properties"==e.table_name||"svg"==t&&"cat_production_params"==e.table_name?" JSON":n.is_ref||n.types.indexOf("guid")!=-1?r?n.types.every(function(e){return 0==e.indexOf("enm.")})?" character varying(100)":n.hasOwnProperty("str_len")?" character varying("+Math.max(36,n.str_len)+")":" uuid":" CHAR":n.hasOwnProperty("str_len")?r?n.str_len?" character varying("+n.str_len+")":" text":" CHAR":n.date_part?r&&"date"!=n.date_part?"date_time"==n.date_part?" timestamp with time zone":" time without time zone":" Date":n.hasOwnProperty("digits")?0==n.fraction_figits?r?n.digits<7?" integer":" bigint":" INT":r?" numeric("+n.digits+","+n.fraction_figits+")":" FLOAT":n.types.indexOf("boolean")!=-1?" BOOLEAN":n.types.indexOf("json")!=-1?" JSON":r?" character varying(255)":" CHAR"},_md.sql_composite=function(e,t,n,r){var a="";return e[t].type.types.length>1&&"type"!=t&&(n=n?n.substr(0,29)+"_T":t.substr(0,29)+"_T",a=r?', "'+n+'" character varying(255)':_md.sql_mask(n)+" CHAR"),a},_md.sql_mask=function(e,t){return", "+(t?"_t_.":"")+("`"+e+"`")},_md.mgr_by_class_name=function(e){if(e){var t=e.split(".");if(t[1]&&M[t[0]])return M[t[0]][t[1]]}},_md.value_mgr=function(e,t,n,r,a){function i(e){return e&&1==n.types.length&&(n._mgr=e),e}var o,s,_,u,l;if(n._mgr)return n._mgr;if(1==n.types.length){if(_=n.types[0].split("."),_.length>1&&M[_[0]])return i(M[_[0]][_[1]])}else if(a&&a.type&&(_=a.type.split("."),_.length>1&&M[_[0]]))return i(M[_[0]][_[1]]);if(o=e.property||e.param,"value"==t&&o){if(M.utils.is_data_obj(o))s=o;else{if(!M.utils.is_guid(o))return;s=M.cch.properties.get(o,!1)}if(M.utils.is_data_obj(s)){if(s.is_new())return M.cat.property_values;for(u in s.type.types)if(s.type.types[u].indexOf(".")>-1){_=s.type.types[u].split(".");break}return _&&_.length>1&&M[_[0]]?i(M[_[0]][_[1]]):s.type}}else{if(u=[],n.types.forEach(function(e){_=e.split("."),_.length>1&&M[_[0]][_[1]]&&u.push(M[_[0]][_[1]])}),1==u.length||e[t]==M.utils.blank.guid)return i(u[0]);if(r)return u;if((o=e[t])instanceof j)return o._manager;if(M.utils.is_guid(o)&&o!=M.utils.blank.guid)for(var c in u)if(l=u[c],l.get(o,!1,!0))return l}},_md.control_by_type=function(e,t){var n;return n="boolean"==typeof t&&e.types.indexOf("boolean")!=-1?"ch":"number"==typeof t&&e.digits?e.fraction_figits<5?"calck":"edn":t instanceof Date&&e.date_part?"dhxCalendar":e.is_ref?"ocombo":e.date_part?"dhxCalendar":e.digits?e.fraction_figits<5?"calck":"edn":"boolean"==e.types[0]?"ch":e.hasOwnProperty("str_len")&&(e.str_len>=100||0==e.str_len)?"txt":"ed"},_md.ts_captions=function(e,t,n){n||(n={});var r,a=_md.get(e).tabular_sections[t],i=_md.get(e).form,o=a.fields;if(i&&i.obj){if(!i.obj.tabular_sections[t])return;n._mixin(i.obj.tabular_sections[t])}else{"contact_information"===t&&(o={type:"",kind:"",presentation:""}),n.fields=["row"],n.headers="№",n.widths="40",n.min_widths="",n.aligns="",n.sortings="na",n.types="cntr";for(var s in o)r=a.fields[s],r.hide||(n.fields.push(s),n.headers+=","+(r.synonym?r.synonym.replace(/,/g," "):s),n.types+=","+_md.control_by_type(r.type),n.sortings+=",na")}return!0},_md.syns_js=function(e){var n={DeletionMark:"_deleted",Description:"name",DataVersion:"data_version",IsFolder:"is_folder",Number:"number_doc",Date:"date","Дата":"date",Posted:"posted",Code:"id",Parent_Key:"parent",Owner_Key:"owner",Owner:"owner",Ref_Key:"ref","Ссылка":"ref",LineNumber:"row"};return n[e]?n[e]:t.syns_js[t.syns_1с.indexOf(e)]||e},_md.syns_1с=function(e){var n={_deleted:"DeletionMark",name:"Description",is_folder:"IsFolder",number_doc:"Number",date:"Date",posted:"Posted",id:"Code",ref:"Ref_Key",parent:"Parent_Key",owner:"Owner_Key",row:"LineNumber"};return n[e]?n[e]:t.syns_1с[t.syns_js.indexOf(e)]||e},_md.printing_plates=function(e){if(e)for(var n in e.doc)t.doc[n].printing_plates=e.doc[n]},_md.class_name_from_1c=function(e){var t=e.split(".");return 1==t.length?"enm."+e:("Перечисление"==t[0]?e="enm.":"Справочник"==t[0]?e="cat.":"Документ"==t[0]?e="doc.":"РегистрСведений"==t[0]?e="ireg.":"РегистрНакопления"==t[0]?e="areg.":"РегистрБухгалтерии"==t[0]?e="aссreg.":"ПланВидовХарактеристик"==t[0]?e="cch.":"ПланСчетов"==t[0]?e="cacc.":"Обработка"==t[0]?e="dp.":"Отчет"==t[0]&&(e="rep."),e+_md.syns_js(t[1]))},_md.class_name_to_1c=function(e){var t=e.split(".");return 1==t.length?"Перечисление."+e:("enm"==t[0]?e="Перечисление.":"cat"==t[0]?e="Справочник.":"doc"==t[0]?e="Документ.":"ireg"==t[0]?e="РегистрСведений.":"areg"==t[0]?e="РегистрНакопления.":"aссreg"==t[0]?e="РегистрБухгалтерии.":"cch"==t[0]?e="ПланВидовХарактеристик.":"cacc"==t[0]?e="ПланСчетов.":"dp"==t[0]?e="Обработка.":"rep"==t[0]&&(e="Отчет."),e+_md.syns_1с(t[1]))},_md.create_tables=function(e,t){function n(){i--,0==i?e?e(_):alasql.utils.saveFile("create_tables.sql",_):r()}function r(){var e=o[i-1];_+=e.class[e.name].get_sql_struct(t)+"; ",n()}var a,i=0,o=[],s=_md.get_classes(),_=t&&t.postgres?"":"USE md; ";"enm,cch,cacc,cat,bp,tsk,doc,ireg,areg".split(",").forEach(function(e){for(a in s[e])o.push({class:M[e],name:s[e][a]})}),i=o.length,r()}}function s(e){var t=_md.get(e),n={after_create:[],after_load:[],before_save:[],after_save:[],value_change:[],add_row:[],del_row:[]};this.__define({cachable:{get:function(){return e.indexOf("enm.")!=-1?"ram":t.cachable?t.cachable:e.indexOf("doc.")!=-1||e.indexOf("dp.")!=-1||e.indexOf("rep.")!=-1?"doc":"ram"}},class_name:{value:e,writable:!1},alatable:{get:function(){return M.wsql.aladb.tables[this.table_name]?M.wsql.aladb.tables[this.table_name].data:[]}},metadata:{value:function(e){return e?t.fields[e]||t.tabular_sections[e]:t}},on:{value:function(e,t){if("object"==typeof e)for(var r in e)e.hasOwnProperty(r)&&n[r].push(e[r]);else n[e].push(t)}},off:{value:function(e,t){}},handle_event:{value:function(e,t,r){var a,i=[];if(n[t].forEach(function(t){i!==!1&&(a=t.call(e,r),a===!1?i=a:a&&i.push(a))}),i.length)return 1==i.length?i[0]:i.some(function(e){return"object"==typeof e&&e.then})?Promise.all(i):i}},by_ref:{value:{}}})}function _(e){_.superclass.constructor.call(this,e)}function u(e){u.superclass.constructor.call(this,e)}function l(e){l.superclass.constructor.call(this,e);var t=M.md.get(e);for(var n in t)new R(t[n],this)}function c(e){c.superclass.constructor.call(this,e),this.push=function(e,t){t&&t!=e.ref?(delete this.by_ref[e.ref],this.by_ref[t]=e):this.by_ref[e.ref]=e},this.get=function(e,t,n){if(e?"string"==typeof e&&(e={ref:e}):e={},e.ref&&n)return t?Promise.resolve(this.by_ref[e.ref]):this.by_ref[e.ref];e.action="select";var r,a=M.wsql.alasql(this.get_sql_struct(e),e._values);if(delete e.action,delete e._values,a.length)if(n)r=this.by_ref[this.get_ref(a[0])];else{r=[];for(var i in a)r.push(this.by_ref[this.get_ref(a[i])])}return t?Promise.resolve(r):r},this.unload_obj=function(e){delete this.by_ref[e],this.alatable.some(function(t,n,r){if(t.ref==e)return r.splice(n,1),!0})},this.load_array=function(e,t){for(var n,r,a=[],i=0;i<e.length;i++){if(n=this.get_ref(e[i]),r=this.by_ref[n],r||e[i]._deleted){if(r&&e[i]._deleted){r.unload();continue}(r.is_new()||t)&&(r._mixin(e[i]),r._set_loaded())}else r=new(M[this.obj_constructor()])(e[i],this),t&&r._set_loaded();a.push(r)}return a}}function f(e){f.superclass.constructor.call(this,e)}function d(){d.superclass.constructor.call(this,"ireg.$log");var e;this.__define({record:{value:function(t){t instanceof Error?(console&&console.log(t),t={class:"error",note:t.toString()}):"object"!=typeof t||t.class||t.obj?"object"!=typeof t&&(t={note:t}):t={class:"obj",obj:t,note:t.note},t.date=Date.now()+M.wsql.time_diff,e||(e=alasql.compile("select MAX(`sequence`) as `sequence` from `ireg_$log` where `date` = ?"));var n=e([t.date]);n.length&&void 0!==n[0].sequence?t.sequence=parseInt(n[0].sequence)+1:t.sequence=0,t.class||(t.class="note"),M.wsql.alasql("insert into `ireg_$log` (`ref`, `date`, `sequence`, `class`, `note`, `obj`) values (?,?,?,?,?,?)",[t.date+"¶"+t.sequence,t.date,t.sequence,t.class,t.note,t.obj?JSON.stringify(t.obj):""])}},backup:{value:function(e,t){}},restore:{value:function(e,t){}},clear:{value:function(e,t){}},show:{value:function(e){}},get:{value:function(e,t,n){if("object"==typeof e&&(e=e.ref||""),!this.by_ref[e]){if(t===!1)return;var r=e.split("¶");M.wsql.alasql("select * from `ireg_$log` where date="+r[0]+" and sequence="+r[1]).forEach(function(e){new P(e,this)}.bind(this))}return t?Promise.resolve(this.by_ref[e]):this.by_ref[e]}},get_sql_struct:{value:function(e){if(e&&"get_selection"==e.action){var t="select * from `ireg_$log`";return e.date_from?t+=e.date_till?" where `date` >= ? and `date` <= ?":" where `date` >= ?":e.date_till&&(t+=" where `date` <= ?"),
t}return d.superclass.get_sql_struct.call(this,e)}},caption_flds:{value:function(e){var t='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>',n=[],r="";if(n.push(new Col_struct("date","200","ro","left","server","Дата")),n.push(new Col_struct("class","100","ro","left","server","Класс")),n.push(new Col_struct("note","*","ro","left","server","Событие")),e.get_header){r="<head>";for(var a in n)r+=t.replace("%1",n[a].id).replace("%2",n[a].width).replace("%3",n[a].type).replace("%4",n[a].align).replace("%5",n[a].sort).replace("%6",n[a].caption);r+="</head>"}return{head:r,acols:n}}},data_to_grid:{value:function(e,t){var n="<?xml version='1.0' encoding='UTF-8'?><rows total_count='%1' pos='%2' set_parent='%3'>".replace("%1",e.length).replace("%2",t.start).replace("%3",t.set_parent||""),r=this.caption_flds(t);return n+=r.head,e.forEach(function(e){n+='<row id="'+e.ref+'"><cell>'+M.moment(e.date-M.wsql.time_diff).format("DD.MM.YYYY HH:mm:ss")+"."+e.sequence+"</cell><cell>"+(e.class||"")+"</cell><cell>"+(e.note||"")+"</cell></row>"}),n+"</rows>"}}})}function p(e){p.superclass.constructor.call(this,e)}function h(e){h.superclass.constructor.call(this,e),this.metadata().hierarchical&&this.metadata().group_hierarchy&&M[this.obj_constructor()].prototype.__define("is_folder",{get:function(){return this._obj.is_folder||!1},set:function(e){this._obj.is_folder=M.utils.fix_boolean(e)},enumerable:!0,configurable:!0})}function m(e){m.superclass.constructor.call(this,e)}function y(e){y.superclass.constructor.call(this,e)}function g(e){g.superclass.constructor.call(this,e)}function b(e){b.superclass.constructor.call(this,e)}function v(e){v.superclass.constructor.call(this,e)}function w(e,t){t._obj[e]||(t._obj[e]=[]),this.__define("_name",{value:e,enumerable:!1}),this.__define("_owner",{value:t,enumerable:!1}),this.__define("_obj",{value:t._obj[e],writable:!1,enumerable:!1})}function x(e){var t={};this.__define("_owner",{value:e,enumerable:!1}),this.__define("_obj",{value:t,writable:!1,enumerable:!1})}function j(e,t){var n,r={},a={},i={_is_new:!(this instanceof R)};return t instanceof u||t instanceof l||(n=t.get(e,!1,!0)),n?(e=null,n):(t instanceof l?a.ref=e.name:t instanceof c?a.ref=t.get_ref(e):a.ref=M.utils.fix_guid(e),this.__define({_obj:{value:a,configurable:!0},_ts_:{value:function(e){return r[e]||(r[e]=new w(e,this)),r[e]},configurable:!0},_manager:{value:t},_data:{value:i,configurable:!0}}),t.alatable&&t.push&&(t.alatable.push(a),t.push(this,a.ref)),void(e=null))}function O(e,t){var n="";O.superclass.constructor.call(this,e,t),this.__define("presentation",{get:function(){return this.name||this.id?this.name||this.id||this._metadata.obj_presentation||this._metadata.synonym:n},set:function(e){e&&(n=String(e))}}),e&&"object"==typeof e&&(e._not_set_loaded?(delete e._not_set_loaded,this._mixin(e)):(this._mixin(e),M.utils.is_empty_guid(this.ref)||!e.id&&!e.name||this._set_loaded(this.ref))),e=null}function k(e,t){var n="";k.superclass.constructor.call(this,e,t),this.__define("presentation",{get:function(){return this.number_doc?(this._metadata.obj_presentation||this._metadata.synonym)+" №"+this.number_doc+" от "+M.moment(this.date).format(M.moment._masks.ldt):n},set:function(e){e&&(n=String(e))}}),e&&"object"==typeof e&&this._mixin(e),!M.utils.is_empty_guid(this.ref)&&e.number_doc&&this._set_loaded(this.ref),e=null}function E(e){e.__define({number_doc:{get:function(){return this._obj.number_doc||""},set:function(e){this.__notify("number_doc"),this._obj.number_doc=e},enumerable:!0},date:{get:function(){return this._obj.date||M.utils.blank.date},set:function(e){this.__notify("date"),this._obj.date=M.utils.fix_date(e,!0)},enumerable:!0}})}function q(e,t){q.superclass.constructor.call(this,e,t);var n,r=t.metadata();for(n in r.fields)e[n]=M.utils.fetch_type("",r.fields[n].type);for(n in r.tabular_sections)e[n]=[];this._mixin(e)}function A(e,t){A.superclass.constructor.call(this,e,t)}function D(e,t){D.superclass.constructor.call(this,e,t)}function R(e,t){R.superclass.constructor.call(this,e,t),e&&"object"==typeof e&&this._mixin(e)}function P(e,t){P.superclass.constructor.call(this,e,t),e&&"object"==typeof e&&this._mixin(e);for(var n in t.metadata().dimensions)if(!e.hasOwnProperty(n)&&e.ref){var r=e.ref.split("¶");Object.keys(t.metadata().dimensions).forEach(function(e,t){this[e]=r[t]}.bind(this));break}}function S(){this.filter_date=function(e,t,n){t||(t=new Date("2015-01-01"));var r=e+" gt datetime'"+M.moment(t).format(M.moment._masks.iso)+"'";return n&&(r+=" and "+e+" lt datetime'"+M.moment(n).format(M.moment._masks.iso)+"'"),r},this.to_data=function(e,t){var n,r,a,i,o,s,u={},l=t.metadata(),c=l.fields,f=l.tabular_sections;t instanceof _?(e.hasOwnProperty("DeletionMark")&&(u._deleted=e.DeletionMark),e.hasOwnProperty("DataVersion"),e.hasOwnProperty("Ref_Key")&&(u.ref=e.Ref_Key)):c={}._mixin(l.dimensions)._mixin(l.resources)._mixin(l.attributes),t instanceof g?(e.hasOwnProperty("Number")?u.number_doc=e.Number||e.number_doc:e.hasOwnProperty("number_doc")&&(u.number_doc=e.number_doc),e.hasOwnProperty("Date")?u.date=e.Date:e.hasOwnProperty("date")&&(u.date=e.date),e.hasOwnProperty("Posted")?u.posted=e.Posted:e.hasOwnProperty("posted")&&(u.posted=e.posted)):(l.main_presentation_name&&(e.hasOwnProperty("Description")?u.name=e.Description:e.hasOwnProperty("name")&&(u.name=e.name)),l.code_length&&(e.hasOwnProperty("Code")?u.id=e.Code:e.hasOwnProperty("id")&&(u.id=e.id)));for(r in c)if(e.hasOwnProperty(r))u[r]=e[r];else{if(o=_md.syns_1с(r),o.indexOf("_Key")==-1&&c[r].type.is_ref&&e[o+"_Key"]&&(o+="_Key"),!e.hasOwnProperty(o))continue;u[r]=e[o]}for(n in f)s="extra_fields"==n||e.hasOwnProperty(n)?n:_md.syns_1с(n),e.hasOwnProperty(s)&&(u[n]=[],e[s]&&(e[s].sort(function(e,t){return(e.LineNumber||e.row)>(t.LineNumber||t.row)}),e[s].forEach(function(e){i={};for(a in f[n].fields)o=e.hasOwnProperty(a)||"extra_fields"==n&&("property"==a||"value"==a)?a:_md.syns_1с(a),o.indexOf("_Key")==-1&&f[n].fields[a].type.is_ref&&e[o+"_Key"]&&(o+="_Key"),i[a]=e[o];u[n].push(i)})));return u},this.ajax_to_data=function(e,t){return M.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(e){var n=[];return e.value.forEach(function(e){n.push(L.to_data(e,t))}),n})},this.build_select=function(e,t){function n(e,r){"function"==typeof r?i+=r(t,e):(o=_md.syns_1с(e),s=_md.get(t.class_name,e),s&&(s=s.type,s.is_ref&&o.indexOf("_Key")==-1&&s.types.length&&s.types[0].indexOf("enm.")==-1&&(o+="_Key"),s.types.length&&(["boolean","number"].indexOf(typeof r)!=-1?i+=o+" eq "+r:s.is_ref&&"object"!=typeof r||r instanceof j?i+=o+" eq guid'"+r+"'":"string"==typeof r?i+=o+" eq '"+r+"'":"object"==typeof r&&(r.hasOwnProperty("like")?i+=o+" like '%"+r.like+"%'":r.hasOwnProperty("not")?i+=" not ("+n(e,r.not)+") ":r.hasOwnProperty("in")&&(i+=o+" in ("+(s.is_ref?r.in.map(function(e){return"guid'"+e+"'"}).join(","):r.in.join(","))+") ")))))}function r(e){for(var t in e)if(i?i+=" and ":i="&$filter=","or"==t&&Array.isArray(e[t])){var r=!0;e[t].forEach(function(e){r?(i+=" ( ",r=!1):i+=" or ";var t=Object.keys(e)[0];n(t,e[t])}),i+=" ) "}else n(t,e[t])}var a,i,o,s,_="";e||(e={}),e.fields&&(e.fields.forEach(function(e){"ref"==e?o="Ref_Key":(o=_md.syns_1с(e),s=_md.get(t.class_name,e).type,s.is_ref&&o.indexOf("_Key")==-1&&s.types.length&&s.types[0].indexOf("enm.")==-1&&(o+="_Key")),a?a+=",":a="&$select=",a+=o}),_+=a),e.selection&&("function"==typeof e.selection||(Array.isArray(e.selection)?e.selection.forEach(r):r(e.selection)),i&&(_+=i)),M.job_prm.rest&&t.rest_name.indexOf("Module_")==-1&&t.rest_name.indexOf("DataProcessor_")==-1&&t.rest_name.indexOf("Report_")==-1&&_.indexOf(" like ")==-1&&_.indexOf(" in ")==-1&&!t.metadata().irest?M.ajax.default_attr(e,M.job_prm.rest_url()):M.ajax.default_attr(e,M.job_prm.irest_url()),e.url+=t.rest_name+"?allowedOnly=true&$format=json&$top="+(e.top||300)+_},this.load_array=function(e,t){return L.build_select(e,t),L.ajax_to_data(e,t)},this.load_obj=function(e){var t={};return M.ajax.default_attr(t,!e._metadata.irest&&M.job_prm.rest?M.job_prm.rest_url():M.job_prm.irest_url()),t.url+=e._manager.rest_name+"(guid'"+e.ref+"')?$format=json",M.ajax.get_ex(t.url,t).then(function(e){return JSON.parse(e.response)}).then(function(t){return e._mixin(L.to_data(t,e._manager))._set_loaded(),e}).catch(function(t){return 404==t.status?e:void M.record_log(t)})},this.save_irest=function(e,t){var n=JSON.stringify(e),r=(void 0!=t.post?",post="+t.post:"")+(void 0!=t.operational?",operational="+t.operational:"");return M.ajax.default_attr(t,M.job_prm.irest_url()),t.url+=e._manager.rest_name+"(guid'"+e.ref+"'"+r+")",M.ajax.post_ex(t.url,n,t).then(function(e){return JSON.parse(e.response)}).then(function(t){return e._mixin(t)})},this.save_rest=function(e,t){var n,r=e.to_atom();return M.ajax.default_attr(t,M.job_prm.rest_url()),n=t.url+e._manager.rest_name,t.url=n+"(guid'"+e.ref+"')?$format=json&$select=Ref_Key,DeletionMark",M.ajax.get_ex(t.url,t).catch(function(e){return 404==e.status?{response:JSON.stringify({is_new:!0})}:Promise.reject(e)}).then(function(e){return JSON.parse(e.response)}).then(function(a){return a.is_new?M.ajax.post_ex(n,r,t):M.ajax.patch_ex(n+"(guid'"+e.ref+"')",r,t)}).then(function(t){var n=xmlToJSON.parseString(t.response,{mergeCDATA:!1,grokAttr:!0,grokText:!1,normalize:!0,xmlns:!1,namespaceKey:"_ns",textKey:"_text",valueKey:"_value",attrKey:"_attr",cdataKey:"_cdata",attrsAsObject:!1,stripAttrPrefix:!0,stripElemPrefix:!0,childrenAsArray:!1});if(n.entry&&n.entry.content&&n.entry.updated){var r,a=n.entry.content.properties,i={};for(var o in a)if(0!=o.indexOf("_"))if(r=a[o].element)if(i[o]=[],Array.isArray(r))for(var s in r){i[o][s]={};for(var _ in r[s])0!=_.indexOf("_")&&(i[o][s][_]="false"!==r[s][_]._text&&r[s][_]._text)}else{i[o][0]={};for(var _ in r)0!=_.indexOf("_")&&(i[o][0][_]="false"!==r[_]._text&&r[_]._text)}else i[o]="false"!==a[o]._text&&a[o]._text;return L.to_data(i,e._manager)}}).then(function(t){return e._mixin(t)})}}function N(){if(this.__define({init:{value:function(){M.__define("job_prm",{value:new C,writable:!1}),M.wsql.init_params()}},do_eventable:{value:function(e){function t(e,t){e=String(e).toLowerCase(),this._evnts.data[e]||(this._evnts.data[e]={});var n=M.utils.generate_guid();return this._evnts.data[e][n]=t,n}function n(e){if(!e)return r.call(this);for(var t in this._evnts.data){var n=0;for(var a in this._evnts.data[t])a==e?(this._evnts.data[t][a]=null,delete this._evnts.data[t][a]):n++;0==n&&(this._evnts.data[t]=null,delete this._evnts.data[t])}}function r(){for(var e in this._evnts.data){for(var t in this._evnts.data[e])this._evnts.data[e][t]=null,delete this._evnts.data[e][t];this._evnts.data[e]=null,delete this._evnts.data[e]}}function a(e,t){if(e=String(e).toLowerCase(),null==this._evnts.data[e])return!0;var n=!0;for(var r in this._evnts.data[e])n=this._evnts.data[e][r].apply(this,t)&&n;return n}function i(){for(var e in this._evnts.evnts){var t=this._evnts.evnts[e].length;if(t){for(var n=0;n<t;n++)this.emit(e,this._evnts.evnts[e][n]);this._evnts.evnts[e].length=0}}this._evnts.timer=0}e.__define({_evnts:{value:{data:{},timer:0,evnts:{}}},on:{value:t},attachEvent:{value:t},off:{value:n},detachEvent:{value:n},detachAllEvents:{value:r},checkEvent:{value:function(e){return e=String(e).toLowerCase(),null!=this._evnts.data[e]}},callEvent:{value:a},emit:{value:a},emit_async:{value:function(e,t){this._evnts.evnts[e]||(this._evnts.evnts[e]=[]),this._evnts.evnts[e].push(t),this._evnts.timer&&clearTimeout(this._evnts.timer),this._evnts.timer=setTimeout(i.bind(this),4)}}})}}}),"undefined"!=typeof window&&window.dhx4){for(var e in dhx4)this[e]=dhx4[e],delete dhx4[e];window.dhx4=this}else"undefined"==typeof WorkerGlobalScope&&this.do_eventable(this)}function C(){function e(){return M.wsql.get_user_param("rest_path")||M.job_prm.rest_path||"/a/zd/%1/odata/standard.odata/"}function t(){function e(e){var t,n={},r=[];if("#"!==e.substr(0,1)&&"?"!==e.substr(0,1)||(e=e.substr(1)),e.length>2){t=decodeURI(e).split("&");for(var a in t)if(r=t[a].split("="),"m"==r[0])try{n[r[0]]=JSON.parse(r[1])}catch(e){n[r[0]]={}}else n[r[0]]=r[1]||""}return n}return e(location.search)._mixin(e(location.hash))}this.__define({parse_url:{value:t},offline:{value:!1,writable:!0},local_storage_prefix:{value:"",writable:!0},create_tables:{value:!0,writable:!0},url_prm:{value:"undefined"!=typeof window?t():{}},rest_url:{value:function(){var t=e(),n=M.wsql.get_user_param("zone",M.job_prm.zone_is_string?"string":"number");return n?t.replace("%1",n):t.replace("%1/","")}},irest_url:{value:function(){var t=e(),n=M.wsql.get_user_param("zone",M.job_prm.zone_is_string?"string":"number");return t=t.replace("odata/standard.odata","hs/rest"),n?t.replace("%1",n):t.replace("%1/","")}}}),M.eve.callEvent("settings",[this]);for(var n in this)"url_prm"!==n&&"function"!=typeof this[n]&&this.url_prm.hasOwnProperty[n]&&(this[n]=this.url_prm[n])}/**
* AES implementation in JavaScript                                   (c) Chris Veness 2005-2016
*                                                                                   MIT Licence
* www.movable-type.co.uk/scripts/aes.html
*/
function T(e){"use strict";function t(e){return encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)})}function n(e){try{return decodeURIComponent(escape(e))}catch(t){return e}}function r(e){if("undefined"!=typeof btoa)return btoa(e);if("undefined"!=typeof Buffer)return new Buffer(e,"binary").toString("base64");throw new Error("No Base64 Encode")}function a(e){if("undefined"!=typeof atob)return atob(e);if("undefined"!=typeof Buffer)return new Buffer(e,"base64").toString("binary");throw new Error("No Base64 Decode")}var i=this;i.cipher=function(e,t){for(var n=4,r=t.length/n-1,a=[[],[],[],[]],o=0;o<4*n;o++)a[o%4][Math.floor(o/4)]=e[o];a=i.addRoundKey(a,t,0,n);for(var s=1;s<r;s++)a=i.subBytes(a,n),a=i.shiftRows(a,n),a=i.mixColumns(a,n),a=i.addRoundKey(a,t,s,n);a=i.subBytes(a,n),a=i.shiftRows(a,n),a=i.addRoundKey(a,t,r,n);for(var _=new Array(4*n),o=0;o<4*n;o++)_[o]=a[o%4][Math.floor(o/4)];return _},i.keyExpansion=function(e){for(var t=4,n=e.length/4,r=n+6,a=new Array(t*(r+1)),o=new Array(4),s=0;s<n;s++){var _=[e[4*s],e[4*s+1],e[4*s+2],e[4*s+3]];a[s]=_}for(var s=n;s<t*(r+1);s++){a[s]=new Array(4);for(var u=0;u<4;u++)o[u]=a[s-1][u];if(s%n==0){o=i.subWord(i.rotWord(o));for(var u=0;u<4;u++)o[u]^=i.rCon[s/n][u]}else n>6&&s%n==4&&(o=i.subWord(o));for(var u=0;u<4;u++)a[s][u]=a[s-n][u]^o[u]}return a},i.subBytes=function(e,t){for(var n=0;n<4;n++)for(var r=0;r<t;r++)e[n][r]=i.sBox[e[n][r]];return e},i.shiftRows=function(e,t){for(var n=new Array(4),r=1;r<4;r++){for(var a=0;a<4;a++)n[a]=e[r][(a+r)%t];for(var a=0;a<4;a++)e[r][a]=n[a]}return e},i.mixColumns=function(e,t){for(var n=0;n<4;n++){for(var r=new Array(4),a=new Array(4),i=0;i<4;i++)r[i]=e[i][n],a[i]=128&e[i][n]?e[i][n]<<1^283:e[i][n]<<1;e[0][n]=a[0]^r[1]^a[1]^r[2]^r[3],e[1][n]=r[0]^a[1]^r[2]^a[2]^r[3],e[2][n]=r[0]^r[1]^a[2]^r[3]^a[3],e[3][n]=r[0]^a[0]^r[1]^r[2]^a[3]}return e},i.addRoundKey=function(e,t,n,r){for(var a=0;a<4;a++)for(var i=0;i<r;i++)e[a][i]^=t[4*n+i][a];return e},i.subWord=function(e){for(var t=0;t<4;t++)e[t]=i.sBox[e[t]];return e},i.rotWord=function(e){for(var t=e[0],n=0;n<3;n++)e[n]=e[n+1];return e[3]=t,e},i.sBox=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22],i.rCon=[[0,0,0,0],[1,0,0,0],[2,0,0,0],[4,0,0,0],[8,0,0,0],[16,0,0,0],[32,0,0,0],[64,0,0,0],[128,0,0,0],[27,0,0,0],[54,0,0,0]],i.Ctr={},i.Ctr.encrypt=function(n,a,o){var s=16;128!=o&&192!=o&&256!=o&&(o=128),n=t(n),a=t(a||e);for(var _=o/8,u=new Array(_),l=0;l<_;l++)u[l]=l<a.length?a.charCodeAt(l):0;var c=i.cipher(u,i.keyExpansion(u));c=c.concat(c.slice(0,_-16));for(var f=new Array(s),d=(new Date).getTime(),p=d%1e3,h=Math.floor(d/1e3),m=Math.floor(65535*Math.random()),l=0;l<2;l++)f[l]=p>>>8*l&255;for(var l=0;l<2;l++)f[l+2]=m>>>8*l&255;for(var l=0;l<4;l++)f[l+4]=h>>>8*l&255;for(var y="",l=0;l<8;l++)y+=String.fromCharCode(f[l]);for(var g=i.keyExpansion(c),b=Math.ceil(n.length/s),v="",w=0;w<b;w++){for(var x=0;x<4;x++)f[15-x]=w>>>8*x&255;for(var x=0;x<4;x++)f[15-x-4]=w/4294967296>>>8*x;for(var j=i.cipher(f,g),O=w<b-1?s:(n.length-1)%s+1,k=new Array(O),l=0;l<O;l++)k[l]=j[l]^n.charCodeAt(w*s+l),k[l]=String.fromCharCode(k[l]);v+=k.join(""),"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&w%1e3==0&&self.postMessage({progress:w/b})}return v=r(y+v)},i.Ctr.decrypt=function(r,o,s){var _=16;128!=s&&192!=s&&256!=s&&(s=128),r=a(r),o=t(o||e);for(var u=s/8,l=new Array(u),c=0;c<u;c++)l[c]=c<o.length?o.charCodeAt(c):0;var f=i.cipher(l,i.keyExpansion(l));f=f.concat(f.slice(0,u-16));for(var d=new Array(8),p=r.slice(0,8),c=0;c<8;c++)d[c]=p.charCodeAt(c);for(var h=i.keyExpansion(f),m=Math.ceil((r.length-8)/_),y=new Array(m),g=0;g<m;g++)y[g]=r.slice(8+g*_,8+g*_+_);r=y;for(var b="",g=0;g<m;g++){for(var v=0;v<4;v++)d[15-v]=g>>>8*v&255;for(var v=0;v<4;v++)d[15-v-4]=(g+1)/4294967296-1>>>8*v&255;for(var w=i.cipher(d,h),x=new Array(r[g].length),c=0;c<r[g].length;c++)x[c]=w[c]^r[g].charCodeAt(c),x[c]=String.fromCharCode(x[c]);b+=x.join(""),"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&g%1e3==0&&self.postMessage({progress:g/m})}return b=n(b)}}Object.defineProperties(Object.prototype,{__define:{value:function(e,t){return t?Object.defineProperty(this,e,t):Object.defineProperties(this,e),this}},_extend:{value:function(e){var t=function(){};t.prototype=e.prototype,this.prototype=new t,this.prototype.constructor=this,this.__define("superclass",{value:e.prototype,enumerable:!1})}},_mixin:{value:function(e,t,n){var r,a,i={};if(t&&t.length)for(r=0;r<t.length;r++)a=t[r],n&&n.indexOf(a)!=-1||"undefined"!=typeof i[a]&&i[a]==e[a]||(this[a]=e[a]);else for(a in e)n&&n.indexOf(a)!=-1||"undefined"!=typeof i[a]&&i[a]==e[a]||(this[a]=e[a]);return this}},_clone:{value:function(){if(!this||"object"!=typeof this)return this;var e,t,n="function"==typeof this.pop?[]:{};for(e in this)this.hasOwnProperty(e)&&(t=this[e],t?"function"==typeof t||t instanceof j||t instanceof s||t instanceof Date?n[e]=t:"object"==typeof t?n[e]=t._clone():n[e]=t:n[e]=t);return n}}}),Number.prototype.round||(Number.prototype.round=function(e){var t=Math.pow(10,e);return Math.round(this*t)/t}),Number.prototype.pad||(Number.prototype.pad=function(e){for(var t=String(this);t.length<(e||2);)t="0"+t;return t}),Object.observe||Object.unobserve||Object.getNotifier||Object.prototype.__define({observe:{value:function(e,t){e._observers||e.__define({_observers:{value:[],enumerable:!1},_notis:{value:[],enumerable:!1}}),e._observers.push(t)},enumerable:!1},unobserve:{value:function(e,t){if(e._observers)for(var n=0;n<e._observers.length;n++)if(e._observers[n]===t){e._observers.splice(n,1);break}},enumerable:!1},getNotifier:{value:function(e){var t;return{notify:function(n){e._observers&&n&&(n.object||(n.object=e),e._notis.push(n),n=null,t&&clearTimeout(t),t=setTimeout(function(){e._notis.length&&(e._observers.forEach(function(t){t(e._notis)}),e._notis.length=0),t=!1},4))}}},enumerable:!1}});var M=new e;"undefined"!=typeof window&&window.dhx4&&(dhx4.dateFormat.ru="%d.%m.%Y",dhx4.dateLang="ru",dhx4.dateStrings={ru:{monthFullName:["Январь","Февраль","Март","Апрель","Maй","Июнь","Июль","Август","Сентябрь","Oктябрь","Ноябрь","Декабрь"],monthShortName:["Янв","Фев","Maр","Aпр","Maй","Июн","Июл","Aвг","Сен","Окт","Ноя","Дек"],dayFullName:["Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"],dayShortName:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"]}}),M.fias=function(){},function(e){e.toString=function(){return"Коды адресного классификатора"},e.types=["владение","здание","помещение"],e[1010]={name:"дом",type:1,order:1,fid:2,syn:[" д."," д "," дом"]},e[1020]={name:"владение",type:1,order:2,fid:1,syn:[" вл."," вл "," влад."," влад "," владен."," владен "," владение"]},e[1030]={name:"домовладение",type:1,order:3,fid:3},e[1050]={name:"корпус",type:2,order:1,syn:[" к."," к "," корп."," корп ","корпус"]},e[1060]={name:"строение",type:2,order:2,fid:1,syn:[" стр."," стр "," строен."," строен ","строение"]},e[1080]={name:"литера",type:2,order:3,fid:3,syn:[" л."," л "," лит."," лит ","литера"]},e[1070]={name:"сооружение",type:2,order:4,fid:2,syn:[" соор."," соор "," сооруж."," сооруж ","сооружение"]},e[1040]={name:"участок",type:2,order:5,syn:[" уч."," уч ","участок"]},e[2010]={name:"квартира",type:3,order:1,syn:["кв.","кв ","кварт.","кварт ","квартира","-"]},e[2030]={name:"офис",type:3,order:2,syn:["оф.","оф ","офис","-"]},e[2040]={name:"бокс",type:3,order:3},e[2020]={name:"помещение",type:3,order:4},e[2050]={name:"комната",type:3,order:5,syn:["комн.","комн ","комната"]},e[101e5]={name:"Почтовый индекс"},e[102e5]={name:"Адресная точка"},e[103e5]={name:"Садовое товарищество"},e[104e5]={name:"Элемент улично-дорожной сети, планировочной структуры дополнительного адресного элемента"},e[105e5]={name:"Промышленная зона"},e[106e5]={name:"Гаражно-строительный кооператив"},e[107e5]={name:"Территория"}}(M.fias),function(e){e.store_url_od="https://chrome.google.com/webstore/detail/hcncallbdlondnoadgjomnhifopfaage",e.argument_is_not_ref="Аргумент не является ссылкой",e.addr_title="Ввод адреса",e.cache_update_title="Обновление кеша браузера",e.cache_update="Выполняется загрузка измененных файлов<br/>и их кеширование в хранилище браузера",e.cancel="Отмена",e.delivery_area_empty="Укажите район доставки",e.empty_login_password="Не указаны имя пользователя или пароль",e.empty_response="Пустой ответ сервера",e.empty_geocoding="Пустой ответ геокодера. Вероятно, отслеживание адреса запрещено в настройках браузера",e.error_geocoding="Ошибка геокодера",e.error_auth="Авторизация пользователя не выполнена",e.error_critical="Критическая ошибка",e.error_metadata="Ошибка загрузки метаданных конфигурации",e.error_network="Ошибка сети или сервера - запрос отклонен",e.error_rights="Ограничение доступа",e.error_low_acl="Недостаточно прав для выполнения операции",e.file_size="Запрещена загрузка файлов<br/>размером более ",e.file_confirm_delete="Подтвердите удаление файла ",e.file_new_date="Файлы на сервере обновлены<br /> Рекомендуется закрыть браузер и войти<br />повторно для применения обновления",e.file_new_date_title="Версия файлов",e.init_catalogues="Загрузка справочников с сервера",e.init_catalogues_meta=": Метаданные объектов",e.init_catalogues_tables=": Реструктуризация таблиц",e.init_catalogues_nom=": Базовые типы + номенклатура",e.init_catalogues_sys=": Технологические справочники",e.init_login="Укажите имя пользователя и пароль",e.requery="Повторите попытку через 1-2 минуты",e.limit_query="Превышено число обращений к серверу<br/>Запросов за минуту:%1<br/>Лимит запросов:%2<br/>"+e.requery,e.long_operation="Длительная операция",e.logged_in="Авторизован под именем: ",e.log_out_title="Отключиться от сервера?",e.log_out_break="<br/>Завершить синхронизацию?",e.sync_title="Обмен с сервером",e.sync_complite="Синхронизация завершена",e.main_title="Окнософт: заказ дилера ",e.mark_delete_confirm="Пометить объект %1 на удаление?",e.mark_undelete_confirm="Снять пометку удаления с объекта %1?",e.meta={cat:"Справочник",doc:"Документ",cch:"План видов характеристик",cacc:"Планы счетов",tsk:"Задача",ireg:"Регистр сведений",areg:"Регистр накопления",bp:"Бизнес процесс",ts_row:"Строка табличной части",dp:"Обработка",rep:"Отчет"},e.meta_cat="Справочники",e.meta_doc="Документы",e.meta_cch="Планы видов характеристик",e.meta_cacc="Планы счетов",e.meta_tsk="Задачи",e.meta_ireg="Регистры сведений",e.meta_areg="Регистры накопления",e.meta_mgr="Менеджер",e.meta_cat_mgr="Менеджер справочников",e.meta_doc_mgr="Менеджер документов",e.meta_enn_mgr="Менеджер перечислений",e.meta_ireg_mgr="Менеджер регистров сведений",e.meta_areg_mgr="Менеджер регистров накопления",e.meta_accreg_mgr="Менеджер регистров бухгалтерии",e.meta_dp_mgr="Менеджер обработок",e.meta_task_mgr="Менеджер задач",e.meta_bp_mgr="Менеджер бизнес-процессов",e.meta_reports_mgr="Менеджер отчетов",e.meta_charts_of_accounts_mgr="Менеджер планов счетов",e.meta_charts_of_characteristic_mgr="Менеджер планов видов характеристик",e.meta_extender="Модификаторы объектов и менеджеров",e.modified_close="Объект изменен<br/>Закрыть без сохранения?",e.mandatory_title="Обязательный реквизит",e.mandatory_field="Укажите значение реквизита '%1'",e.no_metadata="Не найдены метаданные объекта '%1'",e.no_selected_row="Не выбрана строка табличной части '%1'",e.no_dhtmlx="Библиотека dhtmlx не загружена",e.not_implemented="Не реализовано в текущей версии",e.offline_request="Запрос к серверу в автономном режиме",e.onbeforeunload="Окнософт: легкий клиент. Закрыть программу?",e.order_sent_title="Подтвердите отправку заказа",e.order_sent_message="Отправленный заказ нельзя изменить.<br/>После проверки менеджером<br/>он будет запущен в работу",e.report_prepare="<i class='fa fa-spinner fa-spin fa-2x fa-fw'></i> Подготовка отчета",e.report_need_prepare="<i class='fa fa-info fa-2x fa-fw'></i> Нажмите 'Сформировать' для получения отчета",e.report_need_online="<i class='fa fa-plug fa-2x fa-fw'></i> Нет подключения. Отчет недоступен в автономном режиме",e.request_title="Окнософт: Запрос регистрации",e.request_message="Заявка зарегистрирована. После обработки менеджером будет сформировано ответное письмо",e.select_from_list="Выбор из списка",e.select_grp="Укажите группу, а не элемент",e.select_elm="Укажите элемент, а не группу",e.select_file_import="Укажите файл для импорта",e.srv_overload="Сервер перегружен",e.sub_row_change_disabled="Текущая строка подчинена продукции.<br/>Строку нельзя изменить-удалить в документе<br/>только через построитель",e.sync_script="Обновление скриптов приложения:",e.sync_data="Синхронизация с сервером выполняется:<br />* при первом старте программы<br /> * при обновлении метаданных<br /> * при изменении цен или технологических справочников",e.sync_break="Прервать синхронизацию",e.sync_no_data="Файл не содержит подходящих элементов для загрузки",e.unsupported_browser_title="Браузер не поддерживается",e.unsupported_browser="Несовместимая версия браузера<br/>Рекомендуется Google Chrome",e.supported_browsers="Рекомендуется Chrome, Safari или Opera",e.unsupported_mode_title="Режим не поддерживается",e.unsupported_mode="Программа не установлена<br/> в <a href='"+e.store_url_od+"'>приложениях Google Chrome</a>",e.unknown_error="Неизвестная ошибка в функции '%1'",e.value="Значение"}(M.msg),s.prototype.__define({family_name:{get:function(){return M.msg["meta_"+this.class_name.split(".")[0]+"_mgr"].replace(M.msg.meta_mgr+" ","")}},table_name:{get:function(){return this.class_name.replace(".","_")}},find_rows:{value:function(e,t){return M._find_rows.call(this,this.by_ref,e,t)}},extra_fields:{value:function(e){var t=M.cat.destinations||M.cch.destinations,n=_md.class_name_to_1c(this.class_name).replace(".","_"),r=[];return t&&t.find_rows({predefined_name:n},function(e){var t=e.extra_fields||e.ДополнительныеРеквизиты;return t&&t.each(function(e){e._deleted||e.ПометкаУдаления||r.push(e.property||e.Свойство)}),!1}),r}},extra_properties:{value:function(e){return[]}},obj_constructor:{value:function(e){var t=this.class_name.split("."),n=t[0].charAt(0).toUpperCase()+t[0].substr(1)+t[1].charAt(0).toUpperCase()+t[1].substr(1);return e?n+e.charAt(0).toUpperCase()+e.substr(1)+"Row":n}}}),s.prototype.sync_grid=function(e,t){function n(){if(e.custom_selection)return e.custom_selection(e);if("ram"==a.cachable){if("get_tree"==e.action)return M.wsql.promise(a.get_sql_struct(e),[]).then(M.iface.data_to_tree);if("get_selection"==e.action)return M.wsql.promise(a.get_sql_struct(e),[]).then(function(t){return M.iface.data_to_grid.call(a,t,e)})}else if(0==a.cachable.indexOf("doc")){if("get_tree"==e.action)return a.pouch_tree(e);if("get_selection"==e.action)return a.pouch_selection(e)}else{if("get_tree"==e.action)return a.rest_tree(e);if("get_selection"==e.action)return a.rest_selection(e)}}function r(e){return new Promise(function(n,r){"string"==typeof e?("{"==e.substr(0,1)&&(e=JSON.parse(e)),t&&t.parse?(t.xmlFileUrl="exec",t.parse(e,function(){n(e)},"xml")):n(e)):n(e)})}var a=this;return n().then(r).catch(M.record_log)},s.prototype.get_option_list=function(e,t){function n(t){return M.utils.is_equal(t.value,e)&&(t.selected=!0),t}var r,a,i,o=this,s=[];if(t.presentation&&(r=o.metadata().input_by_string)&&(a=t.presentation.like,delete t.presentation,t.or=[],r.forEach(function(e){i={},i[e]={like:a},t.or.push(i)})),"ram"==o.cachable||t&&t._local)return o.find_rows(t,function(e){s.push(n({text:e.presentation,value:e.ref}))}),Promise.resolve(s);if("e1cib"!=o.cachable)return o.pouch_find_rows(t).then(function(e){return e.forEach(function(e){s.push(n({text:e.presentation,value:e.ref}))}),s});var _={selection:t,top:t._top},u=o instanceof g||o instanceof v;return delete t._top,u?_.fields=["ref","date","number_doc"]:o.metadata().main_presentation_name?_.fields=["ref","name"]:_.fields=["ref","id"],L.load_array(_,o).then(function(e){return e.forEach(function(e){s.push(n({text:u?e.number_doc+" от "+M.moment(e.date).format(M.moment._masks.ldt):e.name||e.id,value:e.ref}))}),s})},s.prototype.tabular_captions=function(e,t){},s.prototype.get_property_grid_xml=function(e,t,n){var r,a,i,o,s,_,u,l=this,c="<rows>",f=function(){if(!e)if(i=l.metadata(),i.form&&i.form.obj&&i.form.obj.head)e=i.form.obj.head;else{if(e={" ":[]},t instanceof O?(i.code_length&&e[" "].push("id"),i.main_presentation_name&&e[" "].push("name")):t instanceof k&&(e[" "].push("number_doc"),e[" "].push("date")),!t.is_folder)for(r in i.fields)"predefined_name"==r||i.fields[r].hide||e[" "].push(r);i.tabular_sections&&i.tabular_sections.extra_fields&&(e["Дополнительные реквизиты"]=[])}},d=function(e,t){_=M.utils.is_data_obj(e)?e.presentation:e,t.type.is_ref||(t.type.date_part?_=M.moment(_).format(M.moment._masks[t.type.date_part]):"boolean"==t.type.types[0]&&(_=_?"1":"0"))},p=function(e){s=_md.control_by_type(i.type,e),d(e,i)},h=function(e,r){if(r){var a=e.property||e.param||e.Параметр||e.Свойство,f=void 0!=e.value?e.value:e.Значение;a.empty()?(u=r+"|empty",s="ro",_="",i={synonym:"?"}):(i={synonym:a.presentation,type:a.type},u=r+"|"+a.ref,p(f),"edn"==s&&(s="calck"),a.mandatory&&(s+='" class="cell_mandatory'))}else if("object"==typeof e)u=e.id,i=n&&n.metadata&&n.metadata[u],i?e.synonym&&(i.synonym=e.synonym):i={synonym:e.synonym},s=e.type,_="",e.hasOwnProperty("txt")?_=e.txt:void 0!==(o=t[u])&&d(o,i.type?i:_md.get(l.class_name,u));else if(n&&n.metadata&&void 0!==(i=n.metadata[e]))u=e,p(o=t[e]);else{if(void 0===(o=t[e]))return;i=_md.get(l.class_name,u=e),p(o)}c+='<row id="'+u+'"><cell>'+(i.synonym||i.name)+'</cell><cell type="'+s+'">'+_+"</cell></row>"};f();for(r in e){" "!=r&&(c+='<row open="1"><cell>'+r+"</cell>");for(a in e[r])h(e[r][a]);if(n&&r==n.title&&t[n.ts]){var m,y=l.extra_fields(t),g="property,param,Свойство,Параметр".split(","),b=t[n.ts]._owner._metadata.tabular_sections[t[n.ts]._name].fields;g.some(function(e){if(b[e])return m=e,!0})&&(t[n.ts].forEach(function(e){var t=y.indexOf(e[m]);t!=-1&&y.splice(t,1)}),y.forEach(function(e){var r=t[n.ts].add();r[m]=e})),t[n.ts].find_rows(n.selection,function(e){h(e,n.ts)})}" "!=r&&(c+="</row>")}return c+="</rows>"},s.prototype.print=function(e,t,n){function r(e){n&&n.progressOff&&n.progressOff(),e&&e.focus()}if(n&&n.progressOn&&n.progressOn(),setTimeout(r,3e3),this._printing_plates[t]instanceof j&&(t=this._printing_plates[t]),t instanceof j&&t.execute)return e instanceof j?t.execute(e).then(r):this.get(e,!0,!0).then(t.execute.bind(t)).then(r);var a={};return M.ajax.default_attr(a,M.job_prm.irest_url()),a.url+=this.rest_name+"(guid'"+M.utils.fix_guid(e)+"')/Print(model="+t+", browser_uid="+M.wsql.get_user_param("browser_uid")+")",M.ajax.get_and_show_blob(a.url,a,"get").then(r)},s.prototype.printing_plates=function(){var e={},t=this;return t._printing_plates||(t.metadata().printing_plates?t._printing_plates=t.metadata().printing_plates:("ram"==t.metadata().cachable||t.metadata().cachable&&0==t.metadata().cachable.indexOf("doc"))&&(t._printing_plates={})),!t._printing_plates&&M.ajax.authorized?(M.ajax.default_attr(e,M.job_prm.irest_url()),e.url+=t.rest_name+"/Print()",M.ajax.get_ex(e.url,e).then(function(e){return t._printing_plates=JSON.parse(e.response),t._printing_plates}).catch(function(){}).then(function(e){return e||(t._printing_plates={})})):Promise.resolve(t._printing_plates)},_._extend(s),_.prototype.__define({push:{value:function(e,t){t&&t!=e.ref?(delete this.by_ref[e.ref],this.by_ref[t]=e):this.by_ref[e.ref]=e}},each:{value:function(e){for(var t in this.by_ref)if(t&&t!=M.utils.blank.guid&&1==e.call(this,this.by_ref[t]))break}},forEach:{value:function(e){return this.each.call(this,e)}},get:{value:function(e,t,n){var r=this.by_ref[e]||this.by_ref[e=M.utils.fix_guid(e)];if(!r){if(n&&!t)return;r=new(M[this.obj_constructor()])(e,this,(!0))}return t===!1?r:void 0===t&&e===M.utils.blank.guid?r:r.is_new()?r.load():t?Promise.resolve(r):r}},create:{value:function(e,t){e&&"object"==typeof e||(e={}),e.ref&&M.utils.is_guid(e.ref)&&!M.utils.is_empty_guid(e.ref)||(e.ref=M.utils.generate_guid());var n=this.by_ref[e.ref];if(!n)if(n=new(M[this.obj_constructor()])(e,this),!t&&e.ref&&e.presentation&&2==Object.keys(e).length);else{n instanceof k&&n.date==M.utils.blank.date&&(n.date=new Date);var r=this.handle_event(n,"after_create");if(r===!1)return Promise.resolve(n);if("object"==typeof r&&r.then)return r;if("e1cib"==this.cachable&&t){var a={};return M.ajax.default_attr(a,M.job_prm.irest_url()),a.url+=this.rest_name+"/Create()",M.ajax.get_ex(a.url,a).then(function(e){return n._mixin(JSON.parse(e.response),void 0,["ref"])})}}return Promise.resolve(n)}},unload_obj:{value:function(e){delete this.by_ref[e],this.alatable.some(function(t,n,r){if(t.ref==e)return r.splice(n,1),!0})}},find:{value:function(e,t){return M._find(this.by_ref,e,t)}},load_array:{value:function(e,t){for(var n,r,a=[],i=0;i<e.length;i++)n=M.utils.fix_guid(e[i]),r=this.by_ref[n],r?(r.is_new()||t)&&(r._mixin(e[i]),r._set_loaded()):(r=new(M[this.obj_constructor()])(e[i],this),t&&r._set_loaded()),a.push(r);return a}},first_folder:{value:function(e){for(var t in this.by_ref){var n=this.by_ref[t];if(n.is_folder&&(!e||M.utils.is_equal(e,n.owner)))return n}return this.get()}},get_sql_struct:{value:function(e){function t(){function t(){var e=[],t="_t_.ref, _t_.`_deleted`";return s.form&&s.form.selection?s.form.selection.fields.forEach(function(t){e.push(t)}):o instanceof g?(e.push("posted"),e.push("date"),e.push("number_doc")):(s.hierarchical&&s.group_hierarchy?e.push("is_folder"):e.push("0 as is_folder"),o instanceof y?(e.push("id"),e.push("name as presentation")):s.main_presentation_name?e.push("name as presentation"):s.code_length?e.push("id as presentation"):e.push("'...' as presentation"),s.has_owners&&e.push("owner"),s.code_length&&e.push("id")),e.forEach(function(e){t+=e.indexOf(" as ")!=-1?", "+e:_md.sql_mask(e,!0)}),t}function n(){var e,t="";if(s.form&&s.form.selection)for(var n in s.form.selection.fields)s.form.selection.fields[n].indexOf(" as ")!=-1&&s.form.selection.fields[n].indexOf("_t_.")==-1&&(e=s.form.selection.fields[n].split(" as "),e[0]=e[0].split("."),e[0].length>1&&(t&&(t+="\n"),t+="left outer join "+e[0][0]+" on "+e[0][0]+".ref = _t_."+e[1]));return t}function r(){var t;return t=o instanceof y?" WHERE ("+(f?0:1):s.hierarchical?s.has_owners?" WHERE ("+(u||f?1:0)+" OR _t_.parent = '"+l+"') AND ("+(_==M.utils.blank.guid?1:0)+" OR _t_.owner = '"+_+"') AND ("+(f?0:1):" WHERE ("+(u||f?1:0)+" OR _t_.parent = '"+l+"') AND ("+(f?0:1):s.has_owners?" WHERE ("+(_==M.utils.blank.guid?1:0)+" OR _t_.owner = '"+_+"') AND ("+(f?0:1):" WHERE ("+(f?0:1),o.sql_selection_where_flds?t+=o.sql_selection_where_flds(f):o instanceof g?t+=" OR _t_.number_doc LIKE '"+f+"'":((s.main_presentation_name||o instanceof y)&&(t+=" OR _t_.name LIKE '"+f+"'"),s.code_length&&(t+=" OR _t_.id LIKE '"+f+"'")),t+=") AND (_t_.ref != '"+M.utils.blank.guid+"')",e.selection&&("function"==typeof e.selection||e.selection.forEach(function(e){for(var n in e)if("function"==typeof e[n])t+="\n AND "+e[n](o,n)+" ";else if(s.fields.hasOwnProperty(n))if(e[n]===!0)t+="\n AND _t_."+n+" ";else if(e[n]===!1)t+="\n AND (not _t_."+n+") ";else if("object"==typeof e[n])if(M.utils.is_data_obj(e[n]))t+="\n AND (_t_."+n+" = '"+e[n]+"') ";else{var r,a=Object.keys(e[n]),i=e[n][a[0]],_=s.fields[n];_&&_.type.is_ref&&(r=_md.value_mgr({},n,_.type,!0,i)),t+="not"==a[0]?"\n AND (not _t_."+n+" = '"+i+"') ":"\n AND (_t_."+n+" = '"+i+"') "}else t+="string"==typeof e[n]?"\n AND (_t_."+n+" = '"+e[n]+"') ":"\n AND (_t_."+n+" = "+e[n]+") ";else"is_folder"==n&&s.hierarchical&&s.group_hierarchy})),t}function a(){return o instanceof y?"ORDER BY id":s.hierarchical?s.group_hierarchy?"ORDER BY _t_.is_folder desc, is_initial_value, presentation":"ORDER BY _t_.parent desc, is_initial_value, presentation":"ORDER BY is_initial_value, presentation"}function i(){function t(t){t&&(d=e.set_parent=t.parent.ref,l=d,u=!1),f&&f.indexOf("%")==-1&&(f="%"+f+"%")}s.has_owners&&(_=e.owner,e.selection&&"function"!=typeof e.selection&&e.selection.forEach(function(e){e.owner&&(_="object"==typeof e.owner?e.owner.valueOf():e.owner,delete e.owner)}),_||(_=M.utils.blank.guid)),c!=M.utils.blank.guid&&u&&s.hierarchical?t(o.get(c,!1)):t()}var _,u=!e.parent,l=e.parent||M.utils.blank.guid,c=e.initial_value||M.utils.blank.guid,f=e.filter||"",d=M.utils.blank.guid;i();var p;return p=o.sql_selection_list_flds?o.sql_selection_list_flds(c):("SELECT %2, case when _t_.ref = '"+c+"' then 0 else 1 end as is_initial_value FROM `"+o.table_name+"` AS _t_ %j %3 %4 LIMIT 300").replace("%2",t()).replace("%j",n()),p.replace("%3",r()).replace("%4",a())}function n(){var t="CREATE TABLE IF NOT EXISTS ";if(e&&e.postgres){t+=o.table_name+" (ref uuid PRIMARY KEY NOT NULL, _deleted boolean",o instanceof g?t+=", posted boolean, date timestamp with time zone, number_doc character(11)":(s.code_length&&(t+=", id character("+s.code_length+")"),t+=", name character varying(50), is_folder boolean");for(a in s.fields)a.length>30?s.fields[a].short_name?i=s.fields[a].short_name:(u++,i=a[0]+u+a.substr(a.length-27)):i=a,t+=", "+i+_md.sql_type(o,a,s.fields[a].type,!0)+_md.sql_composite(s.fields,a,i,!0);for(a in s.tabular_sections)t+=", ts_"+a+" JSON"}else{t+="`"+o.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, `_deleted` BOOLEAN",t+=o instanceof g?", posted boolean, date Date, number_doc CHAR":", id CHAR, name CHAR, is_folder BOOLEAN";for(a in s.fields)t+=_md.sql_mask(a)+_md.sql_type(o,a,s.fields[a].type)+_md.sql_composite(s.fields,a);for(a in s.tabular_sections)t+=", `ts_"+a+"` JSON"}return t+=")"}function r(){var e=["ref","_deleted"],t="INSERT INTO `"+o.table_name+"` (ref, `_deleted`",n="(?";"cat"==o.class_name.substr(0,3)?(t+=", id, name, is_folder",e.push("id"),e.push("name"),e.push("is_folder")):"doc"==o.class_name.substr(0,3)&&(t+=", posted, date, number_doc",e.push("posted"),e.push("date"),e.push("number_doc"));for(a in s.fields)t+=_md.sql_mask(a),e.push(a);for(a in s.tabular_sections)t+=", `ts_"+a+"`",e.push("ts_"+a);for(t+=") VALUES ",a=1;a<e.length;a++)n+=", ?";return n+=")",t+=n,{sql:t,fields:e,values:n}}var a,i,o=this,s=o.metadata(),_={},u=0,l=e&&e.action?e.action:"create_table";return"create_table"==l?_=n():["insert","update","replace"].indexOf(l)!=-1?_[o.table_name]=r():"select"==l?_="SELECT * FROM `"+o.table_name+"` WHERE ref = ?":"select_all"==l?_="SELECT * FROM `"+o.table_name+"`":"delete"==l?_="DELETE FROM `"+o.table_name+"` WHERE ref = ?":"drop"==l?_="DROP TABLE IF EXISTS `"+o.table_name+"`":"get_tree"==l?_=!e.filter||e.filter.is_folder?"SELECT ref, parent, name as presentation FROM `"+o.table_name+"` WHERE is_folder order by parent, name":"SELECT ref, parent, name as presentation FROM `"+o.table_name+"` order by parent, name":"get_selection"==l&&(_=t()),_}},caption_flds:{value:function(e){var t=e.metadata||this.metadata(),n='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>',r=[],a="";if(t.form&&t.form.selection?r=t.form.selection.cols:this instanceof g?(r.push(new Col_struct("date","160","ro","left","server","Дата")),r.push(new Col_struct("number_doc","140","ro","left","server","Номер")),t.fields.note&&r.push(new Col_struct("note","*","ro","left","server",t.fields.note.synonym)),t.fields.responsible&&r.push(new Col_struct("responsible","*","ro","left","server",t.fields.responsible.synonym))):this instanceof y?(r.push(new Col_struct("id","140","ro","left","server","Код")),r.push(new Col_struct("presentation","*","ro","left","server","Наименование"))):r.push(new Col_struct("presentation","*","ro","left","server","Наименование")),e.get_header&&r.length){a="<head>";for(var i in r)a+=n.replace("%1",r[i].id).replace("%2",r[i].width).replace("%3",r[i].type).replace("%4",r[i].align).replace("%5",r[i].sort).replace("%6",r[i].caption);a+="</head>"}return{head:a,acols:r}}},load_cached_server_array:{value:function(e,t){var n,r=[],a=this,i=t?{class_name:a.class_name,rest_name:t}:a,o=!t;if(e.forEach(function(e){n=a.get(e.ref||e,!1,!0),(!n||o&&n.is_new())&&r.push(e.ref||e)}),r.length){var s={url:"",selection:{ref:{in:r}}};return o&&(s.fields=["ref"]),M.rest.build_select(s,i),M.ajax.get_ex(s.url,s).then(function(t){var n=JSON.parse(t.response);if(o)n=n.value;else{n=n.data;for(var r in n)!n[r].ref&&n[r].id&&(n[r].ref=n[r].id),n[r].Код&&(n[r].id=n[r].Код,delete n[r].Код),n[r]._not_set_loaded=!0}return a.load_array(n),e})}return Promise.resolve(e)}},predefined:{value:function(e){return this._predefined||(this._predefined={}),this._predefined[e]||(this._predefined[e]=this.get(),this.find_rows({predefined_name:e},function(t){return this._predefined[e]=t,!1})),this._predefined[e]}}}),u._extend(s),u.prototype.__define({create:{value:function(){return new(M[this.obj_constructor()])({},this)}},unload_obj:{value:function(){}}}),l._extend(_),l.prototype.__define({get:{value:function(e){if(e instanceof R)return e;e&&e!=M.utils.blank.guid||(e="_");var t=this[e];return t||(t=new R({name:e},this)),t}},push:{value:function(e,t){this.__define(t,{value:e})}},each:{value:function(e){this.alatable.forEach(function(t){t.ref&&"_"!=t.ref&&t.ref!=M.utils.blank.guid&&e.call(this[t.ref])}.bind(this))}}}),l.prototype.get_sql_struct=function(e){var t="CREATE TABLE IF NOT EXISTS ",n=e&&e.action?e.action:"create_table";return e&&e.postgres?"create_table"==n?t+=this.table_name+" (ref character varying(255) PRIMARY KEY NOT NULL, sequence INT, synonym character varying(255))":["insert","update","replace"].indexOf(n)!=-1?(t={},t[this.table_name]={sql:"INSERT INTO "+this.table_name+" (ref, sequence, synonym) VALUES ($1, $2, $3)",fields:["ref","sequence","synonym"],values:"($1, $2, $3)"}):"delete"==n&&(t="DELETE FROM "+this.table_name+" WHERE ref = $1"):"create_table"==n?t+="`"+this.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, sequence INT, synonym CHAR)":["insert","update","replace"].indexOf(n)!=-1?(t={},t[this.table_name]={sql:"INSERT INTO `"+this.table_name+"` (ref, sequence, synonym) VALUES (?, ?, ?)",fields:["ref","sequence","synonym"],values:"(?, ?, ?)"}):"delete"==n&&(t="DELETE FROM `"+this.table_name+"` WHERE ref = ?"),t},l.prototype.get_option_list=function(e,t){function n(t){return M.utils.is_equal(t.value,e)&&(t.selected=!0),t}var r,a=[],i="";if(t)for(var o in t)"_"!=o.substr(0,1)&&("ref"==o?r=t[o].hasOwnProperty("in")?t[o].in:t[o]:i=t[o]);return"object"==typeof i&&(i=i.like?i.like:""),i=i.toLowerCase(),this.alatable.forEach(function(e){if(!i||e.synonym&&e.synonym.toLowerCase().indexOf(i)!=-1){if(r)if(Array.isArray(r)){if(!r.some(function(t){return t.name==e.ref||t.ref==e.ref||t==e.ref}))return}else if(r.name!=e.ref&&r.ref!=e.ref&&r!=e.ref)return;a.push(n({text:e.synonym||"",value:e.ref}))}}),Promise.resolve(a)},c._extend(s),c.prototype.__define({get_sql_struct:{value:function(e){function t(){function t(){var e=[],t="_t_.ref";if(s.form&&s.form.selection)s.form.selection.fields.forEach(function(t){e.push(t)});else for(var n in s.dimensions)e.push(n);return e.forEach(function(e){t+=e.indexOf(" as ")!=-1?", "+e:_md.sql_mask(e,!0)}),t}function n(){var e,t="";if(s.form&&s.form.selection)for(var n in s.form.selection.fields)s.form.selection.fields[n].indexOf(" as ")!=-1&&s.form.selection.fields[n].indexOf("_t_.")==-1&&(e=s.form.selection.fields[n].split(" as "),
e[0]=e[0].split("."),e[0].length>1&&(t&&(t+="\n"),t+="left outer join "+e[0][0]+" on "+e[0][0]+".ref = _t_."+e[1]));return t}function r(){var t=" WHERE ("+(i?0:1);return o.sql_selection_where_flds&&(t+=o.sql_selection_where_flds(i)),t+=")",e.selection&&("function"==typeof e.selection||e.selection.forEach(function(e){for(var n in e)if("function"==typeof e[n])t+="\n AND "+e[n](o,n)+" ";else if(s.fields.hasOwnProperty(n))if(e[n]===!0)t+="\n AND _t_."+n+" ";else if(e[n]===!1)t+="\n AND (not _t_."+n+") ";else if("object"==typeof e[n])if(M.utils.is_data_obj(e[n]))t+="\n AND (_t_."+n+" = '"+e[n]+"') ";else{var r,a=Object.keys(e[n]),i=e[n][a[0]],_=s.fields[n];_&&_.type.is_ref&&(r=_md.value_mgr({},n,_.type,!0,i)),t+="not"==a[0]?"\n AND (not _t_."+n+" = '"+i+"') ":"\n AND (_t_."+n+" = '"+i+"') "}else t+="string"==typeof e[n]?"\n AND (_t_."+n+" = '"+e[n]+"') ":"\n AND (_t_."+n+" = "+e[n]+") ";else"is_folder"==n&&s.hierarchical&&s.group_hierarchy})),t}function a(){return""}var i=e.filter||"";i&&i.indexOf("%")==-1&&(i="%"+i+"%");var _;return _=o.sql_selection_list_flds?o.sql_selection_list_flds():("SELECT %2 FROM `"+o.table_name+"` AS _t_ %j %3 %4 LIMIT 300").replace("%2",t()).replace("%j",n()),_.replace("%3",r()).replace("%4",a())}function n(){var t="CREATE TABLE IF NOT EXISTS ",n=!0;if(e&&e.postgres){t+=o.table_name+" (",s.splitted&&(t+="zone integer",n=!1);for(i in s.dimensions)n?(t+=i,n=!1):t+=", "+i,t+=_md.sql_type(o,i,s.dimensions[i].type,!0)+_md.sql_composite(s.dimensions,i,"",!0);for(i in s.resources)t+=", "+i+_md.sql_type(o,i,s.resources[i].type,!0)+_md.sql_composite(s.resources,i,"",!0);for(i in s.attributes)t+=", "+i+_md.sql_type(o,i,s.attributes[i].type,!0)+_md.sql_composite(s.attributes,i,"",!0);t+=", PRIMARY KEY (",n=!0,s.splitted&&(t+="zone",n=!1);for(i in s.dimensions)n?(t+=i,n=!1):t+=", "+i}else{t+="`"+o.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, `_deleted` BOOLEAN";for(i in s.dimensions)t+=_md.sql_mask(i)+_md.sql_type(o,i,s.dimensions[i].type);for(i in s.resources)t+=_md.sql_mask(i)+_md.sql_type(o,i,s.resources[i].type);for(i in s.attributes)t+=_md.sql_mask(i)+_md.sql_type(o,i,s.attributes[i].type)}return t+=")"}function r(){var e="INSERT OR REPLACE INTO `"+o.table_name+"` (",t=[],n=!0;for(i in s.dimensions)n?(e+=i,n=!1):e+=", "+i,t.push(i);for(i in s.resources)e+=", "+i,t.push(i);for(i in s.attributes)e+=", "+i,t.push(i);for(e+=") VALUES (?",i=1;i<t.length;i++)e+=", ?";return e+=")",{sql:e,fields:t}}function a(){var t="SELECT * FROM `"+o.table_name+"` WHERE ",n=!0;e._values=[];for(var r in s.dimensions)n?n=!1:t+=" and ",t+="`"+r+"`=?",e._values.push(e[r]);return n&&(t+="1"),t}var i,o=this,s=o.metadata(),_={},u=e&&e.action?e.action:"create_table";return"create_table"==u?_=n():u in{insert:"",update:"",replace:""}?_[o.table_name]=r():"select"==u?_=a():"select_all"==u?_=a():"delete"==u?_="DELETE FROM `"+o.table_name+"` WHERE ref = ?":"drop"==u?_="DROP TABLE IF EXISTS `"+o.table_name+"`":"get_selection"==u&&(_=t()),_}},get_ref:{value:function(e){if(e instanceof P&&(e=e._obj),e.ref)return e.ref;var t="",n=this.metadata().dimensions;for(var r in n)t+=t?"¶":"",t+=n[r].type.is_ref?M.utils.fix_guid(e[r]):!e[r]&&n[r].type.digits?"0":n[r].date_part?M.moment(e[r]||M.utils.blank.date).format(M.moment.defaultFormatUtc):void 0!=e[r]?String(e[r]):"$";return t}},caption_flds:{value:function(e){var t=e.metadata||this.metadata(),n='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>',r=[],a="";if(t.form&&t.form.selection)r=t.form.selection.cols;else for(var i in t.dimensions)r.push(new Col_struct(i,"*","ro","left","server",t.dimensions[i].synonym));if(e.get_header&&r.length){a="<head>";for(var o in r)a+=n.replace("%1",r[o].id).replace("%2",r[o].width).replace("%3",r[o].type).replace("%4",r[o].align).replace("%5",r[o].sort).replace("%6",r[o].caption);a+="</head>"}return{head:a,acols:r}}},create:{value:function(e){e&&"object"==typeof e||(e={});var t=this.by_ref[e.ref];if(!t){t=new(M[this.obj_constructor()])(e,this);var n=this.handle_event(t,"after_create");if(n===!1)return Promise.resolve(t);if("object"==typeof n&&n.then)return n}return Promise.resolve(t)}}}),f._extend(c),f.prototype.slice_first=function(e){},f.prototype.slice_last=function(e){},d._extend(f),p._extend(c),h._extend(_),h.prototype.by_name=function(e){var t;return this.find_rows({name:e},function(e){return t=e,!1}),t||(t=this.get()),t},h.prototype.by_id=function(e){var t;return this.find_rows({id:e},function(e){return t=e,!1}),t||(t=this.get()),t},h.prototype.path=function(e){var t,n=[];if(t=e instanceof j?e:this.get(e,!1,!0),t&&n.push({ref:t.ref,presentation:t.presentation}),t&&this.metadata().hierarchical)for(;;){if(t=t.parent,t.empty())break;n.push({ref:t.ref,presentation:t.presentation})}return n},m._extend(h),y._extend(h),g._extend(_),b._extend(h),v._extend(h),w.prototype.toString=function(){return"Табличная часть "+this._owner._manager.class_name+"."+this._name},w.prototype.get=function(e){return this._obj[e]._row},w.prototype.count=function(){return this._obj.length},w.prototype.clear=function(e){for(var t in this._obj)delete this._obj[t];return this._obj.length=0,e||this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name}),this},w.prototype.del=function(e,t){var n,r=this._obj;if("undefined"!=typeof e){if("number"==typeof e)n=e;else if(r[e.row-1]._row===e)n=e.row-1;else for(var a in r)if(r[a]._row===e){n=Number(a),delete r[a]._row;break}void 0!=n&&(r.splice(n,1),r.forEach(function(e,t){e.row=t+1}),t||this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name}),this._owner._data._modified=!0)}},w.prototype.find=function(e,t){var n=M._find(this._obj,e,t);if(n)return n._row},w.prototype.find_rows=function(e,t){var n=this,r=t?function(e){return t.call(n,e._row)}:null;return M._find_rows.call(n,n._obj,e,r)},w.prototype.swap=function(e,t){var n=this._obj[e];this._obj[e]=this._obj[t],this._obj[t]=n,this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name})},w.prototype.add=function(e,t){var n=new(M[this._owner._manager.obj_constructor(this._name)])(this);e||(e={});for(var r in n._metadata.fields)n[r]=e[r]||"";return n._obj.row=this._obj.push(n._obj),n._obj.__define("_row",{value:n,enumerable:!1}),t||this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name}),e=null,this._owner._data._modified=!0,n},w.prototype.each=function(e){var t=this;t._obj.forEach(function(n){return e.call(t,n._row)})},w.prototype.forEach=w.prototype.each,w.prototype.group_by=function(e,t){try{var n=this.aggregate(e,t,"SUM",!0);return this.clear(!0).load(n)}catch(e){}},w.prototype.sort=function(e){"string"==typeof e&&(e=e.split(","));var t="select * from ? order by ",n=!0;e.forEach(function(e){e=e.trim().replace(/\s{1,}/g," ").split(" "),n?n=!1:t+=", ",t+="`"+e[0]+"`",e[1]&&(t+=" "+e[1])});try{return n=M.wsql.alasql(t,[this._obj]),this.clear(!0).load(n)}catch(e){M.record_log(e)}},w.prototype.aggregate=function(e,t,n,r){if("string"==typeof e&&(e=e.split(",")),"string"==typeof t&&(t=t.split(",")),n||(n="sum"),!e.length&&1==t.length&&"sum"==n)return this._obj.reduce(function(e,n,r,a){return e+n[t[0]]},0);var a,i=!0;t.forEach(function(e){a?a+=", "+n+"(`"+e+"`) `"+e+"`":a="select "+n+"(`"+e+"`) `"+e+"`"}),e.forEach(function(e){a?a+=", `"+e+"`":a="select `"+e+"`"}),a+=" from ? ",e.forEach(function(e){i?(a+="group by ",i=!1):a+=", ",a+="`"+e+"`"});try{return i=M.wsql.alasql(a,[this._obj]),r||(i=1==t.length?i.length?i[0][t[0]]:0:i.length?i[0]:{}),i}catch(e){M.record_log(e)}},w.prototype.load=function(e){var t,n=this;return n.clear(!0),e instanceof w?t=e._obj:Array.isArray(e)&&(t=e),t&&t.forEach(function(e){n.add(e,!0)}),this._owner._data._silent||Object.getNotifier(n._owner).notify({type:"rows",tabular:n._name}),n},w.prototype.sync_grid=function(e,t){for(var n={rows:[]},r=[],a=0;a<e.getColumnCount();a++)r.push(e.getColumnId(a));if(e.clearAll(),this.find_rows(t,function(e){var t=[];r.forEach(function(n){M.utils.is_data_obj(e[n])?t.push(e[n].presentation):t.push(e[n])}),n.rows.push({id:e.row,data:t})}),e.objBox)try{e.parse(n,"json"),e.callEvent("onGridReconstructed",[])}catch(e){}},w.prototype.toJSON=function(){return this._obj},x.prototype.__define("_metadata",{get:function(){return this._owner._owner._metadata.tabular_sections[this._owner._name]},enumerable:!1}),x.prototype.__define("row",{get:function(){return this._obj.row||0},enumerable:!0}),x.prototype.__define("_clone",{value:function(){return new(M[this._owner._owner._manager.obj_constructor(this._owner._name)])(this._owner)._mixin(this._obj)},enumerable:!1}),x.prototype._getter=j.prototype._getter,x.prototype._setter=function(e,t){if(this._obj[e]!=t&&(t||this._obj[e]!=M.utils.blank.guid)){if(this._owner._owner._data._silent||Object.getNotifier(this._owner._owner).notify({type:"row",row:this,tabular:this._owner._name,name:e,oldValue:this._obj[e]}),this._metadata.fields[e].choice_type){var n;n=2==this._metadata.fields[e].choice_type.path.length?this[this._metadata.fields[e].choice_type.path[1]]:this._owner._owner[this._metadata.fields[e].choice_type.path[0]],n&&n.type&&(t=M.utils.fetch_type(t,n.type))}j.prototype.__setter.call(this,e,t),this._owner._owner._data._modified=!0}},j.prototype._getter=function(e){var t,n=this._metadata.fields[e].type,r=this._obj?this._obj[e]:"";return"type"==e&&"object"==typeof r?r:"ref"==e?r:n.is_ref?n.digits&&"number"==typeof r?r:n.hasOwnProperty("str_len")&&!M.utils.is_guid(r)?r:(t=_md.value_mgr(this._obj,e,n))?M.utils.is_data_mgr(t)?t.get(r,!1):M.utils.fetch_type(r,t):r?(console.log([e,n,this._obj]),null):void 0:n.date_part?M.utils.fix_date(this._obj[e],!0):n.digits?M.utils.fix_number(this._obj[e],!n.hasOwnProperty("str_len")):"boolean"==n.types[0]?M.utils.fix_boolean(this._obj[e]):this._obj[e]||""},j.prototype.__setter=function(e,t){var n,r=this._metadata.fields[e].type;"type"==e&&t.types?this._obj[e]=t:"ref"==e?this._obj[e]=M.utils.fix_guid(t):r.is_ref?r.digits&&"number"==typeof t||r.hasOwnProperty("str_len")&&"string"==typeof t&&!M.utils.is_guid(t)?this._obj[e]=t:(this._obj[e]=M.utils.fix_guid(t),n=_md.value_mgr(this._obj,e,r,!1,t),n?n instanceof l?"string"==typeof t?this._obj[e]=t:t?"object"==typeof t&&(this._obj[e]=t.ref||t.name||""):this._obj[e]="":t&&t.presentation?(!t.type||t instanceof j||delete t.type,n.create(t)):M.utils.is_data_mgr(n)||(this._obj[e]=M.utils.fetch_type(t,n)):"object"!=typeof t&&(this._obj[e]=t)):r.date_part?this._obj[e]=M.utils.fix_date(t,!0):r.digits?this._obj[e]=M.utils.fix_number(t,!r.hasOwnProperty("str_len")):"boolean"==r.types[0]?this._obj[e]=M.utils.fix_boolean(t):this._obj[e]=t},j.prototype.__notify=function(e){this._data._silent||Object.getNotifier(this).notify({type:"update",name:e,oldValue:this._obj[e]})},j.prototype._setter=function(e,t){this._obj[e]!=t&&(this.__notify(e),this.__setter(e,t),this._data._modified=!0)},j.prototype._getter_ts=function(e){return this._ts_(e)},j.prototype._setter_ts=function(e,t){var n=this._ts_(e);n instanceof w&&Array.isArray(t)&&n.load(t)},j.prototype.__define({valueOf:{value:function(){return this.ref}},toJSON:{value:function(){return this._obj}},toString:{value:function(){return this.presentation}},_metadata:{get:function(){return this._manager.metadata()}},_deleted:{get:function(){return!!this._obj._deleted}},_modified:{get:function(){return!!this._data&&!!this._data._modified}},is_new:{value:function(){return this._data._is_new}},_set_loaded:{value:function(e){this._manager.push(this,e),this._data._modified=!1,this._data._is_new=!1}},mark_deleted:{value:function(e){this._obj._deleted=!!e,this.save(),this.__notify("_deleted")}},ref:{get:function(){return this._obj.ref},set:function(e){this._obj.ref=M.utils.fix_guid(e)},enumerable:!0,configurable:!0},empty:{value:function(){return M.utils.is_empty_guid(this._obj.ref)}},load:{value:function(){var e=function(){return e=null,this._data._modified=!1,this}.bind(this);return this.ref==M.utils.blank.guid?(this instanceof O?this.id="000000000":this.number_doc="000000000",Promise.resolve(this)):this._manager.cachable&&"e1cib"!=this._manager.cachable?M.wsql.pouch.load_obj(this).then(e):L.load_obj(this).then(e)}},unload:{value:function(){var e,t=this._obj;this._manager.unload_obj(this.ref),this._observers&&(this._observers.length=0),this._notis&&(this._notis.length=0);for(e in this._metadata.tabular_sections)this[e].clear(!0);for(e in this)this.hasOwnProperty(e)&&delete this[e];for(e in t)delete t[e];["_ts_","_obj","_data"].forEach(function(e){delete this[e]}.bind(this)),e=t=null}},save:{value:function(e,t,n){this instanceof k&&"boolean"==typeof e&&(this.posted=e);var r,a=this._manager.handle_event(this,"before_save"),i=function(){return a!==!1&&(this._data._modified=!1),r=null,a=null,i=null,this}.bind(this);if(this._metadata.hierarchical&&!this._obj.parent&&(this._obj.parent=M.utils.blank.guid),!this.id&&this._metadata.code_length&&"ram"!=this._manager.cachable){var o=(M.current_acl&&M.current_acl.prefix||"")+(M.wsql.get_user_param("zone")+"-"),s=this._metadata.code_length-o.length,_="",u=M.wsql.alasql("select max(id) as id from ? where id like '"+o+"%'",[this._manager.alatable]);if(u.length){for(var l=u[0].id||"",c=l.length-1;c>0&&!isNaN(parseInt(l[c]));c--)_=l[c]+_;_=(parseInt(_||0)+1).toFixed(0)}else _="1";for(;_.length<s;)_="0"+_;this.id=o+_}if(this instanceof k&&M.utils.blank.date==this.date&&(this.date=new Date),M.msg&&M.msg.show_msg)for(var f in this._metadata.fields)if(this._metadata.fields[f].mandatory&&!this._obj[f])return M.msg.show_msg({title:M.msg.mandatory_title,type:"alert-error",text:M.msg.mandatory_field.replace("%1",this._metadata.fields[f].synonym)}),a=!1,Promise.reject(i());return a===!1?Promise.resolve(this).then(i):a instanceof Promise||"object"==typeof a&&a.then?a.then(i):(r=this._manager.cachable&&"e1cib"!=this._manager.cachable?M.wsql.pouch.save_obj:L.save_irest,r(this,{post:e,operational:t,attachments:n}).then(function(e){return e._manager.handle_event(e,"after_save")}).then(i))}},get_attachment:{value:function(e){return this._manager.get_attachment(this.ref,e)}},save_attachment:{value:function(e,t,n){return this._manager.save_attachment(this.ref,e,t,n)}},delete_attachment:{value:function(e){return this._manager.get_attachment(this.ref,e)}},_silent:{value:function(e){"boolean"==typeof e?this._data._silent=e:(this._data._silent=!0,setTimeout(function(){this._data._silent=!1}.bind(this)))}},print:{value:function(e,t){return this._manager.print(this,e,t)}}}),O._extend(j),O.prototype.__define("id",{get:function(){return this._obj.id||""},set:function(e){this.__notify("id"),this._obj.id=e},enumerable:!0}),O.prototype.__define("name",{get:function(){return this._obj.name||""},set:function(e){this.__notify("name"),this._obj.name=String(e)},enumerable:!0}),k._extend(j),k.prototype.__define({posted:{get:function(){return this._obj.posted||!1},set:function(e){this.__notify("posted"),this._obj.posted=M.utils.fix_boolean(e)},enumerable:!0}}),E(k.prototype),q._extend(j),A._extend(O),E(A.prototype),D._extend(O),E(D.prototype),R._extend(j),R.prototype.__define({order:{get:function(){return this._obj.sequence},set:function(e){this._obj.sequence=parseInt(e)},enumerable:!0},name:{get:function(){return this._obj.ref},set:function(e){this._obj.ref=String(e)},enumerable:!0},synonym:{get:function(){return this._obj.synonym||""},set:function(e){this._obj.synonym=String(e)},enumerable:!0},presentation:{get:function(){return this.synonym||this.name}},empty:{value:function(){return!this.ref||"_"==this.ref}}}),P._extend(j),P.prototype.__define({_metadata:{get:function(){var e=this._manager.metadata();return e.fields||(e.fields={}._mixin(e.dimensions)._mixin(e.resources)._mixin(e.attributes)),e}},ref:{get:function(){return this._manager.get_ref(this)},enumerable:!0},presentation:{get:function(){return this._metadata.obj_presentation||this._metadata.synonym}}});var L=M.rest=new S;return s.prototype.__define("rest_name",{get:function(){var e=this.class_name.split("."),t={cat:"Catalog",doc:"Document",ireg:"InformationRegister",areg:"AccumulationRegister",cch:"ChartOfCharacteristicTypes",cacc:"ChartOfAccounts",tsk:"Task",bp:"BusinessProcess"};return t[e[0]]+"_"+_md.syns_1с(e[1])},enumerable:!1}),s.prototype.rest_tree=function(e){var t,n,r=this,a=r.metadata(),i=[];return M.ajax.default_attr(e,!a.irest&&M.job_prm.rest?M.job_prm.rest_url():M.job_prm.irest_url()),e.url+=this.rest_name+"?allowedOnly=true&$format=json&$top=1000&$select=Ref_Key,DeletionMark,Parent_Key,Description&$filter=IsFolder eq true",M.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(e){for(var r=0;r<e.value.length;r++)n=e.value[r],t={ref:n.Ref_Key,_deleted:n.DeletionMark,parent:n.Parent_Key,presentation:n.Description},i.push(t);return M.iface.data_to_tree(i)})},s.prototype.rest_selection=function(e){if("get_tree"==e.action)return this.rest_tree(e);var t,n,r,a,i,o,s=this,_=s.metadata(),u=[],l=[];return i=function(){var e="$select=Ref_Key,DeletionMark";return _.form&&_.form.selection?_.form.selection.fields.forEach(function(e){u.push(e)}):s instanceof g?(u.push("posted"),u.push("date"),u.push("number_doc")):s instanceof b?(u.push("name as presentation"),u.push("date"),u.push("number_doc"),u.push("completed")):s instanceof v?(u.push("date"),u.push("number_doc"),u.push("started"),u.push("finished")):(_.hierarchical&&_.group_hierarchy?u.push("is_folder"):u.push("0 as is_folder"),_.main_presentation_name?u.push("name as presentation"):_.code_length?u.push("id as presentation"):u.push("'...' as presentation"),_.has_owners&&u.push("owner"),_.code_length&&u.push("id")),u.forEach(function(t){var n;if(t.indexOf(" as ")!=-1)if(n=t.split(" as ")[0].split("."),1==n.length)t=n[0];else{if("_t_"!=n[0])return;t=n[1]}"0"!=t&&(r=_md.syns_1с(t),_md.get(s.class_name,t).type.is_ref&&r.indexOf("_Key")==-1&&_md.get(s.class_name,t).type.types.length&&_md.get(s.class_name,t).type.types[0].indexOf("enm.")==-1&&(r+="_Key"),e+=","+r)}),u.push("ref"),u.push("_deleted"),e}(),M.ajax.default_attr(e,!_.irest&&M.job_prm.rest?M.job_prm.rest_url():M.job_prm.irest_url()),e.url+=(_.irest&&_.irest.selection?_.irest.selection:this.rest_name)+"?allowedOnly=true&$format=json&$top=1000&"+i,_md.get(s.class_name,"date")&&(e.date_from||e.date_till)&&(e.url+="&$filter="+L.filter_date("Date",e.date_from,e.date_till),o=!0),_.hierarchical&&e.parent&&(e.url+=o?" and ":"&$filter=",e.url+="Parent_Key eq guid'"+e.parent+"'",o=!0),_.has_owners&&e.owner&&(e.url+=o?" and ":"&$filter=",e.url+="Owner_Key eq guid'"+e.owner+"'",o=!0),e.filter&&(e.url+=o?" and ":"&$filter=",e.url+="$filter eq '"+e.filter+"'",o=!0),M.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(i){for(var o=0;o<i.value.length;o++)n=i.value[o],t={},u.forEach(function(e){var i;if("ref"==e)return void(t[e]=n.Ref_Key);if(e.indexOf(" as ")!=-1?(i=e.split(" as ")[1],e=e.split(" as ")[0].split("."),e=e[e.length-1]):i=e,r=_md.syns_1с(e),a=_md.get(s.class_name,e))if(r.indexOf("_Key")==-1&&a.type.is_ref&&a.type.types.length&&a.type.types[0].indexOf("enm.")==-1&&(r+="_Key"),a.type.date_part)t[i]=M.moment(n[r]).format(M.moment._masks[a.type.date_part]);else if(a.type.is_ref)if(n[r]&&n[r]!=M.utils.blank.guid){var o=_md.value_mgr(t,e,a.type,!1,n[r]);o?t[i]=o.get(n[r]).presentation:t[i]=""}else t[i]="";else t[i]=n[r]}),l.push(t);return M.iface.data_to_grid.call(s,l,e)})},f.prototype.rest_slice_last=function(e){e.period||(e.period=M.utils.date_add_day(new Date,1));var t=this,n=t.metadata(),r="Period=datetime'"+M.moment(e.period).format(M.moment._masks.iso)+"'",a="";for(var i in n.dimensions)if(void 0!==e[i]){var o=_md.syns_1с(i),s=n.dimensions[i];o.indexOf("_Key")==-1&&s.type.is_ref&&s.type.types.length&&s.type.types[0].indexOf("enm.")==-1?(o+="_Key",a&&(a+=" and "),a+=o+" eq guid'"+e[i].ref+"'"):(a&&(a+=" and "),a+=s.type.digits?o+" eq "+M.utils.fix_number(e[i]):s.type.date_part?o+" eq datetime'"+M.moment(e[i]).format(M.moment._masks.iso)+"'":o+" eq '"+e[i]+"'")}return a&&(r+=",Condition='"+a+"'"),M.ajax.default_attr(e,M.job_prm.rest_url()),e.url+=this.rest_name+"/SliceLast(%sl)?allowedOnly=true&$format=json&$top=1000".replace("%sl",r),L.ajax_to_data(e,t).then(function(e){return t.load_array(e)})},j.prototype.to_atom=function(e){function t(e){var t=e._metadata.fields,a=e instanceof x?"\n\t<d:":"\n<d:";for(n in t){if(r=t[n],s=_md.syns_1с(n),_=e[n],_ instanceof R)_=_.empty()?"":_.name;else if(_ instanceof j)s.indexOf("_Key")==-1&&(s+="_Key"),_=_.ref;else if(r.type.date_part)_=_.getFullYear()<1e3?"0001-01-01T00:00:00Z":M.moment(_).format(M.moment.defaultFormatUtc);else if(void 0==_)continue;l+=a+s+">"+_+"</d:"+s+">"}}var n,r,a,i,o,s,_,u='<entry><category term="StandardODATA.%n" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme"/>\t\t\t\t\n<title type="text"/><updated>%d</updated><author/><summary/><content type="application/xml">\t\t\t\t\n<m:properties xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata">\t\t\t%p\t\t\t\n</m:properties></content></entry>'.replace("%n",this._manager.rest_name).replace("%d",M.moment().format(M.moment.defaultFormatUtc)),l="\n<d:Ref_Key>"+this.ref+"</d:Ref_Key>\n<d:DeletionMark>"+this._deleted+"</d:DeletionMark>";this instanceof k?(l+="\n<d:Date>"+M.moment(this.date).format(M.moment.defaultFormatUtc)+"</d:Date>",l+="\n<d:Number>"+this.number_doc+"</d:Number>"):(this._metadata.main_presentation_name&&(l+="\n<d:Description>"+this.name+"</d:Description>"),this._metadata.code_length&&(l+="\n<d:Code>"+this.id+"</d:Code>"),this._metadata.hierarchical&&this._metadata.group_hierarchy&&(l+="\n<d:IsFolder>"+this.is_folder+"</d:IsFolder>")),t(this);for(a in this._metadata.tabular_sections)o=this._metadata.tabular_sections[a],s="StandardODATA."+this._manager.rest_name+"_"+_md.syns_1с(a)+"_RowType",i=this[a],i.count()?(l+="\n<d:"+_md.syns_1с(a)+' m:type="Collection('+s+')">',i.each(function(e){l+='\n\t<d:element m:type="'+s+'">',l+="\n\t<d:LineNumber>"+e.row+"</d:LineNumber>",t(e),l+="\n\t</d:element>"}),l+="\n</d:"+_md.syns_1с(a)+">"):l+="\n<d:"+_md.syns_1с(a)+' m:type="Collection('+s+')" />';return u.replace("%p",l)},s.prototype.__define({pouch_load_array:{value:function(e,t){var n={limit:e.length+1,include_docs:!0,keys:e.map(function(e){return this.class_name+"|"+e}.bind(this))};return t&&(n.attachments=!0,n.binary=!0),this.pouch_db.allDocs(n).then(function(e){return M.wsql.pouch.load_changes(e,{})})}},pouch_load_view:{value:function(e){var t,n=this,r=[],a={limit:1e3,include_docs:!0,startkey:n.class_name+"|",endkey:n.class_name+"|￿"};return new Promise(function(i,o){function s(_,u){u?u.rows.length?(a.startkey=u.rows[u.rows.length-1].key,a.skip=1,u.rows.forEach(function(e){t=e.doc,key=t._id.split("|"),t.ref=key[1],r.push(t)}),n.load_array(r),r.length=0,n.pouch_db.query(e,a,s)):i():_&&o(_)}n.pouch_db.query(e,a,s)})}},pouch_db:{get:function(){return this.cachable.indexOf("_remote")!=-1?M.wsql.pouch.remote[this.cachable.replace("_remote","")]:M.wsql.pouch.local[this.cachable]||M.wsql.pouch.remote[this.cachable]}},pouch_find_rows:{value:function(e){var t,n,r,a,i,o,s=this,_=[],u=0,l=0,c=0,f={limit:100,include_docs:!0,startkey:s.class_name+"|",endkey:s.class_name+"|￿"};return e&&(e._top?(i=e._top,delete e._top):i=300,e._raw&&(n=e._raw,delete e._raw),e._total_count&&(a=e._total_count,delete e._total_count),e._view&&(r=e._view,delete e._view),e._key&&("des"==e._key._order_by?(f.startkey=e._key.endkey||e._key+"￿",f.endkey=e._key.startkey||e._key,f.descending=!0):(f.startkey=e._key.startkey||e._key,f.endkey=e._key.endkey||e._key+"￿")),"number"==typeof e._skip&&(l=e._skip,delete e._skip),e._attachments&&(f.attachments=!0,f.binary=!0,delete e._attachments)),a&&(o=!0,a=0,Object.keys(e).length<=1&&e._key&&e._key.hasOwnProperty("_search"))?(f.include_docs=!1,f.limit=1e5,s.pouch_db.query(r,f).then(function(t){return t.rows.forEach(function(t){if(!e._key._search||t.key[t.key.length-1].toLowerCase().indexOf(e._key._search)!=-1){if(a++,l&&(c++,c<l))return;if(i&&(u++,u>i))return;_.push(t.id)}}),delete f.startkey,delete f.endkey,f.descending&&delete f.descending,f.keys=_,f.include_docs=!0,s.pouch_db.allDocs(f)}).then(function(e){return{rows:e.rows.map(function(e){var t=e.doc;return t.ref=t._id.split("|")[1],n||(delete t._id,delete t._rev),t}),_total_count:a}})):new Promise(function(d,p){function h(r,h){h?h.rows.length?(f.startkey=h.rows[h.rows.length-1].key,f.skip=1,h.rows.forEach(function(r){t=r.doc,key=t._id.split("|"),t.ref=key[1],n||(delete t._id,delete t._rev),M._selection.call(s,t,e)&&(o&&a++,l&&(c++,c<l)||i&&(u++,u>i)||_.push(t))}),i&&u>i&&!o?d(n?_:s.load_array(_)):m()):d(o?{rows:n?_:s.load_array(_),_total_count:a}:n?_:s.load_array(_)):r&&p(r)}function m(){r?s.pouch_db.query(r,f,h):s.pouch_db.allDocs(f,h)}m()})}},pouch_selection:{value:function(e){var t,n,r,a=this,i=e.metadata||a.metadata(),o=["ref","_deleted"],s={_raw:!0,_total_count:!0,_top:e.count||30,_skip:e.start||0},_=[];if(i.form&&i.form.selection?i.form.selection.fields.forEach(function(e){o.push(e)}):a instanceof g?(o.push("posted"),o.push("date"),o.push("number_doc")):a instanceof b?(o.push("name as presentation"),o.push("date"),o.push("number_doc"),o.push("completed")):a instanceof v?(o.push("date"),o.push("number_doc"),o.push("started"),o.push("finished")):(i.hierarchical&&i.group_hierarchy?o.push("is_folder"):o.push("0 as is_folder"),i.main_presentation_name?o.push("name as presentation"):i.code_length?o.push("id as presentation"):o.push("'...' as presentation"),i.has_owners&&o.push("owner"),i.code_length&&o.push("id")),_md.get(a.class_name,"date")&&(e.date_from||e.date_till)&&(e.date_from||(e.date_from=new Date("2015-01-01")),e.date_till||(e.date_till=M.utils.date_add_day(new Date,1)),s.date={between:[e.date_from,e.date_till]}),i.hierarchical&&e.parent&&(s.parent=e.parent),e.selection)if(Array.isArray(e.selection))e.selection.forEach(function(e){for(r in e)"_"==r[0]&&"_view"!=r&&"_key"!=r||(s[r]=e[r])});else for(r in e.selection)"_"==r[0]&&"_view"!=r&&"_key"!=r||(s[r]=e.selection[r]);return s._key&&s._key._drop_date&&s.date&&delete s.date,!e.filter||s._key&&s._key._search||(1==i.input_by_string.length?s[i.input_by_string]={like:e.filter}:(s.or=[],i.input_by_string.forEach(function(t){var n={};n[t]={like:e.filter},s.or.push(n)}))),s._key&&s._key._order_by&&(s._key._order_by=e.direction),a.pouch_find_rows(s).then(function(i){return i.hasOwnProperty("_total_count")&&i.hasOwnProperty("rows")&&(e._total_count=i._total_count,i=i.rows),i.forEach(function(e){t={},o.forEach(function(i){if("ref"==i)return void(t[i]=e[i]);if(i.indexOf(" as ")!=-1?(r=i.split(" as ")[1],i=i.split(" as ")[0].split("."),i=i[i.length-1]):r=i,n=_md.get(a.class_name,i))if(n.type.date_part)t[r]=M.moment(e[i]).format(M.moment._masks[n.type.date_part]);else if(n.type.is_ref)if(e[i]&&e[i]!=M.utils.blank.guid){var o=_md.value_mgr(t,i,n.type,!1,e[i]);o?t[r]=o.get(e[i]).presentation:t[r]=""}else t[r]="";else"number"==typeof e[i]&&n.type.fraction_figits?t[r]=e[i].toFixed(n.type.fraction_figits):t[r]=e[i]}),_.push(t)}),M.iface.data_to_grid.call(a,_,e)}).catch(M.record_log)}},pouch_tree:{value:function(e){return this.pouch_find_rows({is_folder:!0,_raw:!0,_top:e.count||300,_skip:e.start||0}).then(function(e){return e.sort(function(e,t){return e.parent==M.utils.blank.guid&&t.parent!=M.utils.blank.guid?-1:t.parent==M.utils.blank.guid&&e.parent!=M.utils.blank.guid?1:e.name<t.name?-1:e.name>t.name?1:0}),e.map(function(e){return{ref:e.ref,parent:e.parent,presentation:e.name}})}).then(M.iface.data_to_tree)}},save_attachment:{value:function(e,t,n,r){r||(r={type:"text/plain"}),n instanceof Blob||r.indexOf("text")!=-1||(n=new Blob([n],{type:r}));var a,i=this.pouch_db;return e=this.class_name+"|"+M.utils.fix_guid(e),i.get(e).then(function(e){e&&(a=e._rev)}).catch(function(e){if(404!=e.status)throw e}).then(function(){return i.putAttachment(e,t,a,n,r)})}},get_attachment:{value:function(e,t){return this.pouch_db.getAttachment(this.class_name+"|"+M.utils.fix_guid(e),t)}},delete_attachment:{value:function(e,t){var n,r=this.pouch_db;return e=this.class_name+"|"+M.utils.fix_guid(e),r.get(e).then(function(e){e&&(n=e._rev)}).catch(function(e){if(404!=e.status)throw e}).then(function(){return r.removeAttachment(e,t,n)})}}}),k.prototype.__define({new_number_doc:{value:function(){var e=this,t=(M.current_acl&&M.current_acl.prefix||"")+(e.organization&&e.organization.prefix?e.organization.prefix:M.wsql.get_user_param("zone")+"-"),n=e._metadata.code_length-t.length,r="";return e._manager.pouch_db.query("doc/number_doc",{limit:1,include_docs:!1,startkey:[e._manager.class_name,t+"￿"],endkey:[e._manager.class_name,t],descending:!0}).then(function(a){if(a.rows.length){for(var i=a.rows[0].key[1],o=i.length-1;o>0&&!isNaN(parseInt(i[o]));o--)r=i[o]+r;r=(parseInt(r||0)+1).toFixed(0)}else r="1";for(;r.length<n;)r="0"+r;return e.number_doc=t+r,e})}}}),"undefined"!=typeof module&&module.exports&&(module.exports=T),M});